<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurateur Offres (V1) ‚Äî Prototype</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef8;
      --accent:#ff6a00; --accent2:#ff8a3d; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background: radial-gradient(1200px 800px at 15% 10%, rgba(255,106,0,.18), transparent 55%), radial-gradient(900px 600px at 85% 15%, rgba(45,212,191,.10), transparent 50%), var(--bg); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1050px; margin:0 auto; padding:20px}
    .top{display:flex; gap:14px; align-items:center; justify-content:space-between; margin:10px 0 18px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: var(--shadow)}
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px; margin-top:2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border:1px solid var(--border); background: rgba(255,255,255,.03); border-radius:999px; color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:var(--r); box-shadow: var(--shadow)}
    .card .hd{padding:16px 16px 0}
    .card .bd{padding:16px}
    .h1{font-size:18px; font-weight:800; margin:0}
    .h2{font-size:14px; font-weight:750; margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .sp{height:10px}
    .stepper{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .dot{width:34px; height:34px; border-radius:12px; display:grid; place-items:center; font-size:13px; border:1px solid var(--border); background: rgba(255,255,255,.03); color:var(--muted); touch-action:manipulation; -webkit-tap-highlight-color: transparent}
    .dot.active{background: rgba(255,106,0,.16); color: #ffe6d6; border-color: rgba(255,106,0,.35)}
    .dot.done{background: rgba(45,212,191,.12); color: #d7fff7; border-color: rgba(45,212,191,.35)}
    .line{flex:1; min-width:24px; height:1px; background: var(--border)}

    .q{margin:12px 0}
    .q label{display:block; font-size:13px; color:var(--muted); margin:0 0 8px}

    .seg{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 780px){ .seg{grid-template-columns:1fr 1fr} }
    .seg2{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}

    .opt{position:relative; padding:12px; border-radius:14px; border:1px solid var(--border); background: rgba(255,255,255,.03); cursor:pointer; user-select:none; min-height:54px; touch-action:manipulation; -webkit-tap-highlight-color: transparent}
    .opt:hover{border-color: rgba(255,255,255,.18)}
    .opt .t{font-weight:750; font-size:14px}
    .opt .s{color:var(--muted); font-size:12px; margin-top:4px}
    .opt.selected{outline: 2px solid rgba(255,106,0,.35); border-color: rgba(255,106,0,.35); background: rgba(255,106,0,.08)}

    .checklist{display:grid; gap:10px}
    .chk{display:flex; gap:10px; align-items:flex-start; padding:12px; border:1px solid var(--border); background: rgba(255,255,255,.03); border-radius:14px; cursor:pointer; touch-action:manipulation; -webkit-tap-highlight-color: transparent}
    .box{width:18px; height:18px; border-radius:6px; border:1px solid var(--border); margin-top:2px; display:grid; place-items:center}
    .chk.selected .box{background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.35)}
    .chk .main{font-weight:750; font-size:14px}
    .chk .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .btnbar{display:flex; gap:10px; justify-content:space-between; margin-top:14px}
    .btn{padding:11px 14px; border-radius:14px; border:1px solid var(--border); background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-weight:750; touch-action:manipulation; -webkit-tap-highlight-color: transparent}
    .btn:hover{border-color: rgba(255,255,255,.18)}
    .btn.primary{background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95)); border-color: transparent; color:#130a05}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .side{display:grid; gap:16px}
    .kpi{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .tile{padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)}
    .tile .v{font-size:18px; font-weight:850}
    .tile .l{color:var(--muted); font-size:12px; margin-top:4px}

    .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); font-size:13px; color:var(--muted)}
    .badge b{color:var(--text)}
    .tag{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)}

    .rec{padding:14px; border-radius:18px; border:1px solid rgba(255,106,0,.35); background: rgba(255,106,0,.08)}
    .rec .big{font-size:16px; font-weight:900}
    .rec .price{font-weight:900; color:#ffe3d2}
    .list{margin:10px 0 0; padding-left:18px; color:var(--muted)}
    .list li{margin:4px 0}

    .seller{padding:14px; border-radius:18px; border:1px solid rgba(45,212,191,.35); background: rgba(45,212,191,.08)}
    .seller .big{font-size:14px; font-weight:900}

    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-size:12px; color:var(--muted)}

    /* Print */
    @media print{
      body{background:white; color:#111}
      .wrap{max-width:none}
      .card{box-shadow:none}
      .btnbar, .top .pill, .side .tile, #shareRow{display:none !important}
      .grid{grid-template-columns:1fr}
      .rec, .seller{border-color:#ddd; background:#fff}
      .muted, .list, .mono{color:#444}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Configurateur Offres ‚Äî Prototype V1</div>
          <div class="subtitle">Diagnostic usages (Wi‚ÄëFi / Internet / Mobile / S√©curit√©) ‚Üí recommandation + scripts vendeur</div>
        </div>
      </div>
      <div class="pill" title="V1: sans donn√©es personnelles, utilisable sur tablette">
        <span>üü†</span> <span>V1 ‚Ä¢ 5 √©crans ‚Ä¢ sans RGPD lourd</span>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <div class="hd">
          <div class="stepper" id="stepper"></div>
          <div class="sp"></div>
          <div class="h1" id="screenTitle">‚Äî</div>
          <div class="muted" id="screenHint" style="margin-top:6px">‚Äî</div>
        </div>
        <div class="bd" id="screen"></div>
      </div>

      <!-- Side -->
      <div class="side">
        <div class="card">
          <div class="bd">
            <div class="h2">Pr√©visualisation (temps r√©el)</div>
            <div class="kpi">
              <div class="tile"><div class="v" id="kpiWifi">‚Äî</div><div class="l">Difficult√© Wi‚ÄëFi</div></div>
              <div class="tile"><div class="v" id="kpiRep">‚Äî</div><div class="l">R√©p√©teurs recommand√©s</div></div>
              <div class="tile"><div class="v" id="kpiIntensity">‚Äî</div><div class="l">Intensit√© Internet</div></div>
              <div class="tile"><div class="v" id="kpiMobile">‚Äî</div><div class="l">Profil Mobile</div></div>
            </div>
            <div class="sp"></div>
            <div class="row" id="tags"></div>
          </div>
        </div>

        <div class="card">
          <div class="bd">
            <div class="h2">Actions</div>
            <div class="row" style="margin-bottom:10px">
              <button class="btn" id="btnModeClient">Mode client</button>
              <button class="btn" id="btnModeVendeur">Mode vendeur</button>
            </div>
            <div class="row" id="shareRow" style="margin-bottom:10px"></div>
            <div class="row">
              <button class="btn" id="btnReset">R√©initialiser</button>
              <button class="btn" id="btnPrint">Imprimer / PDF</button>
            </div>
            <div class="sp"></div>
            <div class="mono" id="stateDebug"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===========================
  // Configurateur Offres ‚Äî Prototype V1
  // 1 fichier, sans d√©pendance
  // ===========================

  // ---------------------------
  // Donn√©es (V1) ‚Äî prix "indicatifs" sauf remises Open (VALID√âES PAR TOI)
  // ---------------------------
  const OFFERS = {
    internet: [
      {
        id: 'lite',
        name: 'S√©rie Sp√©ciale Livebox Lite Fibre',
        tier: 1,
        commitmentMonths: 12,
        price: { intro: 29.99, after: null, promoNote: null },
        includes: ['Livebox 5 (Wi‚ÄëFi 5)', 'TV (200 cha√Ænes) + D√©codeur UHD'],
        hint: 'Simple, efficace ‚Äî TV incluse.'
      },
      {
        id: 'livebox',
        name: 'Livebox Fibre',
        tier: 2,
        commitmentMonths: 12,
        price: { intro: 29.99, after: 42.99, promoNote: '29,99‚Ç¨/mois pendant 12 mois puis 42,99‚Ç¨/mois' },
        includes: ['Livebox S (Wi‚ÄëFi 7)', 'TV (200 cha√Ænes) + D√©codeur TV 6'],
        hint: 'Base solide Wi‚ÄëFi 7.'
      },
      {
        id: 'up',
        name: 'Livebox Up Fibre',
        tier: 3,
        commitmentMonths: 12,
        price: { intro: 39.99, after: 51.99, promoNote: '39,99‚Ç¨/mois pendant 12 mois puis 51,99‚Ç¨/mois' },
        includes: ['Livebox 7 (Wi‚ÄëFi 7)', 'TV (200 cha√Ænes) + D√©codeur TV 6', '1 r√©p√©teur Wi‚ÄëFi'],
        hint: 'Stabilit√© + usages intensifs.'
      },
      {
        id: 'max',
        name: 'Livebox Max Fibre',
        tier: 4,
        commitmentMonths: 12,
        price: { intro: 47.99, after: 57.99, promoNote: '47,99‚Ç¨/mois pendant 12 mois puis 57,99‚Ç¨/mois' },
        includes: ['Livebox 7 (Wi‚ÄëFi 7)', 'TV (200 cha√Ænes) + 2 D√©codeurs TV 6', 'Jusqu\'√† 3 r√©p√©teurs Wi‚ÄëFi'],
        hint: 'Couverture + confort total.'
      },
    ],

    mobileProfiles: [
      { id: 'essentiel', name: 'Essentiel', desc: 'Usage ma√Ætris√©, Wi‚ÄëFi fr√©quent' },
      { id: 'confort', name: 'Confort', desc: 'Libert√© + hotspot + vid√©o sans y penser' },
      { id: 'serenite', name: 'S√©r√©nit√©', desc: 'Aucune contrainte, z√©ro stress data' },
    ],

    // Remises Open: VALID√âES PAR TOI
    mobileOffers: [
      {
        id: 'm2h',
        name: 'Forfait 2h / 100 Mo',
        commitmentMonths: 0,
        price: { intro: 8.99, after: null, promoNote: 'Sans engagement (prix indicatif)' },
        openDiscount: 3,
        highlights: ['Appels 2h', 'SMS/MMS illimit√©s', '100 Mo']
      },
      {
        id: 'm20',
        name: 'S√©rie Sp√©ciale 20Go',
        commitmentMonths: 0,
        price: { intro: 17.99, after: null, promoNote: 'Sans engagement' },
        openDiscount: 7,
        highlights: ['Appels/SMS/MMS illimit√©s', '20Go en France (d√©bit r√©duit au-del√†)']
      },
      {
        id: 'm120',
        name: 'S√©rie Sp√©ciale 120Go 5G',
        commitmentMonths: 0,
        price: { intro: 24.99, after: null, promoNote: 'Promo possible (codes / p√©riodes)' },
        openDiscount: 5,
        highlights: ['Appels/SMS/MMS illimit√©s', '120Go 5G (selon conditions)']
      },
      {
        id: 'm200',
        name: 'Forfait 200Go 5G',
        commitmentMonths: 24,
        price: { intro: 37.99, after: 47.99, promoNote: 'Engagement 24 mois (prix indicatif)' },
        openDiscount: 8,
        highlights: ['Appels/SMS/MMS illimit√©s', '200Go 5G (selon conditions)']
      },
      {
        id: 'm300',
        name: 'Forfait 300Go 5G',
        commitmentMonths: 24,
        price: { intro: 44.99, after: 54.99, promoNote: 'Engagement 24 mois (prix indicatif)' },
        openDiscount: 15,
        highlights: ['Gros usages', 'Partage de connexion intensif', 'Famille']
      },
      {
        id: 'm500',
        name: 'Forfait 500Go 5G+',
        commitmentMonths: 24,
        price: { intro: 59.99, after: 69.99, promoNote: 'Engagement 24 mois (prix indicatif)' },
        openDiscount: 15,
        highlights: ['Premium', 'Multi‚Äëappareils', 'Tr√®s gros usages']
      },
    ],

    options: [
      { id: 'maison_protegee', name: 'Maison Prot√©g√©e', when: 'Maison / absences / RDC', script: 'Absences + maison ‚Üí tranquillit√© d\'esprit (dissuasion + intervention).' },
      { id: 'cybersecure', name: 'Cybersecure', when: 'Enfants / t√©l√©travail / PC pro', script: 'Ce n\'est pas technique : c\'est prot√©ger la famille et les appareils.' },
      { id: 'multisim', name: 'Multi‚ÄëSIM', when: 'Montre / tablette / voiture / hotspot', script: 'M√™me forfait, plusieurs appareils : montre, tablette, voiture.' },
    ]
  };

  // ---------------------------
  // State
  // ---------------------------
  const DEFAULT_STATE = {
    step: 0,
    mode: 'client', // 'client' | 'vendeur'
    hasBox: true,  // Box Orange (d√©j√† ou en souscription) ‚Üí active remise Open
    housing: { surface: null, type: null, floors: null, walls: null, boxPlacement: null },
    internetUsage: [],
    mobileContext: [],
    security: [],
    devices: [],
  };

  let state = null;

  const STEPS = [
    { key: 'housing', title: 'Logement & Wi‚ÄëFi', hint: 'On dimensionne la couverture r√©elle : surface, √©tages, murs. (√áa √©vite les retours.)' },
    { key: 'internet', title: 'Usages Internet', hint: 'On identifie l\'intensit√© : t√©l√©travail, gaming, streaming, famille.' },
    { key: 'mobile', title: 'Mobile (sans parler de Go)', hint: 'On vend du confort : ne plus surveiller, pouvoir partager, g√©rer l\'impr√©vu.' },
    { key: 'security', title: 'S√©curit√© & S√©r√©nit√©', hint: 'D√©clencheurs simples : absences, enfants, appareils sensibles.' },
    { key: 'result', title: 'R√©sultat', hint: 'Recommandation + justification client + scripts vendeur.' },
  ];

  // ---------------------------
  // DOM helpers
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  function safe(id){
    const el = $(id);
    if (!el) throw new Error(`√âl√©ment introuvable: #${id}`);
    return el;
  }

  // ---------------------------
  // Engine
  // ---------------------------
  function wifiDifficultyScore(h){
    if (h.surface == null) return 0;
    let score = 0;
    const s = Number(h.surface);
    if (s >= 50) score += 1;
    if (s > 90) score += 1;
    if (s > 130) score += 1;

    const f = Number(h.floors ?? 0);
    if (f >= 1) score += 1;
    if (f >= 2) score += 1;

    if (h.walls === 'beton') score += 1;

    if (h.boxPlacement === 'excentre') score += 1;
    if (h.boxPlacement === 'garage') score += 2;

    return Math.min(score, 8);
  }

  function recommendedRepeaters(h){
    let rep = 0;
    const s = Number(h.surface ?? 0);
    const f = Number(h.floors ?? 0);
    if (s > 90) rep += 1;
    if (f >= 1) rep += 1;
    if (h.walls === 'beton') rep += 1;
    if (h.boxPlacement === 'garage') rep += 1;
    return Math.max(0, Math.min(rep, 3));
  }

  function internetIntensity(usages){
    const u = new Set(usages);
    let points = 0;
    if (u.has('teletravail')) points += 2;
    if (u.has('gaming')) points += 2;
    if (u.has('streaming')) points += 2;
    if (u.has('famille')) points += 2;
    if (u.has('iot')) points += 1;
    if (points <= 2) return 'Faible';
    if (points <= 5) return 'Moyen';
    return '√âlev√©';
  }

  function mobileProfile(ctx){
    const c = new Set(ctx);
    let p = 0;
    if (c.has('gps')) p += 1;
    if (c.has('video')) p += 2;
    if (c.has('hotspot')) p += 2;
    if (c.has('wifi_unstable')) p += 2;
    if (c.has('zero_stress')) p += 3;

    if (p <= 2) return 'essentiel';
    if (p <= 6) return 'confort';
    return 'serenite';
  }

  function recommendBox(){
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const u = new Set(state.internetUsage);

    let tier = 2;
    if (intensity === 'Moyen' || intensity === '√âlev√©') tier = 3;

    const heavy = (u.has('teletravail') && u.has('gaming')) || (u.has('teletravail') && u.has('streaming') && u.has('famille'));
    if (heavy) tier = 3;

    if (rep >= 2) tier = 4;

    const s = Number(state.housing.surface ?? 0);
    if (tier === 2 && intensity === 'Faible' && s > 0 && s < 50 && rep === 0) {
      return { primary: 'livebox', alternative: 'lite' };
    }
    return { primary: tier === 4 ? 'max' : 'up', alternative: tier === 4 ? 'up' : 'livebox' };
  }

  function recommendOptions(){
    const opts = [];
    const sec = new Set(state.security);
    const dev = new Set(state.devices);
    const u = new Set(state.internetUsage);

    if (sec.has('absences') || sec.has('rdc') || state.housing.type === 'maison') opts.push('maison_protegee');
    if (sec.has('enfants') || sec.has('pc_pro') || u.has('teletravail')) opts.push('cybersecure');
    if (dev.has('watch') || dev.has('tablet') || dev.has('car') || new Set(state.mobileContext).has('hotspot')) opts.push('multisim');

    return [...new Set(opts)];
  }

  function buildResult(){
    const wifiScore = wifiDifficultyScore(state.housing);
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const mp = mobileProfile(state.mobileContext);
    const { primary, alternative } = recommendBox();
    const options = recommendOptions();

    const reasons = [];
    const s = Number(state.housing.surface ?? 0);
    const f = Number(state.housing.floors ?? 0);
    if (s > 90) reasons.push('Surface > 90 m¬≤ ‚Üí couverture Wi‚ÄëFi √† renforcer');
    if (f >= 1) reasons.push('Pr√©sence d\'√©tage ‚Üí Wi‚ÄëFi √† s√©curiser');
    if (state.housing.walls === 'beton') reasons.push('Murs b√©ton/pierre ‚Üí att√©nuation importante');
    if (state.housing.boxPlacement === 'garage') reasons.push('Box en local technique/garage ‚Üí propagation compliqu√©e');

    const u = new Set(state.internetUsage);
    if (u.has('teletravail')) reasons.push('T√©l√©travail/visio ‚Üí stabilit√© et upload');
    if (u.has('gaming')) reasons.push('Gaming en ligne ‚Üí stabilit√© + latence');
    if (u.has('streaming')) reasons.push('Streaming vid√©o ‚Üí d√©bit constant');
    if (u.has('famille')) reasons.push('Plusieurs utilisateurs ‚Üí capacit√© et Wi‚ÄëFi');

    const sellerAlerts = [];
    if (rep >= 1 && (primary === 'livebox' || primary === 'lite')) sellerAlerts.push('‚ö†Ô∏è Risque Wi‚ÄëFi : pr√©voir r√©p√©teur(s) ou monter en gamme (Up/Max).');
    if (u.has('teletravail')) sellerAlerts.push('üí° Script : ¬´ En visio, c\'est la stabilit√© qui fait la diff√©rence. ¬ª');
    if (mp !== 'essentiel') sellerAlerts.push('üí° Script : ¬´ Ce forfait n\'est pas pour consommer plus, c\'est pour ne jamais faire attention. ¬ª');

    return { wifiScore, rep, intensity, mobileProfile: mp, primaryBox: primary, altBox: alternative, options, reasons, sellerAlerts };
  }

  // ---------------------------
  // UI helpers
  // ---------------------------
  function scoreLabel(score){
    if (score <= 1) return 'Facile';
    if (score <= 3) return 'Moyen';
    if (score <= 5) return 'Difficile';
    return 'Tr√®s difficile';
  }

  function labelInternet(v){
    return ({teletravail:'T√©l√©travail', gaming:'Gaming', streaming:'Streaming', famille:'Famille', iot:'Objets connect√©s'})[v] || v;
  }
  function labelMobile(v){
    return ({gps:'GPS', video:'Vid√©os', hotspot:'Hotspot', wifi_unstable:'Wi‚ÄëFi instable', zero_stress:'Tranquillit√©'})[v] || v;
  }
  function labelSec(v){
    return ({absences:'Absences', rdc:'RDC', enfants:'Enfants', pc_pro:'PC pro'})[v] || v;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
  }

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.padding='10px 12px';
    t.style.border='1px solid rgba(255,255,255,.14)';
    t.style.borderRadius='999px';
    t.style.background='rgba(17,24,38,.92)';
    t.style.color='var(--text)';
    t.style.boxShadow='var(--shadow)';
    t.style.zIndex='9999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, 1400);
    setTimeout(()=>t.remove(), 1800);
  }

  function priceLine(o){
    if (!o?.price) return '‚Äî';
    const euro = (n) => `${Number(n).toFixed(2).replace('.', ',')}‚Ç¨`;
    if (o.price.after == null) return `${euro(o.price.intro)}/mois`;
    return `${euro(o.price.intro)}/mois (12 mois) puis ${euro(o.price.after)}/mois`;
  }

  function mobilePriceWithOpen(offer){
    if (!offer?.price) return { std: NaN, open: NaN, discount: 0 };
    const std = Number(offer.price.intro);
    const d = Number(offer.openDiscount ?? 0);
    const open = Math.max(std - (state.hasBox ? d : 0), 0);
    return { std, open, discount: state.hasBox ? d : 0 };
  }

  function euro(n){
    return `${Number(n).toFixed(2).replace('.', ',')}‚Ç¨`;
  }

  // ---------------------------
  // Local/URL state
  // ---------------------------
  function buildShareURL(){
    const compact = {
      s: state.step,
      m: state.mode,
      bx: state.hasBox,
      h: state.housing,
      iu: state.internetUsage,
      mc: state.mobileContext,
      se: state.security,
      d: state.devices,
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
    const u = new URL(window.location.href);
    u.searchParams.set('cfg', payload);
    return u.toString();
  }

  function loadFromURL(){
    try{
      const u = new URL(window.location.href);
      const cfg = u.searchParams.get('cfg');
      if (!cfg) return null;
      const json = decodeURIComponent(escape(atob(cfg)));
      const obj = JSON.parse(json);
      const st = structuredClone(DEFAULT_STATE);
      st.step = Number(obj.s ?? 0);
      st.mode = (obj.m === 'vendeur') ? 'vendeur' : 'client';
      st.hasBox = (obj.bx === false) ? false : true;
      st.housing = obj.h || st.housing;
      st.internetUsage = obj.iu || [];
      st.mobileContext = obj.mc || [];
      st.security = obj.se || [];
      st.devices = obj.d || [];
      return st;
    } catch { return null; }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('cfg_v1_state');
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function persist(){
    localStorage.setItem('cfg_v1_state', JSON.stringify(state));
    window.history.replaceState({}, '', buildShareURL());
  }

  // ---------------------------
  // UI components
  // ---------------------------
  function badge(text){
    const div = document.createElement('span');
    div.className = 'tag';
    div.textContent = text;
    return div;
  }

  function setSeg(containerId, options, selectedValue, onChange){
    const container = safe(containerId);
    container.innerHTML = '';
    options.forEach(opt => {
      const div = document.createElement('div');
      div.className = 'opt' + (selectedValue === opt.value ? ' selected' : '');
      div.innerHTML = `<div class="t">${opt.label}</div><div class="s">${opt.hint||''}</div>`;

      const handler = (e) => {
        e?.preventDefault?.();
        e?.stopPropagation?.();
        onChange(opt.value);
      };

      div.addEventListener('click', handler);
      div.addEventListener('touchend', handler, { passive: false });

      container.appendChild(div);
    });
  }

  function setChecks(containerId, items, selectedSet, onToggle){
    const container = safe(containerId);
    container.innerHTML = '';
    items.forEach(it => {
      const selected = selectedSet.has(it.value);
      const div = document.createElement('div');
      div.className = 'chk' + (selected ? ' selected' : '');
      div.innerHTML = `
        <div class="box">${selected ? '‚úì' : ''}</div>
        <div>
          <div class="main">${it.label}</div>
          <div class="sub">${it.hint || ''}</div>
        </div>
      `;

      const handler = (e) => {
        e?.preventDefault?.();
        e?.stopPropagation?.();
        onToggle(it.value);
      };

      div.addEventListener('click', handler);
      div.addEventListener('touchend', handler, { passive: false });

      container.appendChild(div);
    });
  }

  function renderStepper(){
    const el = safe('stepper');
    el.innerHTML = '';
    STEPS.forEach((s, i) => {
      const dot = document.createElement('div');
      dot.className = 'dot' + (i === state.step ? ' active' : (i < state.step ? ' done' : ''));
      dot.textContent = (i+1);
      dot.title = s.title;
      dot.onclick = () => { state.step = i; persist(); render(); };
      el.appendChild(dot);
      if (i < STEPS.length-1) {
        const line = document.createElement('div');
        line.className = 'line';
        el.appendChild(line);
      }
    });
  }

  function navButtons(nextLabel='Suivant'){
    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev" ${state.step===0?'disabled':''}>Retour</button>
      <button class="btn primary" id="btnNext">${nextLabel}</button>
    `;
    setTimeout(()=>{
      safe('btnPrev').onclick = () => { state.step = Math.max(0, state.step-1); persist(); render(); };
      safe('btnNext').onclick = () => { state.step = Math.min(STEPS.length-1, state.step+1); persist(); render(); };
    });
    return nav;
  }

  // ---------------------------
  // Screens
  // ---------------------------
  function renderHousing(root){
    root.innerHTML = '';

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Surface du logement</label><div class="seg" id="segSurface"></div></div>`);
    setSeg('segSurface', [
      { value: 40, label: '< 50 m¬≤', hint: 'Wi‚ÄëFi souvent simple' },
      { value: 70, label: '50‚Äì90 m¬≤', hint: '√Ä surveiller selon murs' },
      { value: 110, label: '90‚Äì130 m¬≤', hint: 'R√©p√©teur souvent utile' },
      { value: 150, label: '+ 130 m¬≤', hint: 'Couverture √† s√©curiser' },
    ], state.housing.surface, (v)=>{ state.housing.surface=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Type de logement</label><div class="seg2" id="segType"></div></div>`);
    setSeg('segType', [
      { value: 'appart', label: 'Appartement', hint: '' },
      { value: 'maison', label: 'Maison', hint: '' },
    ], state.housing.type, (v)=>{ state.housing.type=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>√âtages</label><div class="seg" id="segFloors"></div></div>`);
    setSeg('segFloors', [
      { value: 0, label: '0', hint: 'Plain pied / m√™me niveau' },
      { value: 1, label: '1', hint: 'Wi‚ÄëFi √† l\'√©tage' },
      { value: 2, label: '2+', hint: 'Couverture plus difficile' },
      { value: 3, label: '3+', hint: 'Cas exigeant' },
    ], state.housing.floors, (v)=>{ state.housing.floors=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Murs majoritaires</label><div class="seg2" id="segWalls"></div></div>`);
    setSeg('segWalls', [
      { value: 'placo', label: 'Placopl√¢tre', hint: 'Diffusion OK' },
      { value: 'beton', label: 'B√©ton / pierre', hint: 'Att√©nuation forte' },
    ], state.housing.walls, (v)=>{ state.housing.walls=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Emplacement probable de la box</label><div class="seg" id="segPlace"></div></div>`);
    setSeg('segPlace', [
      { value: 'central', label: 'Central', hint: 'Meilleur sc√©nario' },
      { value: 'excentre', label: 'Excentr√©', hint: 'Couverture √† surveiller' },
      { value: 'garage', label: 'Garage / local', hint: 'Propagation difficile' },
      { value: 'inconnu', label: 'Je ne sais pas', hint: '' },
    ], state.housing.boxPlacement, (v)=>{ state.housing.boxPlacement=v; persist(); render(); });

    root.appendChild(navButtons());
  }

  function renderInternet(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Usages Internet (plusieurs choix)</label><div class="checklist" id="chkInternet"></div></div>`);
    const selected = new Set(state.internetUsage);
    setChecks('chkInternet', [
      { value: 'teletravail', label: 'T√©l√©travail / visio', hint: 'Stabilit√© + upload' },
      { value: 'gaming', label: 'Gaming en ligne', hint: 'Latence + stabilit√©' },
      { value: 'streaming', label: 'Streaming vid√©o / TV 4K', hint: 'D√©bit constant' },
      { value: 'famille', label: 'Famille (3+ utilisateurs)', hint: 'Capacit√© + Wi‚ÄëFi' },
      { value: 'iot', label: 'Objets connect√©s / cam√©ras', hint: 'R√©seau toujours dispo' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.internetUsage = [...selected];
      persist(); render();
    });
    root.appendChild(navButtons());
  }

  function renderMobile(root){
    root.innerHTML = '';

    // Toggle Open
    const openCard = document.createElement('div');
    openCard.className = 'card';
    openCard.innerHTML = `
      <div class="bd">
        <div class="h2">Avantage Open</div>
        <div class="muted">Active la remise Open si le client a une box Orange (d√©j√† ou en souscription).</div>
        <div class="sp"></div>
        <button class="btn ${state.hasBox ? 'primary' : ''}" id="btnHasBox">${state.hasBox ? '‚úÖ Box Orange : OUI (Open actif)' : '‚¨ú Box Orange : NON (Open inactif)'}</button>
      </div>
    `;
    root.appendChild(openCard);
    setTimeout(()=>{
      safe('btnHasBox').onclick = () => { state.hasBox = !state.hasBox; persist(); render(); };
    });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Hors Wi‚ÄëFi, qu\'est-ce qui vous arrive souvent ?</label><div class="checklist" id="chkMobile"></div></div>`);
    const selected = new Set(state.mobileContext);
    setChecks('chkMobile', [
      { value: 'gps', label: 'GPS / voiture', hint: 'Trafic temps r√©el + itin√©raires' },
      { value: 'video', label: 'Vid√©os / r√©seaux sociaux', hint: 'Vid√©o auto ‚Üí conso invisible' },
      { value: 'hotspot', label: 'Partage de connexion', hint: 'PC / tablette ‚Üí √ßa monte vite' },
      { value: 'wifi_unstable', label: 'Wi‚ÄëFi parfois indisponible', hint: 'Impr√©vus / d√©placements' },
      { value: 'zero_stress', label: 'Je veux √™tre tranquille', hint: 'Z√©ro surveillance' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.mobileContext = [...selected];
      persist(); render();
    });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Appareils concern√©s</label><div class="checklist" id="chkDevices"></div></div>`);
    const dev = new Set(state.devices);
    setChecks('chkDevices', [
      { value: 'watch', label: 'Montre connect√©e (eSIM)', hint: 'Multi‚ÄëSIM pertinente' },
      { value: 'tablet', label: 'Tablette', hint: 'Multi‚ÄëSIM / data d√©di√©e' },
      { value: 'car', label: 'Voiture / routeur', hint: 'Connexion embarqu√©e' },
    ], dev, (v)=>{
      if (dev.has(v)) dev.delete(v); else dev.add(v);
      state.devices = [...dev];
      persist(); render();
    });

    root.appendChild(navButtons());
  }

  function renderSecurity(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Contexte s√©curit√© (plusieurs choix)</label><div class="checklist" id="chkSec"></div></div>`);
    const selected = new Set(state.security);
    setChecks('chkSec', [
      { value: 'absences', label: 'Absences fr√©quentes', hint: 'Travail, vacances, d√©placements' },
      { value: 'rdc', label: 'RDC / acc√®s facile', hint: 'Risque per√ßu plus √©lev√©' },
      { value: 'enfants', label: 'Enfants / ados connect√©s', hint: 'Protection + contr√¥le' },
      { value: 'pc_pro', label: 'Appareils sensibles (PC pro, t√©l√©travail)', hint: 'S√©curiser l\'usage' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.security = [...selected];
      persist(); render();
    });

    root.appendChild(navButtons('Voir le r√©sultat'));
  }

  function renderResult(root){
    const res = buildResult();
    const primary = OFFERS.internet.find(o => o.id === res.primaryBox);
    const alt = OFFERS.internet.find(o => o.id === res.altBox);
    const mp = OFFERS.mobileProfiles.find(p => p.id === res.mobileProfile);

    // Mapping V1 profil ‚Üí forfait
    const mobileOfferId = (res.mobileProfile === 'essentiel') ? 'm20' : (res.mobileProfile === 'confort' ? 'm120' : 'm200');
    const mOffer = OFFERS.mobileOffers.find(m => m.id === mobileOfferId);

    const opts = res.options.map(id => OFFERS.options.find(o => o.id === id)).filter(Boolean);

    root.innerHTML = '';

    // Reco internet + comparatif
    const rec = document.createElement('div');
    rec.className = 'rec';
    rec.innerHTML = `
      <div class="big">Offre internet conseill√©e</div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap">
        <div>
          <div class="big" style="font-size:18px">${escapeHtml(primary.name)}</div>
          <div class="muted" style="margin-top:4px">${escapeHtml(primary.hint)}</div>
        </div>
        <div class="price">${priceLine(primary)} ‚Ä¢ R√©p√©teurs: ${res.rep}</div>
      </div>

      <div style="margin-top:10px; padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)">
        <div class="h2" style="margin:0 0 8px">Comparatif rapide (avant / apr√®s)</div>
        <div class="muted" style="margin-bottom:8px">Alternative vs recommandation ‚Äî pour expliquer le ‚Äúpourquoi‚Äù sans jargon.</div>
        <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead>
              <tr>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)"> </th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(alt.name)}</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(primary.name)}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Prix</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">${priceLine(alt)}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">${priceLine(primary)}</td>
              </tr>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Wi‚ÄëFi</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">OK si logement simple</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">Dimensionn√© au logement</td>
              </tr>
              <tr>
                <td style="padding:10px; color:var(--muted)">R√©p√©teurs</td>
                <td style="padding:10px">‚Äî</td>
                <td style="padding:10px">${res.rep}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ul class="list">${res.reasons.slice(0,6).map(r=>`<li>${escapeHtml(r)}</li>`).join('')}</ul>

      <div class="row" style="margin-top:10px">
        ${primary.includes.map(x=>`<span class="badge"><b>Inclus</b> ${escapeHtml(x)}</span>`).join('')}
      </div>

      <div class="sp"></div>
      <div class="muted">Alternative (si budget serr√© / usage plus simple) :</div>
      <div style="margin-top:6px"><span class="badge"><b>${escapeHtml(alt.name)}</b> ‚Äî ${escapeHtml(alt.hint)} ‚Ä¢ ${priceLine(alt)}</span></div>
    `;
    root.appendChild(rec);

    // Mobile
    const mob = document.createElement('div');
    mob.className = 'card';
    mob.style.marginTop = '12px';

    let priceBadge = '<div class="badge"><b>Forfait conseill√©</b> ‚Ä¢ ‚Äî</div>';
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> ‚Ä¢ <span style="text-decoration:line-through; opacity:.7">${euro(p.std)}/mois</span> <b style="color:#ffe3d2">${euro(p.open)}/mois</b> <span class="muted">(Open ‚àí${p.discount}‚Ç¨/mois)</span></div>`;
      } else {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> ‚Ä¢ ${euro(p.std)}/mois</div>`;
      }
    }

    mob.innerHTML = `
      <div class="bd">
        <div class="h2">Mobile recommand√© (positionnement)</div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="badge"><b>${escapeHtml(mp.name)}</b> ‚Äî ${escapeHtml(mp.desc)}</div>
          ${priceBadge}
        </div>
        <ul class="list">
          <li>¬´ Ce forfait n'est pas pour consommer plus, c'est pour ne jamais faire attention. ¬ª</li>
          <li>¬´ Quand le Wi‚ÄëFi n'est pas l√†, vous √™tes tranquille : GPS, vid√©o, hotspot. ¬ª</li>
        </ul>
        ${mOffer?.price?.promoNote ? `<div class="muted" style="margin-top:8px">Note : ${escapeHtml(mOffer.price.promoNote)}</div>` : ''}
      </div>
    `;
    root.appendChild(mob);

    // Options
    const opt = document.createElement('div');
    opt.className = 'card';
    opt.style.marginTop = '12px';
    opt.innerHTML = `
      <div class="bd">
        <div class="h2">Options sugg√©r√©es</div>
        ${opts.length ? opts.map(o=>`<div class="badge" style="margin:6px 0"><b>${escapeHtml(o.name)}</b> ‚Äî ${escapeHtml(o.when)}</div>`).join('') : `<div class="muted">Aucune option d√©tect√©e comme prioritaire.</div>`}
        ${opts.length ? `<ul class="list">${opts.map(o=>`<li>${escapeHtml(o.script)}</li>`).join('')}</ul>` : ''}
      </div>
    `;
    root.appendChild(opt);

    // Mode vendeur
    if (state.mode === 'vendeur') {
      const seller = document.createElement('div');
      seller.className = 'seller';
      seller.style.marginTop = '12px';
      seller.innerHTML = `
        <div class="big">Mode vendeur</div>
        ${res.sellerAlerts.length ? `<ul class="list" style="color:#d7fff7">${res.sellerAlerts.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<div class="muted">Alerte : aucune.</div>`}
        <div class="sp"></div>
        <div class="muted">Phrase Wi‚ÄëFi : ¬´ Le Wi‚ÄëFi, ce n'est pas la box, c'est la maison. ¬ª</div>
      `;
      root.appendChild(seller);
    }

    // Nav
    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev">Retour</button>
      <button class="btn primary" id="btnCopy">Copier le r√©cap</button>
    `;
    root.appendChild(nav);

    setTimeout(()=>{
      safe('btnPrev').onclick = () => { state.step = Math.max(0, state.step-1); persist(); render(); };
      safe('btnCopy').onclick = () => {
        navigator.clipboard?.writeText(buildPlainTextRecap(res, primary, alt, mp, mOffer, opts));
        toast('R√©cap copi√© dans le presse-papier.');
      };
    });
  }

  function buildPlainTextRecap(res, primary, alt, mp, mOffer, opts){
    const lines = [];
    lines.push('R√âCAP CONFIGURATEUR (V1)');
    lines.push('‚Äî');
    lines.push(`Box Orange (Open): ${state.hasBox ? 'OUI' : 'NON'}`);
    lines.push(`Internet conseill√©: ${primary.name} (R√©p√©teurs: ${res.rep})`);
    lines.push(`Prix: ${priceLine(primary)}`);
    lines.push(`Alternative: ${alt.name} ‚Äî ${priceLine(alt)}`);
    lines.push(`Intensit√© internet: ${res.intensity}`);
    lines.push(`Profil mobile: ${mp.name} ‚Äî ${mp.desc}`);
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        lines.push(`Mobile conseill√©: ${mOffer.name} ‚Äî ${euro(p.open)}/mois (Open ‚àí${p.discount}‚Ç¨) [standard ${euro(p.std)}/mois]`);
      } else {
        lines.push(`Mobile conseill√©: ${mOffer.name} ‚Äî ${euro(p.std)}/mois`);
      }
    }
    lines.push('‚Äî');
    lines.push('Justifications:');
    res.reasons.forEach(r => lines.push(`- ${r}`));
    lines.push('‚Äî');
    lines.push(`Options sugg√©r√©es: ${opts.length ? opts.map(o=>o.name).join(', ') : 'Aucune'}`);
    if (opts.length) opts.forEach(o => lines.push(`- ${o.name}: ${o.script}`));
    lines.push('‚Äî');
    lines.push('Mode vendeur:');
    res.sellerAlerts.forEach(a => lines.push(`- ${a}`));
    lines.push('');
    return lines.join('
');
  }

  // ---------------------------
  // Sidebar & main render
  // ---------------------------
  function renderShare(){
    const row = safe('shareRow');
    row.innerHTML = '';

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Cr√©er un lien de partage';
    btn.onclick = () => {
      const url = buildShareURL();
      navigator.clipboard?.writeText(url);
      toast('Lien copi√©. Colle-le sur le mobile/tablette.');
    };

    const btn2 = document.createElement('button');
    btn2.className = 'btn ghost';
    btn2.textContent = 'Ouvrir le lien';
    btn2.onclick = () => window.open(buildShareURL(), '_blank');

    row.appendChild(btn);
    row.appendChild(btn2);
  }

  function render(){
    renderStepper();
    const step = STEPS[state.step];
    safe('screenTitle').textContent = step.title;
    safe('screenHint').textContent = step.hint;

    const root = safe('screen');
    if (step.key === 'housing') renderHousing(root);
    if (step.key === 'internet') renderInternet(root);
    if (step.key === 'mobile') renderMobile(root);
    if (step.key === 'security') renderSecurity(root);
    if (step.key === 'result') renderResult(root);

    const res = buildResult();
    safe('kpiWifi').textContent = scoreLabel(res.wifiScore);
    safe('kpiRep').textContent = String(res.rep);
    safe('kpiIntensity').textContent = res.intensity;
    const mp = OFFERS.mobileProfiles.find(p=>p.id===res.mobileProfile);
    safe('kpiMobile').textContent = mp ? mp.name : '‚Äî';

    const tags = safe('tags');
    tags.innerHTML = '';
    tags.appendChild(badge(state.hasBox ? 'Open: OUI' : 'Open: NON'));
    if (state.housing.surface) tags.appendChild(badge(`${state.housing.surface} m¬≤`));
    if (state.housing.type) tags.appendChild(badge(state.housing.type === 'maison' ? 'Maison' : 'Appartement'));
    if (state.housing.floors != null) tags.appendChild(badge(`${state.housing.floors} √©tage(s)`));
    if (state.housing.walls) tags.appendChild(badge(state.housing.walls === 'beton' ? 'Murs b√©ton/pierre' : 'Murs placo'));
    state.internetUsage.forEach(u=>tags.appendChild(badge(`Internet: ${labelInternet(u)}`)));
    state.mobileContext.forEach(c=>tags.appendChild(badge(`Mobile: ${labelMobile(c)}`)));
    state.security.forEach(s=>tags.appendChild(badge(`S√©curit√©: ${labelSec(s)}`)));

    safe('btnModeClient').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeur').classList.toggle('primary', state.mode === 'vendeur');

    renderShare();

    safe('stateDebug').textContent = `state: ${JSON.stringify(state)}`;
  }

  // ---------------------------
  // Init
  // ---------------------------
  function init(){
    state = loadFromURL() || loadLocal() || structuredClone(DEFAULT_STATE);

    safe('btnReset').onclick = () => { state = structuredClone(DEFAULT_STATE); persist(); render(); };
    safe('btnPrint').onclick = () => window.print();

    safe('btnModeClient').onclick = () => { state.mode = 'client'; persist(); render(); };
    safe('btnModeVendeur').onclick = () => { state.mode = 'vendeur'; persist(); render(); };

    render();
  }

  window.addEventListener('DOMContentLoaded', () => {
    try { init(); }
    catch (e) {
      console.error(e);
      alert('Erreur JS : ' + (e?.message || e));
    }
  });
</script>
</body>
</html>
