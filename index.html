<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurateur Offres (V1) â€” Prototype</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef8;
      --accent:#ff6a00; --accent2:#ff8a3d; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:
      radial-gradient(1200px 800px at 15% 10%, rgba(255,106,0,.18), transparent 55%),
      radial-gradient(900px 600px at 85% 15%, rgba(45,212,191,.10), transparent 50%),
      var(--bg);
      color:var(--text)
    }
    .wrap{max-width:1050px; margin:0 auto; padding:20px}
    .top{display:flex; gap:14px; align-items:center; justify-content:space-between; margin:10px 0 18px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: var(--shadow)}
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px; margin-top:2px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border:1px solid var(--border); background: rgba(255,255,255,.03); border-radius:999px; color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:var(--r); box-shadow: var(--shadow)}
    .card .hd{padding:16px 16px 0}
    .card .bd{padding:16px}
    .h1{font-size:18px; font-weight:800; margin:0}
    .h2{font-size:14px; font-weight:750; margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .sp{height:10px}
    .stepper{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .line{flex:1; min-width:24px; height:1px; background: var(--border)}

    .q{margin:12px 0}
    .q label{display:block; font-size:13px; color:var(--muted); margin:0 0 8px}

    .seg{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 780px){ .seg{grid-template-columns:1fr 1fr} }
    .seg2{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}

    /* IMPORTANT: tout cliquable = button (mobile/webview safe) */
    .opt{
      position:relative; padding:12px; border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); cursor:pointer; user-select:none; min-height:54px;
      width:100%; text-align:left; outline:none;
      appearance:none; -webkit-appearance:none;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      color:var(--text);
    }
    .opt:hover{border-color: rgba(255,255,255,.18)}
    .opt:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .opt .t{font-weight:750; font-size:14px}
    .opt .s{color:var(--muted); font-size:12px; margin-top:4px}
    .opt.selected{outline: 2px solid rgba(255,106,0,.35); border-color: rgba(255,106,0,.35); background: rgba(255,106,0,.08)}

    .checklist{display:grid; gap:10px}
    .chk{
      display:flex; gap:10px; align-items:flex-start; padding:12px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); border-radius:14px; cursor:pointer;
      width:100%; text-align:left; outline:none;
      appearance:none; -webkit-appearance:none;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      color:var(--text);
    }
    .chk:hover{border-color: rgba(255,255,255,.18)}
    .chk:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .box{width:18px; height:18px; border-radius:6px; border:1px solid var(--border); margin-top:2px; display:grid; place-items:center; flex:0 0 18px}
    .chk.selected .box{background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.35)}
    .chk .main{font-weight:750; font-size:14px}
    .chk .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .btnbar{display:flex; gap:10px; justify-content:space-between; margin-top:14px}
    .btn{
      padding:11px 14px; border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-weight:750;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      appearance:none; -webkit-appearance:none;
    }
    .btn:hover{border-color: rgba(255,255,255,.18)}
    .btn.primary{background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95)); border-color: transparent; color:#130a05}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .side{display:grid; gap:16px}
    .kpi{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .tile{padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)}
    .tile .v{font-size:18px; font-weight:850}
    .tile .l{color:var(--muted); font-size:12px; margin-top:4px}

    .badge{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); font-size:13px; color:var(--muted)}
    .badge b{color:var(--text)}
    .tag{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)}

    .rec{padding:14px; border-radius:18px; border:1px solid rgba(255,106,0,.35); background: rgba(255,106,0,.08)}
    .rec .big{font-size:16px; font-weight:900}
    .rec .price{font-weight:900; color:#ffe3d2}
    .list{margin:10px 0 0; padding-left:18px; color:var(--muted)}
    .list li{margin:4px 0}
    .seller{padding:14px; border-radius:18px; border:1px solid rgba(45,212,191,.35); background: rgba(45,212,191,.08)}
    .seller .big{font-size:14px; font-weight:900}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; font-size:12px; color:var(--muted)}

    /* step dots as buttons */
    .dot{
      width:34px; height:34px; border-radius:12px; display:grid; place-items:center; font-size:13px;
      border:1px solid var(--border); background: rgba(255,255,255,.03); color:var(--muted);
      touch-action:manipulation; -webkit-tap-highlight-color: transparent; cursor:pointer;
      appearance:none; -webkit-appearance:none; outline:none;
    }
    .dot.active{background: rgba(255,106,0,.16); color: #ffe6d6; border-color: rgba(255,106,0,.35)}
    .dot.done{background: rgba(45,212,191,.12); color: #d7fff7; border-color: rgba(45,212,191,.35)}
    .dot:focus-visible{outline:2px solid rgba(255,255,255,.22)}

    @media print{
      body{background:white; color:#111}
      .wrap{max-width:none}
      .card{box-shadow:none}
      .btnbar, .top .pill, .side .tile, #shareRow{display:none !important}
      .grid{grid-template-columns:1fr}
      .rec, .seller{border-color:#ddd; background:#fff}
      .muted, .list, .mono{color:#444}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Configurateur Offres â€” Prototype V1</div>
          <div class="subtitle">Diagnostic usages (Wi-Fi / Internet / Mobile / SÃ©curitÃ©) â†’ recommandation + scripts vendeur</div>
        </div>
      </div>
      <div class="pill" title="V1: sans donnÃ©es personnelles, utilisable sur tablette">
        <span>ðŸŸ </span> <span>V1 â€¢ 5 Ã©crans â€¢ sans RGPD lourd</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="stepper" id="stepper"></div>
          <div class="sp"></div>
          <div class="h1" id="screenTitle">â€”</div>
          <div class="muted" id="screenHint" style="margin-top:6px">â€”</div>
        </div>
        <div class="bd" id="screen"></div>
      </div>

      <div class="side">
        <div class="card">
          <div class="bd">
            <div class="h2">PrÃ©visualisation (temps rÃ©el)</div>
            <div class="kpi">
              <div class="tile"><div class="v" id="kpiWifi">â€”</div><div class="l">DifficultÃ© Wi-Fi</div></div>
              <div class="tile"><div class="v" id="kpiRep">â€”</div><div class="l">RÃ©pÃ©teurs recommandÃ©s</div></div>
              <div class="tile"><div class="v" id="kpiIntensity">â€”</div><div class="l">IntensitÃ© Internet</div></div>
              <div class="tile"><div class="v" id="kpiMobile">â€”</div><div class="l">Profil Mobile</div></div>
            </div>
            <div class="sp"></div>
            <div class="row" id="tags"></div>
          </div>
        </div>

        <div class="card">
          <div class="bd">
            <div class="h2">Actions</div>
            <div class="row" style="margin-bottom:10px">
              <button class="btn" id="btnModeClient" type="button">Mode client</button>
              <button class="btn" id="btnModeVendeur" type="button">Mode vendeur</button>
            </div>
            <div class="row" id="shareRow" style="margin-bottom:10px"></div>
            <div class="row">
              <button class="btn" id="btnReset" type="button">RÃ©initialiser</button>
              <button class="btn" id="btnPrint" type="button">Imprimer / PDF</button>
            </div>
            <div class="sp"></div>
            <div class="mono" id="stateDebug"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Polyfills / helpers =====
  const clone = (obj) => {
    try { return (typeof structuredClone === 'function') ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)); }
    catch { return JSON.parse(JSON.stringify(obj)); }
  };

  const $ = (id) => document.getElementById(id);
  const safe = (id) => { const el = $(id); if(!el) throw new Error('Ã‰lÃ©ment introuvable: #' + id); return el; };

  const euro = (n) => `${Number(n).toFixed(2).replace('.', ',')}â‚¬`;

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.padding='10px 12px';
    t.style.border='1px solid rgba(255,255,255,.14)';
    t.style.borderRadius='999px';
    t.style.background='rgba(17,24,38,.92)';
    t.style.color='var(--text)';
    t.style.boxShadow='var(--shadow)';
    t.style.zIndex='9999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, 1400);
    setTimeout(()=>t.remove(), 1800);
  }

  // ===== Data =====
  const OFFERS = {
    internet: [
      { id:'lite', name:'SÃ©rie SpÃ©ciale Livebox Lite Fibre', tier:1, commitmentMonths:12,
        price:{ intro:29.99, after:null, promoNote:null },
        includes:['Livebox 5 (Wi-Fi 5)','TV (200 chaÃ®nes) + DÃ©codeur UHD'],
        hint:'Simple, efficace â€” TV incluse.'
      },
      { id:'livebox', name:'Livebox Fibre', tier:2, commitmentMonths:12,
        price:{ intro:29.99, after:42.99, promoNote:'29,99â‚¬/mois pendant 12 mois puis 42,99â‚¬/mois' },
        includes:['Livebox S (Wi-Fi 7)','TV (200 chaÃ®nes) + DÃ©codeur TV 6'],
        hint:'Base solide Wi-Fi 7.'
      },
      { id:'up', name:'Livebox Up Fibre', tier:3, commitmentMonths:12,
        price:{ intro:39.99, after:51.99, promoNote:'39,99â‚¬/mois pendant 12 mois puis 51,99â‚¬/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 chaÃ®nes) + DÃ©codeur TV 6','1 rÃ©pÃ©teur Wi-Fi'],
        hint:'StabilitÃ© + usages intensifs.'
      },
      { id:'max', name:'Livebox Max Fibre', tier:4, commitmentMonths:12,
        price:{ intro:47.99, after:57.99, promoNote:'47,99â‚¬/mois pendant 12 mois puis 57,99â‚¬/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 chaÃ®nes) + 2 DÃ©codeurs TV 6','Jusquâ€™Ã  3 rÃ©pÃ©teurs Wi-Fi'],
        hint:'Couverture + confort total.'
      },
    ],
    mobileProfiles: [
      { id:'essentiel', name:'Essentiel', desc:'Usage maÃ®trisÃ©, Wi-Fi frÃ©quent' },
      { id:'confort', name:'Confort', desc:'LibertÃ© + hotspot + vidÃ©o sans y penser' },
      { id:'serenite', name:'SÃ©rÃ©nitÃ©', desc:'Aucune contrainte, zÃ©ro stress data' },
    ],
    // Remises Open validÃ©es par toi
    mobileOffers: [
      { id:'m2h', name:'Forfait 2h / 100 Mo', commitmentMonths:0, price:{intro:8.99, after:null, promoNote:'Sans engagement (prix indicatif)'}, openDiscount:3,
        highlights:['Appels 2h','SMS/MMS illimitÃ©s','100 Mo']
      },
      { id:'m20', name:'SÃ©rie SpÃ©ciale 20Go', commitmentMonths:0, price:{intro:17.99, after:null, promoNote:'Sans engagement'}, openDiscount:7,
        highlights:['Appels/SMS/MMS illimitÃ©s','20Go en France']
      },
      { id:'m120', name:'SÃ©rie SpÃ©ciale 120Go 5G', commitmentMonths:0, price:{intro:24.99, after:null, promoNote:'Promo possible (codes / pÃ©riodes)'}, openDiscount:5,
        highlights:['Appels/SMS/MMS illimitÃ©s','120Go 5G (selon conditions)']
      },
      { id:'m200', name:'Forfait 200Go 5G', commitmentMonths:24, price:{intro:37.99, after:47.99, promoNote:'Engagement 24 mois (prix indicatif)'}, openDiscount:8,
        highlights:['Appels/SMS/MMS illimitÃ©s','200Go 5G (selon conditions)']
      },
      { id:'m300', name:'Forfait 300Go 5G', commitmentMonths:24, price:{intro:44.99, after:54.99, promoNote:'Engagement 24 mois (prix indicatif)'}, openDiscount:15,
        highlights:['Gros usages','Partage de connexion intensif','Famille']
      },
      { id:'m500', name:'Forfait 500Go 5G+', commitmentMonths:24, price:{intro:59.99, after:69.99, promoNote:'Engagement 24 mois (prix indicatif)'}, openDiscount:15,
        highlights:['Premium','Multi-appareils','TrÃ¨s gros usages']
      },
    ],
    options: [
      { id:'maison_protegee', name:'Maison ProtÃ©gÃ©e', when:'Maison / absences / RDC', script:'Absences + maison â†’ tranquillitÃ© (dissuasion + intervention).' },
      { id:'cybersecure', name:'Cybersecure', when:'Enfants / tÃ©lÃ©travail / PC pro', script:'ProtÃ©ger la famille et les appareils (sans jargon).' },
      { id:'multisim', name:'Multi-SIM', when:'Montre / tablette / voiture / hotspot', script:'MÃªme forfait, plusieurs appareils : montre, tablette, voiture.' },
    ]
  };

  const DEFAULT_STATE = {
    step: 0,
    mode: 'client',
    hasBox: true,
    housing: { surface:null, type:null, floors:null, walls:null, boxPlacement:null },
    internetUsage: [],
    mobileContext: [],
    security: [],
    devices: [],
  };

  const STEPS = [
    { key:'housing', title:'Logement & Wi-Fi', hint:'On dimensionne la couverture rÃ©elle : surface, Ã©tages, murs.' },
    { key:'internet', title:'Usages Internet', hint:'TÃ©lÃ©travail, gaming, streaming, familleâ€¦' },
    { key:'mobile', title:'Mobile (sans parler de Go)', hint:'On vend du confort : ne plus surveiller, pouvoir partager, gÃ©rer lâ€™imprÃ©vu.' },
    { key:'security', title:'SÃ©curitÃ© & SÃ©rÃ©nitÃ©', hint:'Absences, enfants, appareils sensiblesâ€¦' },
    { key:'result', title:'RÃ©sultat', hint:'Recommandation + justification client + scripts vendeur.' },
  ];

  let state = null;

  // ===== Engine =====
  function wifiDifficultyScore(h){
    if (h.surface == null) return 0;
    let score = 0;
    const s = Number(h.surface);
    if (s >= 50) score += 1;
    if (s > 90) score += 1;
    if (s > 130) score += 1;

    const f = Number(h.floors ?? 0);
    if (f >= 1) score += 1;
    if (f >= 2) score += 1;

    if (h.walls === 'beton') score += 1;
    if (h.boxPlacement === 'excentre') score += 1;
    if (h.boxPlacement === 'garage') score += 2;

    return Math.min(score, 8);
  }

  function recommendedRepeaters(h){
    let rep = 0;
    const s = Number(h.surface ?? 0);
    const f = Number(h.floors ?? 0);
    if (s > 90) rep += 1;
    if (f >= 1) rep += 1;
    if (h.walls === 'beton') rep += 1;
    if (h.boxPlacement === 'garage') rep += 1;
    return Math.max(0, Math.min(rep, 3));
  }

  function internetIntensity(usages){
    const u = new Set(usages);
    let points = 0;
    if (u.has('teletravail')) points += 2;
    if (u.has('gaming')) points += 2;
    if (u.has('streaming')) points += 2;
    if (u.has('famille')) points += 2;
    if (u.has('iot')) points += 1;
    if (points <= 2) return 'Faible';
    if (points <= 5) return 'Moyen';
    return 'Ã‰levÃ©';
  }

  function mobileProfile(ctx){
    const c = new Set(ctx);
    let p = 0;
    if (c.has('gps')) p += 1;
    if (c.has('video')) p += 2;
    if (c.has('hotspot')) p += 2;
    if (c.has('wifi_unstable')) p += 2;
    if (c.has('zero_stress')) p += 3;
    if (p <= 2) return 'essentiel';
    if (p <= 6) return 'confort';
    return 'serenite';
  }

  function recommendBox(){
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const u = new Set(state.internetUsage);

    let tier = 2;
    if (intensity === 'Moyen' || intensity === 'Ã‰levÃ©') tier = 3;

    const heavy = (u.has('teletravail') && u.has('gaming')) || (u.has('teletravail') && u.has('streaming') && u.has('famille'));
    if (heavy) tier = 3;
    if (rep >= 2) tier = 4;

    const s = Number(state.housing.surface ?? 0);
    if (tier === 2 && intensity === 'Faible' && s > 0 && s < 50 && rep === 0) return { primary:'livebox', alternative:'lite' };
    return { primary: tier === 4 ? 'max' : 'up', alternative: tier === 4 ? 'up' : 'livebox' };
  }

  function recommendOptions(){
    const opts = [];
    const sec = new Set(state.security);
    const dev = new Set(state.devices);
    const u = new Set(state.internetUsage);
    const mc = new Set(state.mobileContext);

    if (sec.has('absences') || sec.has('rdc') || state.housing.type === 'maison') opts.push('maison_protegee');
    if (sec.has('enfants') || sec.has('pc_pro') || u.has('teletravail')) opts.push('cybersecure');
    if (dev.has('watch') || dev.has('tablet') || dev.has('car') || mc.has('hotspot')) opts.push('multisim');
    return [...new Set(opts)];
  }

  function buildResult(){
    const wifiScore = wifiDifficultyScore(state.housing);
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const mp = mobileProfile(state.mobileContext);
    const { primary, alternative } = recommendBox();
    const options = recommendOptions();

    const reasons = [];
    const s = Number(state.housing.surface ?? 0);
    const f = Number(state.housing.floors ?? 0);
    if (s > 90) reasons.push('Surface > 90 mÂ² â†’ couverture Wi-Fi Ã  renforcer');
    if (f >= 1) reasons.push('PrÃ©sence dâ€™Ã©tage â†’ Wi-Fi Ã  sÃ©curiser');
    if (state.housing.walls === 'beton') reasons.push('Murs bÃ©ton/pierre â†’ attÃ©nuation importante');
    if (state.housing.boxPlacement === 'garage') reasons.push('Box en local technique/garage â†’ propagation compliquÃ©e');

    const u = new Set(state.internetUsage);
    if (u.has('teletravail')) reasons.push('TÃ©lÃ©travail/visio â†’ stabilitÃ© et upload');
    if (u.has('gaming')) reasons.push('Gaming en ligne â†’ stabilitÃ© + latence');
    if (u.has('streaming')) reasons.push('Streaming vidÃ©o â†’ dÃ©bit constant');
    if (u.has('famille')) reasons.push('Plusieurs utilisateurs â†’ capacitÃ© + Wi-Fi');

    const sellerAlerts = [];
    if (rep >= 1 && (primary === 'livebox' || primary === 'lite')) sellerAlerts.push('âš ï¸ Risque Wi-Fi : prÃ©voir rÃ©pÃ©teur(s) ou monter en gamme (Up/Max).');
    if (u.has('teletravail')) sellerAlerts.push('ðŸ’¡ Script : Â« En visio, câ€™est la stabilitÃ© qui fait la diffÃ©rence. Â»');
    if (mp !== 'essentiel') sellerAlerts.push('ðŸ’¡ Script : Â« Ce forfait nâ€™est pas pour consommer plus, câ€™est pour ne jamais faire attention. Â»');

    return { wifiScore, rep, intensity, mobileProfile: mp, primaryBox: primary, altBox: alternative, options, reasons, sellerAlerts };
  }

  // ===== UI helpers =====
  const scoreLabel = (score) => (score<=1?'Facile':score<=3?'Moyen':score<=5?'Difficile':'TrÃ¨s difficile');

  function badge(text){
    const div = document.createElement('span');
    div.className = 'tag';
    div.textContent = text;
    return div;
  }

  function setSeg(containerId, options, selectedValue, onChange){
    const container = safe(containerId);
    container.innerHTML = '';
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'opt' + (selectedValue === opt.value ? ' selected' : '');
      btn.setAttribute('aria-pressed', selectedValue === opt.value ? 'true' : 'false');
      btn.innerHTML = `<div class="t">${opt.label}</div><div class="s">${opt.hint||''}</div>`;
      const fire = (e)=>{ e.preventDefault(); e.stopPropagation(); onChange(opt.value); };
      btn.addEventListener('click', fire);
      btn.addEventListener('touchend', fire, { passive:false });
      container.appendChild(btn);
    });
  }

  function setChecks(containerId, items, selectedSet, onToggle){
    const container = safe(containerId);
    container.innerHTML = '';
    items.forEach(it => {
      const selected = selectedSet.has(it.value);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chk' + (selected ? ' selected' : '');
      btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
      btn.innerHTML = `
        <div class="box">${selected ? 'âœ“' : ''}</div>
        <div>
          <div class="main">${it.label}</div>
          <div class="sub">${it.hint || ''}</div>
        </div>`;
      const fire = (e)=>{ e.preventDefault(); e.stopPropagation(); onToggle(it.value); };
      btn.addEventListener('click', fire);
      btn.addEventListener('touchend', fire, { passive:false });
      container.appendChild(btn);
    });
  }

  function renderStepper(){
    const el = safe('stepper');
    el.innerHTML = '';
    STEPS.forEach((s, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dot' + (i === state.step ? ' active' : (i < state.step ? ' done' : ''));
      btn.textContent = (i+1);
      btn.title = s.title;
      const fire = (e)=>{ e.preventDefault(); state.step = i; persist(); render(); };
      btn.addEventListener('click', fire);
      btn.addEventListener('touchend', fire, { passive:false });
      el.appendChild(btn);
      if (i < STEPS.length-1) {
        const line = document.createElement('div');
        line.className = 'line';
        el.appendChild(line);
      }
    });
  }

  function navButtons(nextLabel='Suivant'){
    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev" type="button" ${state.step===0?'disabled':''}>Retour</button>
      <button class="btn primary" id="btnNext" type="button">${nextLabel}</button>`;
    setTimeout(()=>{
      safe('btnPrev').addEventListener('click', (e)=>{ e.preventDefault(); state.step = Math.max(0, state.step-1); persist(); render(); });
      safe('btnNext').addEventListener('click', (e)=>{ e.preventDefault(); state.step = Math.min(STEPS.length-1, state.step+1); persist(); render(); });
    });
    return nav;
  }

  const priceLine = (o) => {
    if (!o?.price) return 'â€”';
    if (o.price.after == null) return `${euro(o.price.intro)}/mois`;
    return `${euro(o.price.intro)}/mois (12 mois) puis ${euro(o.price.after)}/mois`;
  };

  function mobilePriceWithOpen(offer){
    if (!offer?.price) return { std: NaN, open: NaN, discount: 0 };
    const std = Number(offer.price.intro);
    const d = Number(offer.openDiscount ?? 0);
    const open = Math.max(std - (state.hasBox ? d : 0), 0);
    return { std, open, discount: state.hasBox ? d : 0 };
  }

  // ===== State (URL + local) =====
  function buildShareURL(){
    const compact = {
      s: state.step, m: state.mode, bx: state.hasBox,
      h: state.housing, iu: state.internetUsage, mc: state.mobileContext, se: state.security, d: state.devices
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
    const u = new URL(window.location.href);
    u.searchParams.set('cfg', payload);
    return u.toString();
  }

  function loadFromURL(){
    try{
      const u = new URL(window.location.href);
      const cfg = u.searchParams.get('cfg');
      if (!cfg) return null;
      const json = decodeURIComponent(escape(atob(cfg)));
      const obj = JSON.parse(json);
      const st = clone(DEFAULT_STATE);
      st.step = Number(obj.s ?? 0);
      st.mode = (obj.m === 'vendeur') ? 'vendeur' : 'client';
      st.hasBox = (obj.bx === false) ? false : true;
      st.housing = obj.h || st.housing;
      st.internetUsage = obj.iu || [];
      st.mobileContext = obj.mc || [];
      st.security = obj.se || [];
      st.devices = obj.d || [];
      return st;
    } catch { return null; }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('cfg_v1_state');
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function persist(){
    try{ localStorage.setItem('cfg_v1_state', JSON.stringify(state)); } catch {}
    try{ window.history.replaceState({}, '', buildShareURL()); } catch {}
  }

  // ===== Screens =====
  function renderHousing(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Surface du logement</label><div class="seg" id="segSurface"></div></div>`);
    setSeg('segSurface', [
      { value: 40, label: '< 50 mÂ²', hint: 'Wi-Fi souvent simple' },
      { value: 70, label: '50â€“90 mÂ²', hint: 'Ã€ surveiller selon murs' },
      { value: 110, label: '90â€“130 mÂ²', hint: 'RÃ©pÃ©teur souvent utile' },
      { value: 150, label: '+ 130 mÂ²', hint: 'Couverture Ã  sÃ©curiser' },
    ], state.housing.surface, (v)=>{ state.housing.surface=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Type de logement</label><div class="seg2" id="segType"></div></div>`);
    setSeg('segType', [
      { value:'appart', label:'Appartement', hint:'' },
      { value:'maison', label:'Maison', hint:'' },
    ], state.housing.type, (v)=>{ state.housing.type=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Ã‰tages</label><div class="seg" id="segFloors"></div></div>`);
    setSeg('segFloors', [
      { value:0, label:'0', hint:'Plain pied / mÃªme niveau' },
      { value:1, label:'1', hint:'Wi-Fi Ã  lâ€™Ã©tage' },
      { value:2, label:'2+', hint:'Couverture plus difficile' },
      { value:3, label:'3+', hint:'Cas exigeant' },
    ], state.housing.floors, (v)=>{ state.housing.floors=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Murs majoritaires</label><div class="seg2" id="segWalls"></div></div>`);
    setSeg('segWalls', [
      { value:'placo', label:'PlacoplÃ¢tre', hint:'Diffusion OK' },
      { value:'beton', label:'BÃ©ton / pierre', hint:'AttÃ©nuation forte' },
    ], state.housing.walls, (v)=>{ state.housing.walls=v; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Emplacement probable de la box</label><div class="seg" id="segPlace"></div></div>`);
    setSeg('segPlace', [
      { value:'central', label:'Central', hint:'Meilleur scÃ©nario' },
      { value:'excentre', label:'ExcentrÃ©', hint:'Couverture Ã  surveiller' },
      { value:'garage', label:'Garage / local', hint:'Propagation difficile' },
      { value:'inconnu', label:'Je ne sais pas', hint:'' },
    ], state.housing.boxPlacement, (v)=>{ state.housing.boxPlacement=v; persist(); render(); });

    root.appendChild(navButtons());
  }

  function renderInternet(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Usages Internet (plusieurs choix)</label><div class="checklist" id="chkInternet"></div></div>`);
    const selected = new Set(state.internetUsage);
    setChecks('chkInternet', [
      { value:'teletravail', label:'TÃ©lÃ©travail / visio', hint:'StabilitÃ© + upload' },
      { value:'gaming', label:'Gaming en ligne', hint:'Latence + stabilitÃ©' },
      { value:'streaming', label:'Streaming vidÃ©o / TV 4K', hint:'DÃ©bit constant' },
      { value:'famille', label:'Famille (3+ utilisateurs)', hint:'CapacitÃ© + Wi-Fi' },
      { value:'iot', label:'Objets connectÃ©s / camÃ©ras', hint:'RÃ©seau toujours dispo' },
    ], selected, (v)=>{ selected.has(v)?selected.delete(v):selected.add(v); state.internetUsage=[...selected]; persist(); render(); });
    root.appendChild(navButtons());
  }

  function renderMobile(root){
    root.innerHTML = '';

    const openCard = document.createElement('div');
    openCard.className = 'card';
    openCard.innerHTML = `
      <div class="bd">
        <div class="h2">Avantage Open</div>
        <div class="muted">Active la remise Open si le client a une box Orange (dÃ©jÃ  ou en souscription).</div>
        <div class="sp"></div>
        <button class="btn ${state.hasBox ? 'primary' : ''}" id="btnHasBox" type="button">
          ${state.hasBox ? 'âœ… Box Orange : OUI (Open actif)' : 'â¬œ Box Orange : NON (Open inactif)'}
        </button>
      </div>`;
    root.appendChild(openCard);

    setTimeout(()=> safe('btnHasBox').addEventListener('click', (e)=>{ e.preventDefault(); state.hasBox=!state.hasBox; persist(); render(); }));

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Hors Wi-Fi, quâ€™est-ce qui vous arrive souvent ?</label><div class="checklist" id="chkMobile"></div></div>`);
    const selected = new Set(state.mobileContext);
    setChecks('chkMobile', [
      { value:'gps', label:'GPS / voiture', hint:'Trafic temps rÃ©el + itinÃ©raires' },
      { value:'video', label:'VidÃ©os / rÃ©seaux sociaux', hint:'VidÃ©o auto â†’ conso invisible' },
      { value:'hotspot', label:'Partage de connexion', hint:'PC / tablette â†’ Ã§a monte vite' },
      { value:'wifi_unstable', label:'Wi-Fi parfois indisponible', hint:'ImprÃ©vus / dÃ©placements' },
      { value:'zero_stress', label:'Je veux Ãªtre tranquille', hint:'ZÃ©ro surveillance' },
    ], selected, (v)=>{ selected.has(v)?selected.delete(v):selected.add(v); state.mobileContext=[...selected]; persist(); render(); });

    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Appareils concernÃ©s</label><div class="checklist" id="chkDevices"></div></div>`);
    const dev = new Set(state.devices);
    setChecks('chkDevices', [
      { value:'watch', label:'Montre connectÃ©e (eSIM)', hint:'Multi-SIM pertinente' },
      { value:'tablet', label:'Tablette', hint:'Multi-SIM / data dÃ©diÃ©e' },
      { value:'car', label:'Voiture / routeur', hint:'Connexion embarquÃ©e' },
    ], dev, (v)=>{ dev.has(v)?dev.delete(v):dev.add(v); state.devices=[...dev]; persist(); render(); });

    root.appendChild(navButtons());
  }

  function renderSecurity(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Contexte sÃ©curitÃ© (plusieurs choix)</label><div class="checklist" id="chkSec"></div></div>`);
    const selected = new Set(state.security);
    setChecks('chkSec', [
      { value:'absences', label:'Absences frÃ©quentes', hint:'Travail, vacances, dÃ©placements' },
      { value:'rdc', label:'RDC / accÃ¨s facile', hint:'Risque perÃ§u plus Ã©levÃ©' },
      { value:'enfants', label:'Enfants / ados connectÃ©s', hint:'Protection + contrÃ´le' },
      { value:'pc_pro', label:'Appareils sensibles (PC pro, tÃ©lÃ©travail)', hint:'SÃ©curiser lâ€™usage' },
    ], selected, (v)=>{ selected.has(v)?selected.delete(v):selected.add(v); state.security=[...selected]; persist(); render(); });

    root.appendChild(navButtons('Voir le rÃ©sultat'));
  }

  function renderResult(root){
    const res = buildResult();
    const primary = OFFERS.internet.find(o=>o.id===res.primaryBox);
    const alt = OFFERS.internet.find(o=>o.id===res.altBox);
    const mp = OFFERS.mobileProfiles.find(p=>p.id===res.mobileProfile);

    const mobileOfferId = (res.mobileProfile==='essentiel') ? 'm20' : (res.mobileProfile==='confort' ? 'm120' : 'm200');
    const mOffer = OFFERS.mobileOffers.find(m=>m.id===mobileOfferId);
    const opts = res.options.map(id=>OFFERS.options.find(o=>o.id===id)).filter(Boolean);

    root.innerHTML = '';

    const rec = document.createElement('div');
    rec.className = 'rec';
    rec.innerHTML = `
      <div class="big">Offre internet conseillÃ©e</div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap">
        <div>
          <div class="big" style="font-size:18px">${primary.name}</div>
          <div class="muted" style="margin-top:4px">${primary.hint}</div>
        </div>
        <div class="price">${priceLine(primary)} â€¢ RÃ©pÃ©teurs: ${res.rep}</div>
      </div>
      <ul class="list">${res.reasons.slice(0,6).map(r=>`<li>${r}</li>`).join('')}</ul>
      <div class="row" style="margin-top:10px">
        ${primary.includes.map(x=>`<span class="badge"><b>Inclus</b> ${x}</span>`).join('')}
      </div>
      <div class="sp"></div>
      <div class="muted">Alternative (budget / usage plus simple) :</div>
      <div style="margin-top:6px"><span class="badge"><b>${alt.name}</b> â€” ${alt.hint} â€¢ ${priceLine(alt)}</span></div>
    `;
    root.appendChild(rec);

    const mob = document.createElement('div');
    mob.className = 'card';
    mob.style.marginTop = '12px';

    let priceBadge = `<div class="badge"><b>Forfait conseillÃ©</b> â€¢ â€”</div>`;
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      priceBadge = (state.hasBox && p.discount>0)
        ? `<div class="badge"><b>${mOffer.name}</b> â€¢ <span style="text-decoration:line-through; opacity:.7">${euro(p.std)}/mois</span> <b style="color:#ffe3d2">${euro(p.open)}/mois</b> <span class="muted">(Open âˆ’${p.discount}â‚¬/mois)</span></div>`
        : `<div class="badge"><b>${mOffer.name}</b> â€¢ ${euro(p.std)}/mois</div>`;
    }

    mob.innerHTML = `
      <div class="bd">
        <div class="h2">Mobile recommandÃ© (positionnement)</div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="badge"><b>${mp.name}</b> â€” ${mp.desc}</div>
          ${priceBadge}
        </div>
        <ul class="list">
          <li>Â« Ce forfait nâ€™est pas pour consommer plus, câ€™est pour ne jamais faire attention. Â»</li>
          <li>Â« Quand le Wi-Fi nâ€™est pas lÃ , vous Ãªtes tranquille : GPS, vidÃ©o, hotspot. Â»</li>
        </ul>
        ${mOffer?.price?.promoNote ? `<div class="muted" style="margin-top:8px">Note : ${mOffer.price.promoNote}</div>` : ``}
      </div>`;
    root.appendChild(mob);

    const opt = document.createElement('div');
    opt.className = 'card';
    opt.style.marginTop = '12px';
    opt.innerHTML = `
      <div class="bd">
        <div class="h2">Options suggÃ©rÃ©es</div>
        ${opts.length ? opts.map(o=>`<div class="badge" style="margin:6px 0"><b>${o.name}</b> â€” ${o.when}</div>`).join('') : `<div class="muted">Aucune option dÃ©tectÃ©e comme prioritaire.</div>`}
        ${opts.length ? `<ul class="list">${opts.map(o=>`<li>${o.script}</li>`).join('')}</ul>` : ``}
      </div>`;
    root.appendChild(opt);

    if (state.mode === 'vendeur') {
      const seller = document.createElement('div');
      seller.className = 'seller';
      seller.style.marginTop = '12px';
      seller.innerHTML = `
        <div class="big">Mode vendeur</div>
        ${res.sellerAlerts.length ? `<ul class="list" style="color:#d7fff7">${res.sellerAlerts.map(x=>`<li>${x}</li>`).join('')}</ul>` : `<div class="muted">Alerte : aucune.</div>`}
        <div class="sp"></div>
        <div class="muted">Phrase Wi-Fi : Â« Le Wi-Fi, ce nâ€™est pas la box, câ€™est la maison. Â»</div>`;
      root.appendChild(seller);
    }

    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev" type="button">Retour</button>
      <button class="btn primary" id="btnCopy" type="button">Copier le rÃ©cap</button>`;
    root.appendChild(nav);

    setTimeout(()=>{
      safe('btnPrev').addEventListener('click', (e)=>{ e.preventDefault(); state.step = Math.max(0, state.step-1); persist(); render(); });
      safe('btnCopy').addEventListener('click', (e)=>{
        e.preventDefault();
        const txt = buildPlainTextRecap(res, primary, alt, mp, mOffer, opts);
        if (navigator.clipboard?.writeText) navigator.clipboard.writeText(txt);
        toast('RÃ©cap copiÃ©.');
      });
    });
  }

  function buildPlainTextRecap(res, primary, alt, mp, mOffer, opts){
    const lines = [];
    lines.push('RÃ‰CAP CONFIGURATEUR (V1)');
    lines.push('â€”');
    lines.push(`Box Orange (Open): ${state.hasBox ? 'OUI' : 'NON'}`);
    lines.push(`Internet conseillÃ©: ${primary.name} (RÃ©pÃ©teurs: ${res.rep})`);
    lines.push(`Prix: ${priceLine(primary)}`);
    lines.push(`Alternative: ${alt.name} â€” ${priceLine(alt)}`);
    lines.push(`IntensitÃ© internet: ${res.intensity}`);
    lines.push(`Profil mobile: ${mp.name} â€” ${mp.desc}`);
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) lines.push(`Mobile conseillÃ©: ${mOffer.name} â€” ${euro(p.open)}/mois (Open âˆ’${p.discount}â‚¬) [standard ${euro(p.std)}/mois]`);
      else lines.push(`Mobile conseillÃ©: ${mOffer.name} â€” ${euro(p.std)}/mois`);
    }
    lines.push('â€”');
    lines.push('Justifications:');
    res.reasons.forEach(r => lines.push(`- ${r}`));
    lines.push('â€”');
    lines.push(`Options suggÃ©rÃ©es: ${opts.length ? opts.map(o=>o.name).join(', ') : 'Aucune'}`);
    if (opts.length) opts.forEach(o => lines.push(`- ${o.name}: ${o.script}`));
    if (state.mode === 'vendeur' && res.sellerAlerts.length){
      lines.push('â€”');
      lines.push('Mode vendeur:');
      res.sellerAlerts.forEach(a => lines.push(`- ${a}`));
    }
    lines.push('');
    return lines.join('\n');
  }

  // ===== Sidebar + global render =====
  function renderShare(){
    const row = safe('shareRow');
    row.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.type = 'button';
    btn.textContent = 'CrÃ©er un lien de partage';
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const url = buildShareURL();
      if (navigator.clipboard?.writeText) navigator.clipboard.writeText(url);
      toast('Lien copiÃ©.');
    });
    const btn2 = document.createElement('button');
    btn2.className = 'btn ghost';
    btn2.type = 'button';
    btn2.textContent = 'Ouvrir le lien';
    btn2.addEventListener('click', (e)=>{ e.preventDefault(); window.open(buildShareURL(), '_blank'); });
    row.appendChild(btn);
    row.appendChild(btn2);
  }

  function render(){
    renderStepper();
    const step = STEPS[state.step];
    safe('screenTitle').textContent = step.title;
    safe('screenHint').textContent = step.hint;

    const root = safe('screen');
    if (step.key === 'housing') renderHousing(root);
    if (step.key === 'internet') renderInternet(root);
    if (step.key === 'mobile') renderMobile(root);
    if (step.key === 'security') renderSecurity(root);
    if (step.key === 'result') renderResult(root);

    const res = buildResult();
    safe('kpiWifi').textContent = scoreLabel(res.wifiScore);
    safe('kpiRep').textContent = String(res.rep);
    safe('kpiIntensity').textContent = res.intensity;
    const mp = OFFERS.mobileProfiles.find(p=>p.id===res.mobileProfile);
    safe('kpiMobile').textContent = mp ? mp.name : 'â€”';

    const tags = safe('tags');
    tags.innerHTML = '';
    tags.appendChild(badge(state.hasBox ? 'Open: OUI' : 'Open: NON'));
    if (state.housing.surface) tags.appendChild(badge(`${state.housing.surface} mÂ²`));
    if (state.housing.type) tags.appendChild(badge(state.housing.type === 'maison' ? 'Maison' : 'Appartement'));
    if (state.housing.floors != null) tags.appendChild(badge(`${state.housing.floors} Ã©tage(s)`));
    if (state.housing.walls) tags.appendChild(badge(state.housing.walls === 'beton' ? 'Murs bÃ©ton/pierre' : 'Murs placo'));
    state.internetUsage.forEach(u=>tags.appendChild(badge(`Internet: ${u}`)));
    state.mobileContext.forEach(c=>tags.appendChild(badge(`Mobile: ${c}`)));
    state.security.forEach(s=>tags.appendChild(badge(`SÃ©curitÃ©: ${s}`)));

    safe('btnModeClient').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeur').classList.toggle('primary', state.mode === 'vendeur');

    renderShare();
    safe('stateDebug').textContent = `state: ${JSON.stringify(state)}`;
  }

  function init(){
    state = loadFromURL() || loadLocal() || clone(DEFAULT_STATE);

    safe('btnReset').addEventListener('click', (e)=>{ e.preventDefault(); state = clone(DEFAULT_STATE); persist(); render(); });
    safe('btnPrint').addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
    safe('btnModeClient').addEventListener('click', (e)=>{ e.preventDefault(); state.mode='client'; persist(); render(); });
    safe('btnModeVendeur').addEventListener('click', (e)=>{ e.preventDefault(); state.mode='vendeur'; persist(); render(); });

    render();
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    try { init(); }
    catch (e) {
      console.error(e);
      alert('Erreur JS : ' + (e && e.message ? e.message : e));
    }
  });
})();
</script>
</body>
</html>
