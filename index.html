<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurateur Offres ‚Äî Boutique</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef8;
      --accent:#ff6a00; --accent2:#ff8a3d; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,106,0,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(45,212,191,.10), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* Garde-fous anti "texte noir" (Safari/iOS peut retomber sur styles par d√©faut) */
    table, th, td { color: var(--text); }
    b, strong { color: var(--text); }
    th { font-weight: 800; }
    .muted b, .muted strong { color: var(--text); }

    .wrap{max-width:1120px; margin:0 auto; padding:20px}
    .top{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; margin:10px 0 12px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: var(--shadow)}
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px; margin-top:2px}

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px; border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:999px; color:var(--muted); font-size:13px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .modebar{display:inline-flex; gap:8px; align-items:center}
    .modebtn{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
      appearance:none; -webkit-appearance:none;
    }
    .modebtn.primary{
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      border-color: transparent;
      color:#1a120b;
    }

    .hero{
      display:grid; gap:12px; grid-template-columns: 1.6fr .4fr;
      margin-bottom:18px; align-items:center;
    }
    .hero-card{
      padding:14px 16px; border-radius:16px; border:1px solid var(--border);
      background: rgba(255,255,255,.035);
      display:flex; flex-direction:column; gap:8px;
    }
    .hero-title{font-weight:900; font-size:16px}
    .hero-sub{color:var(--muted); font-size:13px}
    .hero-kpis{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px}
    .hero-kpis span{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)
    }

    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:16px}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .hero{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow: var(--shadow)
    }
    .card .hd{padding:18px 18px 0}
    .card .bd{padding:18px}
    .h1{font-size:18px; font-weight:800; margin:0}
    .h2{font-size:14px; font-weight:800; margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .sp{height:10px}
    .stepmeta{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted)}
    .progress{
      margin:10px 0 12px; width:100%; height:8px; border-radius:999px;
      background: rgba(255,255,255,.06); overflow:hidden; border:1px solid var(--border)
    }
    .progress > div{
      height:100%; border-radius:inherit;
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      transition: width .25s ease;
    }
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--border); background: rgba(255,255,255,.03);
      display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted)
    }
    .feedback span{display:inline-flex; gap:6px; align-items:center}

    .stepper{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .dot{
      width:34px; height:34px; border-radius:12px; display:grid; place-items:center;
      font-size:13px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); color:var(--muted);
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      cursor:pointer; appearance:none; -webkit-appearance:none; outline:none
    }
    .dot:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .dot.active{background: rgba(255,106,0,.16); color: #ffe6d6; border-color: rgba(255,106,0,.35)}
    .dot.done{background: rgba(45,212,191,.12); color: #d7fff7; border-color: rgba(45,212,191,.35)}
    .line{flex:1; min-width:24px; height:1px; background: var(--border)}

    .q{margin:12px 0}
    .q label{display:block; font-size:13px; color:var(--muted); margin:0 0 8px}

    .seg{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 780px){ .seg{grid-template-columns:1fr 1fr} }
    .seg2{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}

    .opt{
      position:relative; padding:12px; border-radius:14px;
      border:1px solid var(--border); background: rgba(255,255,255,.03);
      cursor:pointer; user-select:none; min-height:54px;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      width:100%; text-align:left; appearance:none; -webkit-appearance:none; outline:none
    }
    .opt:hover{border-color: rgba(255,255,255,.18)}
    .opt:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .opt .t{font-weight:800; font-size:14px; color:var(--text)}
    .opt .s{color:var(--muted); font-size:12px; margin-top:4px}
    .opt.selected{outline: 2px solid rgba(255,106,0,.35); border-color: rgba(255,106,0,.35); background: rgba(255,106,0,.08)}

    .checklist{display:grid; gap:10px}
    .chk{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px; border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px; cursor:pointer;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      width:100%; text-align:left; appearance:none; -webkit-appearance:none; outline:none
    }
    .chk:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .box{width:18px; height:18px; border-radius:6px; border:1px solid var(--border); margin-top:2px; display:grid; place-items:center; color:var(--text)}
    .chk.selected .box{background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.35)}
    .chk .main{font-weight:800; font-size:14px; color:var(--text)}
    .chk .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .btnbar{display:flex; gap:10px; justify-content:space-between; margin-top:16px}
    .btn{
      padding:11px 14px; border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.04); color:var(--text);
      cursor:pointer; font-weight:800; touch-action:manipulation; -webkit-tap-highlight-color: transparent
    }
    .btn:hover{border-color: rgba(255,255,255,.18)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      border-color: transparent;
      color:#1a120b;
    }
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btnhint{margin-top:8px; font-size:12px; color:var(--warn)}

    .side{display:grid; gap:16px}
    .kpi{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .tile{padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)}
    .tile .v{font-size:18px; font-weight:900; color:var(--text)}
    .tile .l{color:var(--muted); font-size:12px; margin-top:4px}

    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:13px; color:var(--muted)
    }
    .badge b{color:var(--text)}
    .tag{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)
    }

    .rec{padding:14px; border-radius:18px; border:1px solid rgba(255,106,0,.35); background: rgba(255,106,0,.08)}
    .rec .big{font-size:16px; font-weight:900; color:var(--text)}
    .rec .price{font-weight:900; color:#ffe3d2}
    .list{margin:10px 0 0; padding-left:18px; color:var(--muted)}
    .list li{margin:4px 0}

    .seller{padding:14px; border-radius:18px; border:1px solid rgba(45,212,191,.35); background: rgba(45,212,191,.08)}
    .seller .big{font-size:14px; font-weight:900; color:var(--text)}
    .ai{padding:12px; border-radius:14px; border:1px solid rgba(255,138,61,.35); background: rgba(255,138,61,.08)}
    .ai .big{font-size:13px; font-weight:900; color:var(--text)}
    .ai ul{margin:8px 0 0; padding-left:18px; color:var(--muted); font-size:12px}

    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px; color:var(--muted)
    }

    /* Print */
    @media print{
      body{background:white; color:#111}
      .wrap{max-width:none}
      .card{box-shadow:none}
      .btnbar, .top .pill, .side .tile, #shareRow{display:none !important}
      .grid{grid-template-columns:1fr}
      .rec, .seller{border-color:#ddd; background:#fff}
      .muted, .list, .mono{color:#444}
      table, th, td { color:#111; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Configurateur Offres ‚Äî Boutique Orange</div>
          <div class="subtitle">Parcours simple pour recommander l'offre la plus adapt√©e.</div>
        </div>
      </div>

      <div class="pill" title="Sans donn√©es personnelles, utilisable sur tablette">
        <span>üü†</span> <span>Tablette ‚Ä¢ 5 √©tapes ‚Ä¢ sans donn√©e perso</span>
        <span style="opacity:.5">|</span>
        <div class="modebar" aria-label="Mode">
          <button class="modebtn" id="btnModeClientTop" type="button">Mode client</button>
          <button class="modebtn" id="btnModeVendeurTop" type="button">Mode vendeur</button>
        </div>
      </div>
    </div>

    <div class="hero">
      <div class="hero-card">
        <div class="hero-title">Un parcours clair en 2 minutes</div>
        <div class="hero-sub">Une question √† la fois, une recommandation claire √† la fin.</div>
        <div class="hero-kpis">
          <span>‚ö° Simple</span>
          <span>üß≠ Guid√©</span>
          <span>üß© Efficace</span>
        </div>
      </div>
      <div class="hero-card">
        <div class="hero-title">Temps estim√©</div>
        <div class="hero-sub">‚âà 2 minutes</div>
        <div class="hero-sub">Aucune donn√©e personnelle</div>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <div class="hd">
          <div class="stepper" id="stepper"></div>
          <div class="sp"></div>
          <div class="stepmeta">
            <span id="stepCount">√âtape ‚Äî</span>
            <span>R√©pondez simplement, sans r√©fl√©chir longtemps</span>
          </div>
          <div class="progress"><div id="progressFill" style="width:0%"></div></div>
          <div class="h1" id="screenTitle">‚Äî</div>
          <div class="muted" id="screenHint" style="margin-top:6px">‚Äî</div>
          <div class="feedback" id="clientFeedback" aria-live="polite"></div>
        </div>
        <div class="bd" id="screen"></div>
      </div>

      <!-- Side -->
      <div class="side" id="sidePanel">
        <div class="card">
          <div class="bd">
            <div class="h2">Pr√©visualisation (temps r√©el)</div>
            <div class="kpi">
              <div class="tile"><div class="v" id="kpiWifi">‚Äî</div><div class="l">Difficult√© Wi-Fi</div></div>
              <div class="tile"><div class="v" id="kpiRep">‚Äî</div><div class="l">R√©p√©teurs recommand√©s</div></div>
              <div class="tile"><div class="v" id="kpiIntensity">‚Äî</div><div class="l">Intensit√© Internet</div></div>
              <div class="tile"><div class="v" id="kpiMobile">‚Äî</div><div class="l">Profil Mobile</div></div>
            </div>
            <div class="sp"></div>
            <div class="row" id="tags"></div>
            <div class="sp"></div>
            <div class="ai" id="aiInsights">
              <div class="big">IA live</div>
              <div class="muted">En attente de r√©ponses‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="bd">
            <div class="h2">Actions</div>
            <div class="row" style="margin-bottom:10px">
              <button class="btn" id="btnModeClient" type="button">Mode client</button>
              <button class="btn" id="btnModeVendeur" type="button">Mode vendeur</button>
            </div>
            <div class="row" id="shareRow" style="margin-bottom:10px"></div>
            <div class="row">
              <button class="btn" id="btnReset" type="button">R√©initialiser</button>
              <button class="btn" id="btnPrint" type="button">Imprimer / PDF</button>
            </div>
            <div class="sp"></div>
            <div class="mono" id="stateDebug" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===========================
  // Configurateur Offres ‚Äî Boutique
  // 1 fichier, sans d√©pendance
  // ===========================

  const OFFERS = {
    internet: [
      { id:'lite', name:'S√©rie Sp√©ciale Livebox Lite Fibre', tier:1, commitmentMonths:12,
        price:{ intro:29.99, after:null, promoNote:null },
        includes:['Livebox 5 (Wi-Fi 5)','TV (200 cha√Ænes) + D√©codeur UHD'],
        hint:'Simple, efficace ‚Äî TV incluse.'
      },
      { id:'livebox', name:'Livebox Fibre', tier:2, commitmentMonths:12,
        price:{ intro:29.99, after:42.99, promoNote:'29,99‚Ç¨/mois pendant 12 mois puis 42,99‚Ç¨/mois' },
        includes:['Livebox S (Wi-Fi 7)','TV (200 cha√Ænes) + D√©codeur TV 6'],
        hint:'Base solide Wi-Fi 7.'
      },
      { id:'up', name:'Livebox Up Fibre', tier:3, commitmentMonths:12,
        price:{ intro:39.99, after:51.99, promoNote:'39,99‚Ç¨/mois pendant 12 mois puis 51,99‚Ç¨/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 cha√Ænes) + D√©codeur TV 6','1 r√©p√©teur Wi-Fi'],
        hint:'Stabilit√© + usages intensifs.'
      },
      { id:'max', name:'Livebox Max Fibre', tier:4, commitmentMonths:12,
        price:{ intro:47.99, after:57.99, promoNote:'47,99‚Ç¨/mois pendant 12 mois puis 57,99‚Ç¨/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 cha√Ænes) + 2 D√©codeurs TV 6','Jusqu\'√† 3 r√©p√©teurs Wi-Fi'],
        hint:'Couverture + confort total.'
      },
    ],

    mobileProfiles: [
      { id:'essentiel', name:'Essentiel', desc:'Usage ma√Ætris√©, Wi-Fi fr√©quent' },
      { id:'confort',  name:'Confort',  desc:'Libert√© + hotspot + vid√©o sans y penser' },
      { id:'serenite', name:'S√©r√©nit√©', desc:'Aucune contrainte, z√©ro stress data' },
    ],

    mobileOffers: [
      { id:'m2h', name:'Forfait 2h / 100 Mo', commitmentMonths:0, price:{ intro:8.99, after:null, promoNote:'Sans engagement (prix indicatif)' }, openDiscount:3,
        highlights:['Appels 2h','SMS/MMS illimit√©s','100 Mo']
      },
      { id:'m20', name:'S√©rie Sp√©ciale 20Go', commitmentMonths:0, price:{ intro:17.99, after:null, promoNote:'Sans engagement' }, openDiscount:7,
        highlights:['Appels/SMS/MMS illimit√©s','20Go en France (d√©bit r√©duit au-del√†)']
      },
      { id:'m120', name:'S√©rie Sp√©ciale 120Go 5G', commitmentMonths:0, price:{ intro:24.99, after:null, promoNote:'Promo possible (codes / p√©riodes)' }, openDiscount:5,
        highlights:['Appels/SMS/MMS illimit√©s','120Go 5G (selon conditions)']
      },
      { id:'m200', name:'Forfait 200Go 5G', commitmentMonths:24, price:{ intro:37.99, after:47.99, promoNote:'Engagement 24 mois (prix indicatif)' }, openDiscount:8,
        highlights:['Appels/SMS/MMS illimit√©s','200Go 5G (selon conditions)']
      },
      { id:'m300', name:'Forfait 300Go 5G', commitmentMonths:24, price:{ intro:44.99, after:54.99, promoNote:'Engagement 24 mois (prix indicatif)' }, openDiscount:15,
        highlights:['Gros usages','Partage de connexion intensif','Famille']
      },
      { id:'m500', name:'Forfait 500Go 5G+', commitmentMonths:24, price:{ intro:59.99, after:69.99, promoNote:'Engagement 24 mois (prix indicatif)' }, openDiscount:15,
        highlights:['Premium','Multi-appareils','Tr√®s gros usages']
      },
    ],

    options: [
      { id:'maison_protegee', name:'Maison Prot√©g√©e', when:'Maison / absences / RDC', script:'Absences + maison ‚Üí tranquillit√© d\'esprit (dissuasion + intervention).' },
      { id:'cybersecure', name:'Cybersecure', when:'Enfants / t√©l√©travail / PC pro', script:'Ce n\'est pas technique : c\'est prot√©ger la famille et les appareils.' },
      { id:'multisim', name:'Multi-SIM', when:'Montre / tablette / voiture / hotspot', script:'M√™me forfait, plusieurs appareils : montre, tablette, voiture.' },
    ]
  };

  const DEFAULT_STATE = {
    step: 0,
    mode: 'client',
    hasBox: true,
    wantsNewMobile: null,
    housing: { surface:null, type:null, floors:null, walls:null, boxPlacement:null },
    internetUsage: [],
    mobileContext: [],
    security: [],
    devices: [],
    subStep: { housing:0, internet:0, mobile:0, security:0, result:0 },
  };

  let state = null;
  let navButtons = null; // compatibilit√©: √©vite l'erreur "navButtons is not defined"

  const STEPS = [
    { key:'housing',  title:'Logement & Wi-Fi', hint:'Comprendre la couverture √† pr√©voir.' },
    { key:'internet', title:'Usages Internet', hint:'Mesurer le niveau de besoin.' },
    { key:'mobile',   title:'Usage Mobile', hint:'√âvaluer le confort attendu.' },
    { key:'security', title:'S√©curit√©', hint:'Identifier les priorit√©s de protection.' },
    { key:'result',   title:'Recommandation', hint:'Une proposition claire et assum√©e.' },
  ];

  const SUBSTEP_TOTALS = { housing:5, internet:1, mobile:4, security:1, result:1 };

  const $ = (id) => document.getElementById(id);

  function safe(id){
    const el = $(id);
    if (!el) throw new Error(`√âl√©ment introuvable: #${id}`);
    return el;
  }

  function deepClone(obj){
    try{ if (typeof structuredClone === 'function') return structuredClone(obj); } catch {}
    return JSON.parse(JSON.stringify(obj));
  }

  function clamp(n, min, max){
    return Math.max(min, Math.min(max, n));
  }

  // ---------------------------
  // Engine
  // ---------------------------
  function wifiDifficultyScore(h){
    if (h.surface == null) return 0;
    let score = 0;
    const s = Number(h.surface);
    if (s >= 50) score += 1;
    if (s > 90) score += 1;
    if (s > 130) score += 1;

    const f = Number(h.floors ?? 0);
    if (f >= 1) score += 1;
    if (f >= 2) score += 1;

    if (h.walls === 'beton') score += 1;
    if (h.boxPlacement === 'excentre') score += 1;
    if (h.boxPlacement === 'garage') score += 2;

    return Math.min(score, 8);
  }

  function recommendedRepeaters(h){
    let rep = 0;
    const s = Number(h.surface ?? 0);
    const f = Number(h.floors ?? 0);
    if (s > 90) rep += 1;
    if (f >= 1) rep += 1;
    if (h.walls === 'beton') rep += 1;
    if (h.boxPlacement === 'garage') rep += 1;
    return Math.max(0, Math.min(rep, 3));
  }

  function internetIntensity(usages){
    const u = new Set(usages);
    let points = 0;
    if (u.has('teletravail')) points += 2;
    if (u.has('gaming')) points += 2;
    if (u.has('streaming')) points += 2;
    if (u.has('famille')) points += 2;
    if (u.has('iot')) points += 1;
    if (points <= 2) return 'Faible';
    if (points <= 5) return 'Moyen';
    return '√âlev√©';
  }

  function mobileProfile(ctx){
    const c = new Set(ctx);
    let p = 0;
    if (c.has('gps')) p += 1;
    if (c.has('video')) p += 2;
    if (c.has('hotspot')) p += 2;
    if (c.has('wifi_unstable')) p += 2;
    if (c.has('zero_stress')) p += 3;
    if (p <= 2) return 'essentiel';
    if (p <= 6) return 'confort';
    return 'serenite';
  }

  function recommendBox(){
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const u = new Set(state.internetUsage);

    let tier = 3;
    if (intensity === '√âlev√©') tier = 4;

    const heavy = (u.has('teletravail') && u.has('gaming')) ||
                  (u.has('teletravail') && u.has('streaming') && u.has('famille'));
    if (heavy) tier = 4;

    if (rep >= 1) tier = Math.max(tier, 4);

    const s = Number(state.housing.surface ?? 0);
    if (intensity === 'Faible' && s > 0 && s < 50 && rep === 0) {
      return { primary:'up', alternative:'livebox' };
    }
    return { primary: tier === 4 ? 'max' : 'up', alternative: tier === 4 ? 'up' : 'livebox' };
  }

  function mobileOfferIdFromState(mobileProfileId, insights){
    const premiumIntent = state.wantsNewMobile === true;
    const premiumPotential = insights?.premiumPotential || 'medium';
    const heavyUse = mobileProfileId === 'serenite' || state.mobileContext.includes('hotspot') || state.mobileContext.includes('video');
    const multiDevice = state.devices.length >= 2;

    if (premiumIntent && (heavyUse || multiDevice || premiumPotential !== 'low')) return 'm500';
    if (premiumIntent) return 'm300';
    if (heavyUse || premiumPotential === 'high') return 'm300';
    if (mobileProfileId === 'confort') return 'm200';
    return 'm120';
  }

  function recommendOptions(){
    const opts = [];
    const sec = new Set(state.security);
    const dev = new Set(state.devices);
    const u = new Set(state.internetUsage);

    if (sec.has('absences') || sec.has('rdc') || state.housing.type === 'maison') opts.push('maison_protegee');
    if (sec.has('enfants') || sec.has('pc_pro') || u.has('teletravail')) opts.push('cybersecure');
    if (dev.has('watch') || dev.has('tablet') || dev.has('car') || new Set(state.mobileContext).has('hotspot')) opts.push('multisim');
    return [...new Set(opts)];
  }

  function buildResult(){
    const wifiScore = wifiDifficultyScore(state.housing);
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const mp = mobileProfile(state.mobileContext);
    const { primary, alternative } = recommendBox();
    const options = recommendOptions();

    const reasons = [];
    const s = Number(state.housing.surface ?? 0);
    const f = Number(state.housing.floors ?? 0);
    if (s > 90) reasons.push('Surface > 90 m¬≤ ‚Üí couverture Wi-Fi √† renforcer');
    if (f >= 1) reasons.push('Pr√©sence d\'√©tage ‚Üí Wi-Fi √† s√©curiser');
    if (state.housing.walls === 'beton') reasons.push('Murs b√©ton/pierre ‚Üí att√©nuation importante');
    if (state.housing.boxPlacement === 'garage') reasons.push('Box en local technique/garage ‚Üí propagation compliqu√©e');

    const u = new Set(state.internetUsage);
    if (u.has('teletravail')) reasons.push('T√©l√©travail/visio ‚Üí stabilit√© et upload');
    if (u.has('gaming')) reasons.push('Gaming en ligne ‚Üí stabilit√© + latence');
    if (u.has('streaming')) reasons.push('Streaming vid√©o ‚Üí d√©bit constant');
    if (u.has('famille')) reasons.push('Plusieurs utilisateurs ‚Üí capacit√© et Wi-Fi');

    const sellerAlerts = [];
    if (rep >= 1 && (primary === 'livebox' || primary === 'lite')) sellerAlerts.push('‚ö†Ô∏è Risque Wi-Fi : pr√©voir r√©p√©teur(s) ou monter en gamme (Up/Max).');
    if (u.has('teletravail')) sellerAlerts.push('üí° Script : ¬´ En visio, c\'est la stabilit√© qui fait la diff√©rence. ¬ª');
    if (mp !== 'essentiel') sellerAlerts.push('üí° Script : ¬´ Ce forfait n\'est pas pour consommer plus, c\'est pour ne jamais faire attention. ¬ª');

    return { wifiScore, rep, intensity, mobileProfile: mp, primaryBox: primary, altBox: alternative, options, reasons, sellerAlerts };
  }

  function buildLiveInsights(){
    const explicit = [];
    const implicit = [];
    const questionsToAsk = [];

    if (state.internetUsage.includes('teletravail')) explicit.push('Besoin de stabilit√© pro');
    if (state.internetUsage.includes('streaming') || state.internetUsage.includes('famille')) explicit.push('Besoin de capacit√© simultan√©e');
    if (state.mobileContext.includes('zero_stress')) explicit.push('Besoin de confort sans surveillance');
    if (state.wantsNewMobile === true) explicit.push('Projet d\'achat mobile √† optimiser');

    const rep = recommendedRepeaters(state.housing);
    if (rep >= 1 && !state.internetUsage.includes('famille')) {
      implicit.push({ need:'Couverture homog√®ne dans tout le logement', confidence:'√©lev√©e' });
      questionsToAsk.push('Qui utilise le Wi‚ÄëFi en m√™me temps √† la maison ?');
    }
    if (state.mobileContext.includes('hotspot') || state.mobileContext.includes('wifi_unstable')) {
      implicit.push({ need:'Continuit√© internet hors Wi‚ÄëFi (travail/loisirs)', confidence:'√©lev√©e' });
      questionsToAsk.push('En d√©placement, quelle g√™ne revient le plus souvent ?');
    }
    if (state.security.length === 0 && (state.housing.type === 'maison' || state.housing.floors >= 1)) {
      implicit.push({ need:'R√©assurance s√©curit√© du foyer', confidence:'moyenne' });
      questionsToAsk.push('Souhaitez-vous prot√©ger le foyer pendant vos absences ?');
    }

    const premiumPositiveSignals = [
      state.wantsNewMobile === true,
      state.mobileContext.includes('zero_stress'),
      state.mobileContext.includes('video'),
      state.mobileContext.includes('hotspot'),
      state.devices.length >= 2,
    ].filter(Boolean).length;

    const premiumPotential = premiumPositiveSignals >= 3 ? 'high' : (premiumPositiveSignals >= 2 ? 'medium' : 'low');

    if (premiumPotential === 'high') {
      implicit.push({ need:'Le client peut valoriser un forfait premium + avantages mobile', confidence:'√©lev√©e' });
      questionsToAsk.push('Un prix forfait plus √©lev√© vous g√™ne, ou si le mobile est mieux subventionn√© c‚Äôest int√©ressant ?');
    }

    return {
      explicit: [...new Set(explicit)],
      implicit,
      questionsToAsk: [...new Set(questionsToAsk)].slice(0, 3),
      premiumPotential,
    };
  }

  // ---------------------------
  // UI helpers
  // ---------------------------
  function scoreLabel(score){
    if (score <= 1) return 'Facile';
    if (score <= 3) return 'Moyen';
    if (score <= 5) return 'Difficile';
    return 'Tr√®s difficile';
  }

  function labelInternet(v){ return ({teletravail:'T√©l√©travail', gaming:'Gaming', streaming:'Streaming', famille:'Famille', iot:'Objets connect√©s'})[v] || v; }
  function labelMobile(v){ return ({gps:'GPS', video:'Vid√©os', hotspot:'Hotspot', wifi_unstable:'Wi-Fi instable', zero_stress:'Tranquillit√©'})[v] || v; }
  function labelSec(v){ return ({absences:'Absences', rdc:'RDC', enfants:'Enfants', pc_pro:'PC pro'})[v] || v; }

  function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
  }

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.padding='10px 12px';
    t.style.border='1px solid rgba(255,255,255,.14)';
    t.style.borderRadius='999px';
    t.style.background='rgba(17,24,38,.92)';
    t.style.color='var(--text)';
    t.style.boxShadow='var(--shadow)';
    t.style.zIndex='9999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, 1400);
    setTimeout(()=>t.remove(), 1800);
  }

  function euro(n){ return `${Number(n).toFixed(2).replace('.', ',')}‚Ç¨`; }

  function priceLine(o){
    if (!o?.price) return '‚Äî';
    if (o.price.after == null) return `${euro(Number(o.price.intro))}/mois`;
    return `${euro(Number(o.price.intro))}/mois (12 mois) puis ${euro(Number(o.price.after))}/mois`;
  }

  // Pack: Up/Max + forfait => -5‚Ç¨ sur la box
  function packBoxDiscount(boxOfferId, hasMobile){
    if (!hasMobile) return 0;
    return (boxOfferId === 'up' || boxOfferId === 'max') ? 5 : 0;
  }

  function priceLineWithDiscount(o, discount){
    if (!o?.price) return '‚Äî';
    const d = Number(discount || 0);
    const intro = Math.max(Number(o.price.intro) - d, 0);
    const after = (o.price.after == null) ? null : Math.max(Number(o.price.after) - d, 0);
    if (after == null) return `${euro(intro)}/mois`;
    return `${euro(intro)}/mois (12 mois) puis ${euro(after)}/mois`;
  }

  function mobilePriceWithOpen(offer){
    if (!offer?.price) return { std: NaN, open: NaN, discount: 0 };
    const std = Number(offer.price.intro);
    const d = Number(offer.openDiscount ?? 0);
    const open = Math.max(std - (state.hasBox ? d : 0), 0);
    return { std, open, discount: state.hasBox ? d : 0 };
  }

  // ---------------------------
  // Local/URL state
  // ---------------------------
  function buildShareURL(){
    const compact = {
      s: state.step, m: state.mode, bx: state.hasBox, nm: state.wantsNewMobile,
      h: state.housing, iu: state.internetUsage, mc: state.mobileContext, se: state.security, d: state.devices
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
    const u = new URL(window.location.href);
    u.searchParams.set('cfg', payload);
    return u.toString();
  }

  function loadFromURL(){
    try{
      const u = new URL(window.location.href);
      const cfg = u.searchParams.get('cfg');
      if (!cfg) return null;
      const json = decodeURIComponent(escape(atob(cfg)));
      const obj = JSON.parse(json);
      const st = deepClone(DEFAULT_STATE);
      st.step = Number(obj.s ?? 0);
      st.mode = (obj.m === 'vendeur') ? 'vendeur' : 'client';
      st.hasBox = (obj.bx === false) ? false : true;
      st.wantsNewMobile = (obj.nm === true) ? true : ((obj.nm === false) ? false : null);
      st.housing = obj.h || st.housing;
      st.internetUsage = obj.iu || [];
      st.mobileContext = obj.mc || [];
      st.security = obj.se || [];
      st.devices = obj.d || [];
      return normalizeState(st);
    } catch { return null; }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('cfg_v1_state');
      return raw ? normalizeState(JSON.parse(raw)) : null;
    } catch { return null; }
  }

  function persist(){
    localStorage.setItem('cfg_v1_state', JSON.stringify(state));
    window.history.replaceState({}, '', buildShareURL());
  }

  // ---------------------------
  // Components
  // ---------------------------
  function badge(text){
    const div = document.createElement('span');
    div.className = 'tag';
    div.textContent = text;
    return div;
  }

  function setSeg(containerId, options, selectedValue, onChange){
    const container = safe(containerId);
    container.innerHTML = '';
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'opt' + (selectedValue === opt.value ? ' selected' : '');
      btn.setAttribute('aria-pressed', selectedValue === opt.value ? 'true' : 'false');
      btn.innerHTML = `<div class="t">${opt.label}</div><div class="s">${opt.hint||''}</div>`;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); onChange(opt.value); });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); e.stopPropagation(); onChange(opt.value); }, { passive:false });
      container.appendChild(btn);
    });
  }

  function setChecks(containerId, items, selectedSet, onToggle){
    const container = safe(containerId);
    container.innerHTML = '';
    items.forEach(it => {
      const selected = selectedSet.has(it.value);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chk' + (selected ? ' selected' : '');
      btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
      btn.innerHTML = `
        <div class="box">${selected ? '‚úì' : ''}</div>
        <div>
          <div class="main">${it.label}</div>
          <div class="sub">${it.hint || ''}</div>
        </div>
      `;
      const fire = (e)=>{ e.preventDefault(); e.stopPropagation(); onToggle(it.value); };
      btn.addEventListener('click', fire);
      btn.addEventListener('touchend', fire, { passive:false });
      container.appendChild(btn);
    });
  }

  function renderStepper(){
    const el = safe('stepper');
    el.innerHTML = '';
    STEPS.forEach((s, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dot' + (i === state.step ? ' active' : (i < state.step ? ' done' : ''));
      btn.textContent = (i+1);
      btn.title = s.title;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); state.step = i; state.subStep[s.key] = 0; persist(); render(); });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); state.step = i; state.subStep[s.key] = 0; persist(); render(); }, { passive:false });
      el.appendChild(btn);
      if (i < STEPS.length-1) {
        const line = document.createElement('div');
        line.className = 'line';
        el.appendChild(line);
      }
    });
  }

  function questionCount(key){
    return SUBSTEP_TOTALS[key] || 1;
  }

  function validationMessage(stepKey, idx){
    if (stepKey === 'housing' && idx === 0 && !state.housing.type) return 'Choisissez le type de logement pour continuer.';
    if (stepKey === 'housing' && idx === 1 && state.housing.surface == null) return 'S√©lectionnez une surface approximative.';
    if (stepKey === 'housing' && idx === 2 && state.housing.floors == null) return 'Indiquez le nombre d\'√©tages.';
    if (stepKey === 'housing' && idx === 3 && !state.housing.walls) return 'Choisissez le type de murs majoritaire.';
    if (stepKey === 'housing' && idx === 4 && !state.housing.boxPlacement) return 'Pr√©cisez l\'emplacement probable de la box.';
    if (stepKey === 'internet' && state.internetUsage.length === 0) return 'S√©lectionnez au moins un usage internet.';
    if (stepKey === 'mobile' && idx === 0 && state.wantsNewMobile == null) return 'Indiquez si un achat de mobile est pr√©vu.';
    if (stepKey === 'mobile' && idx === 2 && state.mobileContext.length === 0) return 'S√©lectionnez au moins une situation mobile.';
    if (stepKey === 'security' && state.security.length === 0) return 'S√©lectionnez au moins un besoin de protection.';
    return '';
  }

  function questionNav(stepKey, total, finalLabel='Suivant'){
    const nav = document.createElement('div');
    const idx = state.subStep[stepKey] || 0;
    const isLastQuestion = idx >= total - 1;
    const message = validationMessage(stepKey, idx);
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" data-nav="prev" type="button" ${(state.step===0 && idx===0)?'disabled':''}>Retour</button>
      <button class="btn primary" data-nav="next" type="button" ${message ? 'disabled' : ''}>${isLastQuestion ? finalLabel : 'Continuer'}</button>
    `;
    if (message) nav.insertAdjacentHTML('beforeend', `<div class="btnhint">${message}</div>`);

    const prevBtn = nav.querySelector('[data-nav="prev"]');
    const nextBtn = nav.querySelector('[data-nav="next"]');

    prevBtn.onclick = () => {
      const subStepIndex = state.subStep[stepKey] || 0;
      if (subStepIndex > 0) {
        state.subStep[stepKey] = subStepIndex - 1;
      } else {
        const prevStep = Math.max(0, state.step - 1);
        state.step = prevStep;
        const prevKey = STEPS[prevStep].key;
        state.subStep[prevKey] = questionCount(prevKey) - 1;
      }
      persist(); render();
    };

    nextBtn.onclick = () => {
      if (message) return;
      const subStepIndex = state.subStep[stepKey] || 0;
      if (subStepIndex < total - 1) {
        state.subStep[stepKey] = subStepIndex + 1;
      } else {
        state.step = Math.min(STEPS.length-1, state.step+1);
        const nextKey = STEPS[state.step].key;
        state.subStep[nextKey] = 0;
      }
      persist(); render();
    };

    return nav;
  }

  function normalizeState(raw){
    const normalized = deepClone(DEFAULT_STATE);
    if (!raw || typeof raw !== 'object') return normalized;

    normalized.step = clamp(Number(raw.step ?? 0) || 0, 0, STEPS.length - 1);
    normalized.mode = raw.mode === 'vendeur' ? 'vendeur' : 'client';
    normalized.hasBox = raw.hasBox !== false;
    normalized.wantsNewMobile = (raw.wantsNewMobile === true) ? true : ((raw.wantsNewMobile === false) ? false : null);

    normalized.housing.type = ['appart','maison'].includes(raw.housing?.type) ? raw.housing.type : null;
    normalized.housing.surface = [40,70,110,150].includes(Number(raw.housing?.surface)) ? Number(raw.housing.surface) : null;
    normalized.housing.floors = [0,1,2,3].includes(Number(raw.housing?.floors)) ? Number(raw.housing.floors) : null;
    normalized.housing.walls = ['placo','beton'].includes(raw.housing?.walls) ? raw.housing.walls : null;
    normalized.housing.boxPlacement = ['central','excentre','garage','inconnu'].includes(raw.housing?.boxPlacement) ? raw.housing.boxPlacement : null;

    normalized.internetUsage = (Array.isArray(raw.internetUsage) ? raw.internetUsage : []).filter(v => ['teletravail','gaming','streaming','famille','iot'].includes(v));
    normalized.mobileContext = (Array.isArray(raw.mobileContext) ? raw.mobileContext : []).filter(v => ['gps','video','hotspot','wifi_unstable','zero_stress'].includes(v));
    normalized.security = (Array.isArray(raw.security) ? raw.security : []).filter(v => ['absences','rdc','enfants','pc_pro'].includes(v));
    normalized.devices = (Array.isArray(raw.devices) ? raw.devices : []).filter(v => ['watch','tablet','car'].includes(v));

    const rawSubStep = raw.subStep || {};
    Object.keys(SUBSTEP_TOTALS).forEach((key) => {
      normalized.subStep[key] = clamp(Number(rawSubStep[key] ?? 0) || 0, 0, questionCount(key) - 1);
    });

    return normalized;
  }

  // ---------------------------
  // Screens
  // ---------------------------
  function renderHousing(root){
    root.innerHTML = '';
    const questions = [
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Type de logement</label><div class="seg2" id="segType"></div></div>`);
        setSeg('segType', [
          { value: 'appart', label: 'Appartement', hint: '' },
          { value: 'maison', label: 'Maison', hint: '' },
        ], state.housing.type, (v)=>{ state.housing.type=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Surface approximative</label><div class="seg" id="segSurface"></div></div>`);
        setSeg('segSurface', [
          { value: 40, label: '< 50 m¬≤', hint: 'Wi-Fi souvent simple' },
          { value: 70, label: '50‚Äì90 m¬≤', hint: '√Ä surveiller selon murs' },
          { value: 110, label: '90‚Äì130 m¬≤', hint: 'R√©p√©teur souvent utile' },
          { value: 150, label: '+ 130 m¬≤', hint: 'Couverture √† s√©curiser' },
        ], state.housing.surface, (v)=>{ state.housing.surface=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>√âtages</label><div class="seg" id="segFloors"></div></div>`);
        setSeg('segFloors', [
          { value: 0, label: '0', hint: 'Plain pied / m√™me niveau' },
          { value: 1, label: '1', hint: 'Wi-Fi √† l\'√©tage' },
          { value: 2, label: '2+', hint: 'Couverture plus difficile' },
          { value: 3, label: '3+', hint: 'Cas exigeant' },
        ], state.housing.floors, (v)=>{ state.housing.floors=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Murs majoritaires</label><div class="seg2" id="segWalls"></div></div>`);
        setSeg('segWalls', [
          { value: 'placo', label: 'Placopl√¢tre', hint: 'Diffusion OK' },
          { value: 'beton', label: 'B√©ton / pierre', hint: 'Att√©nuation forte' },
        ], state.housing.walls, (v)=>{ state.housing.walls=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Emplacement de la box</label><div class="seg" id="segPlace"></div></div>`);
        setSeg('segPlace', [
          { value: 'central', label: 'Central', hint: 'Meilleur sc√©nario' },
          { value: 'excentre', label: 'Excentr√©', hint: 'Couverture √† surveiller' },
          { value: 'garage', label: 'Garage / local', hint: 'Propagation difficile' },
          { value: 'inconnu', label: 'Je ne sais pas', hint: '' },
        ], state.housing.boxPlacement, (v)=>{ state.housing.boxPlacement=v; persist(); render(); });
      },
    ];

    const idx = state.subStep.housing || 0;
    questions[Math.min(idx, questions.length - 1)]();
    root.appendChild(questionNav('housing', questions.length));
  }

  function renderInternet(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Vos usages Internet (plusieurs choix)</label><div class="checklist" id="chkInternet"></div></div>`);
    const selected = new Set(state.internetUsage);
    setChecks('chkInternet', [
      { value: 'teletravail', label: 'T√©l√©travail / visio', hint: 'Stabilit√© + upload' },
      { value: 'gaming', label: 'Gaming en ligne', hint: 'Latence + stabilit√©' },
      { value: 'streaming', label: 'Streaming vid√©o / TV 4K', hint: 'D√©bit constant' },
      { value: 'famille', label: 'Famille (3+ utilisateurs)', hint: 'Capacit√© + Wi-Fi' },
      { value: 'iot', label: 'Objets connect√©s / cam√©ras', hint: 'R√©seau toujours dispo' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.internetUsage = [...selected];
      persist(); render();
    });
    root.appendChild(questionNav('internet', 1));
  }

  function renderMobile(root){
    root.innerHTML = '';
    const questions = [
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Projet mobile</label><div class="seg2" id="segMobileProject"></div></div>`);
        setSeg('segMobileProject', [
          { value: true, label: 'Oui, achat mobile pr√©vu', hint: 'On privil√©gie un forfait avec gros avantage mobile' },
          { value: false, label: 'Non, pas de projet mobile', hint: 'On reste sur besoin data pur' },
        ], state.wantsNewMobile, (v)=>{ state.wantsNewMobile = v; persist(); render(); });
      },
      () => {
        const openCard = document.createElement('div');
        openCard.className = 'card';
        openCard.innerHTML = `
          <div class="bd">
            <div class="h2">Open</div>
            <div class="muted">Le client a une box Orange ?</div>
            <div class="sp"></div>
            <button class="btn ${state.hasBox ? 'primary' : ''}" id="btnHasBox" type="button">
              ${state.hasBox ? '‚úÖ Box Orange : OUI (Open actif)' : '‚¨ú Box Orange : NON (Open inactif)'}
            </button>
          </div>
        `;
        root.appendChild(openCard);
        setTimeout(()=>{ safe('btnHasBox').onclick = () => { state.hasBox = !state.hasBox; persist(); render(); }; });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Hors Wi‚ÄëFi, quelles situations arrivent ?</label><div class="checklist" id="chkMobile"></div></div>`);
        const selected = new Set(state.mobileContext);
        setChecks('chkMobile', [
          { value: 'gps', label: 'GPS / voiture', hint: 'Trafic temps r√©el + itin√©raires' },
          { value: 'video', label: 'Vid√©os / r√©seaux sociaux', hint: 'Vid√©o auto ‚Üí conso invisible' },
          { value: 'hotspot', label: 'Partage de connexion', hint: 'PC / tablette ‚Üí √ßa monte vite' },
          { value: 'wifi_unstable', label: 'Wi-Fi parfois indisponible', hint: 'Impr√©vus / d√©placements' },
          { value: 'zero_stress', label: 'Je veux √™tre tranquille', hint: 'Z√©ro surveillance' },
        ], selected, (v)=>{
          if (selected.has(v)) selected.delete(v); else selected.add(v);
          state.mobileContext = [...selected];
          persist(); render();
        });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Appareils concern√©s</label><div class="checklist" id="chkDevices"></div></div>`);
        const dev = new Set(state.devices);
        setChecks('chkDevices', [
          { value: 'watch', label: 'Montre connect√©e (eSIM)', hint: 'Multi-SIM pertinente' },
          { value: 'tablet', label: 'Tablette', hint: 'Multi-SIM / data d√©di√©e' },
          { value: 'car', label: 'Voiture / routeur', hint: 'Connexion embarqu√©e' },
        ], dev, (v)=>{
          if (dev.has(v)) dev.delete(v); else dev.add(v);
          state.devices = [...dev];
          persist(); render();
        });
      },
    ];

    const idx = state.subStep.mobile || 0;
    questions[Math.min(idx, questions.length - 1)]();
    root.appendChild(questionNav('mobile', questions.length));
  }

  function renderSecurity(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>√Ä prot√©ger en priorit√© (plusieurs choix)</label><div class="checklist" id="chkSec"></div></div>`);
    const selected = new Set(state.security);
    setChecks('chkSec', [
      { value: 'absences', label: 'Absences fr√©quentes', hint: 'Travail, vacances, d√©placements' },
      { value: 'rdc', label: 'RDC / acc√®s facile', hint: 'Risque per√ßu plus √©lev√©' },
      { value: 'enfants', label: 'Enfants / ados connect√©s', hint: 'Protection + contr√¥le' },
      { value: 'pc_pro', label: 'Appareils sensibles (PC pro, t√©l√©travail)', hint: 'S√©curiser l\'usage' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.security = [...selected];
      persist(); render();
    });
    root.appendChild(questionNav('security', 1, 'Voir le r√©sultat'));
  }

  function renderResult(root){
    const res = buildResult();
    const insights = buildLiveInsights();
    const primary = OFFERS.internet.find(o => o.id === res.primaryBox);
    const alt = OFFERS.internet.find(o => o.id === res.altBox);
    const mp = OFFERS.mobileProfiles.find(p => p.id === res.mobileProfile);

    // Mapping pilot√© par profil + intention d'achat mobile + signaux IA
    const mobileOfferId = mobileOfferIdFromState(res.mobileProfile, insights);
    const mOffer = OFFERS.mobileOffers.find(m => m.id === mobileOfferId);
    const hasMobile = !!mOffer;

    // Remise pack sur la box (Up/Max + forfait)
    const packDisc = packBoxDiscount(primary?.id, hasMobile);

    const opts = res.options.map(id => OFFERS.options.find(o => o.id === id)).filter(Boolean);

    root.innerHTML = '';

    const rec = document.createElement('div');
    rec.className = 'rec';
    rec.innerHTML = `
      <div class="big">Offre internet recommand√©e</div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap">
        <div>
          <div class="big" style="font-size:18px">${escapeHtml(primary.name)}</div>
          <div class="muted" style="margin-top:4px">Le meilleur choix pour ce besoin.</div>
        </div>
        <div class="price">
          ${priceLineWithDiscount(primary, packDisc)} ‚Ä¢ R√©p√©teurs: ${res.rep}
          ${packDisc ? ` <span class="muted">(Pack ‚àí${packDisc}‚Ç¨/mois)</span>` : ``}
        </div>
      </div>

      <div style="margin-top:10px; padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)">
        <div class="h2" style="margin:0 0 8px">Comparatif rapide</div>
        <div class="muted" style="margin-bottom:8px">Simple: option standard vs option recommand√©e.</div>
        <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead>
              <tr>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)"></th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(alt.name)}</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(primary.name)}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Prix</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">${priceLine(alt)}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  ${priceLineWithDiscount(primary, packDisc)}${packDisc ? ` <span class="muted">(Pack ‚àí${packDisc}‚Ç¨)</span>` : ``}
                </td>
              </tr>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Wi-Fi</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">Correct</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">Optimal</td>
              </tr>
              <tr>
                <td style="padding:10px; color:var(--muted)">R√©p√©teurs</td>
                <td style="padding:10px">‚Äî</td>
                <td style="padding:10px">${res.rep}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ul class="list">${res.reasons.slice(0,6).map(r=>`<li>${escapeHtml(r)}</li>`).join('')}</ul>

      <div class="row" style="margin-top:10px">
        ${primary.includes.map(x=>`<span class="badge"><b>Inclus</b> ${escapeHtml(x)}</span>`).join('')}
      </div>

      <div class="sp"></div>
      <div class="muted">Alternative :</div>
      <div style="margin-top:6px"><span class="badge"><b>${escapeHtml(alt.name)}</b> ‚Äî ${escapeHtml(alt.hint)} ‚Ä¢ ${priceLine(alt)}</span></div>
    `;
    root.appendChild(rec);

    // Mobile
    const mob = document.createElement('div');
    mob.className = 'card';
    mob.style.marginTop = '12px';

    let priceBadge = '<div class="badge"><b>Forfait conseill√©</b> ‚Ä¢ ‚Äî</div>';
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> ‚Ä¢ <span style="text-decoration:line-through; opacity:.7">${euro(p.std)}/mois</span> <b style="color:#ffe3d2">${euro(p.open)}/mois</b> <span class="muted">(Open ‚àí${p.discount}‚Ç¨/mois)</span></div>`;
      } else {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> ‚Ä¢ ${euro(p.std)}/mois</div>`;
      }
    }

    mob.innerHTML = `
      <div class="bd">
        <div class="h2">Mobile recommand√©</div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="badge"><b>${escapeHtml(mp.name)}</b> ‚Äî ${escapeHtml(mp.desc)}</div>
          ${priceBadge}
        </div>
        ${state.wantsNewMobile ? `<div class="badge" style="margin-top:8px"><b>Avantage mobile</b> Les forfaits 200/300/500 Go ouvrent des r√©ductions √† l'achat du mobile.</div>` : ``}
        ${state.mode === 'vendeur' ? `<ul class="list"><li>Argument cl√©: confort et s√©r√©nit√© au quotidien.</li></ul>` : ``}
        ${mOffer?.price?.promoNote ? `<div class="muted" style="margin-top:8px">Note : ${escapeHtml(mOffer.price.promoNote)}</div>` : ''}
      </div>
    `;
    root.appendChild(mob);

    // Options
    const opt = document.createElement('div');
    opt.className = 'card';
    opt.style.marginTop = '12px';
    opt.innerHTML = `
      <div class="bd">
        <div class="h2">Options utiles</div>
        ${opts.length ? opts.map(o=>`<div class="badge" style="margin:6px 0"><b>${escapeHtml(o.name)}</b> ‚Äî ${escapeHtml(o.when)}</div>`).join('') : `<div class="muted">Aucune option prioritaire.</div>`}
        ${opts.length ? `<ul class="list">${opts.map(o=>`<li>${escapeHtml(o.script)}</li>`).join('')}</ul>` : ''}
      </div>
    `;
    root.appendChild(opt);

    // Mode vendeur (seul)
    if (state.mode === 'vendeur') {
      const seller = document.createElement('div');
      seller.className = 'seller';
      seller.style.marginTop = '12px';
      seller.innerHTML = `
        <div class="big">Aide conseiller</div>
        ${res.sellerAlerts.length ? `<ul class="list" style="color:#d7fff7">${res.sellerAlerts.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<div class="muted">Alerte : aucune.</div>`}
        <div class="sp"></div>
        <div class="muted">Phrase simple: "On prend l'offre qui couvre vraiment votre besoin."</div>
      `;
      root.appendChild(seller);
    }

    // Nav
    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev" type="button">Retour</button>
      <button class="btn primary" id="btnCopy" type="button">Copier le r√©cap</button>
    `;
    root.appendChild(nav);

    setTimeout(()=>{
      safe('btnPrev').onclick = () => {
        state.step = Math.max(0, state.step-1);
        const prevKey = STEPS[state.step].key;
        state.subStep[prevKey] = questionCount(prevKey) - 1;
        persist(); render();
      };
      safe('btnCopy').onclick = () => {
        navigator.clipboard?.writeText(buildPlainTextRecap(res, primary, alt, mp, mOffer, opts, packDisc));
        toast('R√©cap copi√© dans le presse-papiers.');
      };
    });
  }

  function buildPlainTextRecap(res, primary, alt, mp, mOffer, opts, packDisc){
    const lines = [];
    lines.push('R√âCAP CONFIGURATEUR');
    lines.push('‚Äî');
    lines.push(`Mode: ${state.mode.toUpperCase()}`);
    lines.push(`Box Orange (Open): ${state.hasBox ? 'OUI' : 'NON'}`);
    lines.push(`Projet d'achat mobile: ${state.wantsNewMobile === true ? 'OUI' : (state.wantsNewMobile === false ? 'NON' : 'Non pr√©cis√©')}`);
    lines.push(`Internet conseill√©: ${primary.name} (R√©p√©teurs: ${res.rep})`);
    lines.push(`Prix: ${priceLineWithDiscount(primary, packDisc)}${packDisc ? ` (Pack ‚àí${packDisc}‚Ç¨/mois)` : ''}`);
    lines.push(`Alternative: ${alt.name} ‚Äî ${priceLine(alt)}`);
    lines.push(`Intensit√© internet: ${res.intensity}`);
    lines.push(`Profil mobile: ${mp.name} ‚Äî ${mp.desc}`);
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        lines.push(`Mobile conseill√©: ${mOffer.name} ‚Äî ${euro(p.open)}/mois (Open ‚àí${p.discount}‚Ç¨) [standard ${euro(p.std)}/mois]`);
      } else {
        lines.push(`Mobile conseill√©: ${mOffer.name} ‚Äî ${euro(p.std)}/mois`);
      }
    }
    lines.push('‚Äî');
    lines.push('Justifications:');
    res.reasons.forEach(r => lines.push(`- ${r}`));
    lines.push('‚Äî');
    lines.push(`Options sugg√©r√©es: ${opts.length ? opts.map(o=>o.name).join(', ') : 'Aucune'}`);
    if (opts.length) opts.forEach(o => lines.push(`- ${o.name}: ${o.script}`));
    if (state.mode === 'vendeur') {
      lines.push('‚Äî');
      lines.push('Mode vendeur:');
      res.sellerAlerts.forEach(a => lines.push(`- ${a}`));
    }
    lines.push('');
    return lines.join('\n');
  }

  // ---------------------------
  // Sidebar actions
  // ---------------------------
  function renderShare(){
    const row = safe('shareRow');
    row.innerHTML = '';

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Cr√©er un lien de partage';
    btn.onclick = () => {
      const url = buildShareURL();
      navigator.clipboard?.writeText(url);
      toast('Lien copi√©. Colle-le sur mobile/tablette.');
    };

    const btn2 = document.createElement('button');
    btn2.className = 'btn ghost';
    btn2.textContent = 'Ouvrir le lien';
    btn2.onclick = () => window.open(buildShareURL(), '_blank');

    row.appendChild(btn);
    row.appendChild(btn2);
  }

  // ---------------------------
  // Mode (fix principal)
  // ---------------------------
  function updateModeUI(){
    safe('btnModeClientTop').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeurTop').classList.toggle('primary', state.mode === 'vendeur');
    safe('btnModeClient').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeur').classList.toggle('primary', state.mode === 'vendeur');
  }

  function setMode(mode){
    state.mode = (mode === 'vendeur') ? 'vendeur' : 'client';
    persist();
    render();
  }

  // ---------------------------
  // Render
  // ---------------------------
  function render(){
    renderStepper();

    const step = STEPS[state.step];
    safe('screenTitle').textContent = step.title;
    safe('screenHint').textContent = step.hint;
    const questionTotal = questionCount(step.key);
    const questionIndex = state.subStep?.[step.key] ?? 0;
    safe('stepCount').textContent = `√âtape ${state.step + 1} sur ${STEPS.length} ‚Ä¢ Question ${Math.min(questionIndex + 1, questionTotal)} / ${questionTotal}`;
    const totalQuestions = Object.values(SUBSTEP_TOTALS).reduce((sum, n)=>sum+n, 0);
    const doneBefore = STEPS.slice(0, state.step).reduce((sum, s)=>sum + questionCount(s.key), 0);
    const doneCurrent = (step.key === 'result') ? 1 : Math.min(questionIndex, questionTotal);
    const progress = ((doneBefore + doneCurrent) / totalQuestions) * 100;
    safe('progressFill').style.width = `${Math.min(100, Math.max(0, progress))}%`;

    const root = safe('screen');
    if (step.key === 'housing') renderHousing(root);
    if (step.key === 'internet') renderInternet(root);
    if (step.key === 'mobile') renderMobile(root);
    if (step.key === 'security') renderSecurity(root);
    if (step.key === 'result') renderResult(root);

    const res = buildResult();
    safe('kpiWifi').textContent = scoreLabel(res.wifiScore);
    safe('kpiRep').textContent = String(res.rep);
    safe('kpiIntensity').textContent = res.intensity;
    const mp = OFFERS.mobileProfiles.find(p=>p.id===res.mobileProfile);
    safe('kpiMobile').textContent = mp ? mp.name : '‚Äî';

    const tags = safe('tags');
    tags.innerHTML = '';
    tags.appendChild(badge(state.hasBox ? 'Open: OUI' : 'Open: NON'));
    if (state.wantsNewMobile != null) tags.appendChild(badge(state.wantsNewMobile ? 'Projet mobile: OUI' : 'Projet mobile: NON'));
    if (state.housing.surface) tags.appendChild(badge(`${state.housing.surface} m¬≤`));
    if (state.housing.type) tags.appendChild(badge(state.housing.type === 'maison' ? 'Maison' : 'Appartement'));
    if (state.housing.floors != null) tags.appendChild(badge(`${state.housing.floors} √©tage(s)`));
    if (state.housing.walls) tags.appendChild(badge(state.housing.walls === 'beton' ? 'Murs b√©ton/pierre' : 'Murs placo'));
    state.internetUsage.forEach(u=>tags.appendChild(badge(`Internet: ${labelInternet(u)}`)));
    state.mobileContext.forEach(c=>tags.appendChild(badge(`Mobile: ${labelMobile(c)}`)));
    state.security.forEach(s=>tags.appendChild(badge(`S√©curit√©: ${labelSec(s)}`)));

    const feedback = safe('clientFeedback');
    const ai = buildLiveInsights();
    feedback.innerHTML = `
      <span>üì∂ Wi‚ÄëFi : <b>${scoreLabel(res.wifiScore)}</b></span>
      <span>üì° R√©p√©teurs : <b>${res.rep}</b></span>
      <span>‚ö°Ô∏è Internet : <b>${res.intensity}</b></span>
      <span>üì± Mobile : <b>${mp ? mp.name : '‚Äî'}</b></span>
      ${ai.implicit[0] ? `<span>üß† Besoin d√©tect√© : <b>${escapeHtml(ai.implicit[0].need)}</b></span>` : ''}
    `;

    const aiBox = safe('aiInsights');
    aiBox.innerHTML = `
      <div class="big">IA live</div>
      <div class="muted">Besoins exprim√©s</div>
      ${ai.explicit.length ? `<ul>${ai.explicit.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<div class="muted">Pas assez de donn√©es.</div>`}
      <div class="sp"></div>
      <div class="muted">Besoins non exprim√©s (probables)</div>
      ${ai.implicit.length ? `<ul>${ai.implicit.map(x=>`<li>${escapeHtml(x.need)} <b>(${escapeHtml(x.confidence)})</b></li>`).join('')}</ul>` : `<div class="muted">Aucun signal fort pour l'instant.</div>`}
      <div class="sp"></div>
      <div class="muted">Potentiel premium mobile: <b>${ai.premiumPotential === 'high' ? '√©lev√©' : (ai.premiumPotential === 'medium' ? 'moyen' : 'faible')}</b></div>
      ${ai.questionsToAsk.length ? `<div class="sp"></div><div class="muted">Questions √† poser</div><ul>${ai.questionsToAsk.map(q=>`<li>${escapeHtml(q)}</li>`).join('')}</ul>` : ''}
    `;

    // Sidebar cach√©e en mode client
    const side = safe('sidePanel');
    side.style.display = (state.mode === 'vendeur') ? 'grid' : 'none';

    // Debug uniquement vendeur
    const dbg = safe('stateDebug');
    if (state.mode === 'vendeur') {
      dbg.style.display = 'block';
      dbg.textContent = `state: ${JSON.stringify(state)}`;
    } else {
      dbg.style.display = 'none';
      dbg.textContent = '';
    }

    // Share utile surtout en vendeur, mais pas grave si cach√© avec sidebar
    renderShare();

    // Update mode buttons (top + sidebar)
    updateModeUI();
  }

  // ---------------------------
  // Init
  // ---------------------------
  function init(){
    state = loadFromURL() || loadLocal() || deepClone(DEFAULT_STATE);
    state = normalizeState(state);

    // Buttons sidebar
    safe('btnReset').onclick = () => { state = deepClone(DEFAULT_STATE); persist(); render(); };
    safe('btnPrint').onclick = () => window.print();
    safe('btnModeClient').onclick = () => setMode('client');
    safe('btnModeVendeur').onclick = () => setMode('vendeur');

    // Buttons TOP (fix qui te d√©bloque)
    safe('btnModeClientTop').onclick = () => setMode('client');
    safe('btnModeVendeurTop').onclick = () => setMode('vendeur');

    render();
  }

  window.addEventListener('DOMContentLoaded', () => {
    try { init(); }
    catch (e) {
      console.error(e);
      alert('Erreur JS : ' + (e?.message || e));
    }
  });
</script>
</body>
</html>
