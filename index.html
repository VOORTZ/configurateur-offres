<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurateur Offres â€” Boutique</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#93a4b8; --text:#e7eef8;
      --accent:#ff6a00; --accent2:#ff8a3d; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,106,0,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(45,212,191,.10), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* Garde-fous anti "texte noir" (Safari/iOS peut retomber sur styles par dÃ©faut) */
    table, th, td { color: var(--text); }
    b, strong { color: var(--text); }
    th { font-weight: 800; }
    .muted b, .muted strong { color: var(--text); }

    .wrap{width:100%; max-width:none; margin:0; padding:20px 24px}
    .top{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; margin:10px 0 12px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: var(--shadow)}
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px; margin-top:2px}

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px; border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:999px; color:var(--muted); font-size:13px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .modebar{display:inline-flex; gap:8px; align-items:center}
    .modebtn{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
      appearance:none; -webkit-appearance:none;
    }
    .modebtn.primary{
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      border-color: transparent;
      color:#1a120b;
    }

    .hero{
      display:grid; gap:12px; grid-template-columns: 1.6fr .4fr;
      margin-bottom:18px; align-items:center;
    }
    .hero-card{
      padding:14px 16px; border-radius:16px; border:1px solid var(--border);
      background: rgba(255,255,255,.035);
      display:flex; flex-direction:column; gap:8px;
    }
    .hero-title{font-weight:900; font-size:16px}
    .hero-sub{color:var(--muted); font-size:13px}
    .hero-kpis{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px}
    .hero-kpis span{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)
    }

    .grid{display:grid; grid-template-columns: minmax(0,1.35fr) minmax(320px,.65fr); gap:16px}
    .grid.client-mode{grid-template-columns: minmax(0,1fr)}
    .grid.client-mode > .card{width:100%}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .hero{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow: var(--shadow)
    }
    .card .hd{padding:18px 18px 0}
    .card .bd{padding:18px}
    .h1{font-size:18px; font-weight:800; margin:0}
    .h2{font-size:14px; font-weight:800; margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .sp{height:10px}
    .stepmeta{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted)}
    .progress{
      margin:10px 0 12px; width:100%; height:8px; border-radius:999px;
      background: rgba(255,255,255,.06); overflow:hidden; border:1px solid var(--border)
    }
    .progress > div{
      height:100%; border-radius:inherit;
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      transition: width .25s ease;
    }
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--border); background: rgba(255,255,255,.03);
      display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted)
    }
    .feedback span{display:inline-flex; gap:6px; align-items:center}

    .stepper{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .dot{
      width:34px; height:34px; border-radius:12px; display:grid; place-items:center;
      font-size:13px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); color:var(--muted);
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      cursor:pointer; appearance:none; -webkit-appearance:none; outline:none
    }
    .dot:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .dot.active{background: rgba(255,106,0,.16); color: #ffe6d6; border-color: rgba(255,106,0,.35)}
    .dot.done{background: rgba(45,212,191,.12); color: #d7fff7; border-color: rgba(45,212,191,.35)}
    .line{flex:1; min-width:24px; height:1px; background: var(--border)}

    .q{margin:12px 0}
    .q label{display:block; font-size:13px; color:var(--muted); margin:0 0 8px}

    .seg{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 780px){ .seg{grid-template-columns:1fr 1fr} }
    .seg2{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}

    .opt{
      position:relative; padding:12px; border-radius:14px;
      border:1px solid var(--border); background: rgba(255,255,255,.03);
      cursor:pointer; user-select:none; min-height:54px;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      width:100%; text-align:left; appearance:none; -webkit-appearance:none; outline:none
    }
    .opt:hover{border-color: rgba(255,255,255,.18)}
    .opt:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .opt .t{font-weight:800; font-size:14px; color:var(--text)}
    .opt .s{color:var(--muted); font-size:12px; margin-top:4px}
    .opt.selected{outline: 2px solid rgba(255,106,0,.35); border-color: rgba(255,106,0,.35); background: rgba(255,106,0,.08)}

    .checklist{display:grid; gap:10px}
    .chk{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px; border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px; cursor:pointer;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent;
      width:100%; text-align:left; appearance:none; -webkit-appearance:none; outline:none
    }
    .chk:focus-visible{outline:2px solid rgba(255,255,255,.22)}
    .box{width:18px; height:18px; border-radius:6px; border:1px solid var(--border); margin-top:2px; display:grid; place-items:center; color:var(--text)}
    .chk.selected .box{background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.35)}
    .chk .main{font-weight:800; font-size:14px; color:var(--text)}
    .chk .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .btnbar{display:flex; gap:10px; justify-content:space-between; margin-top:16px}
    .btn{
      padding:11px 14px; border-radius:14px; border:1px solid var(--border);
      background: rgba(255,255,255,.04); color:var(--text);
      cursor:pointer; font-weight:800; touch-action:manipulation; -webkit-tap-highlight-color: transparent
    }
    .btn:hover{border-color: rgba(255,255,255,.18)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,106,0,.95), rgba(255,138,61,.95));
      border-color: transparent;
      color:#1a120b;
    }
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btnhint{margin-top:8px; font-size:12px; color:var(--warn)}

    .side{display:grid; gap:16px}
    .kpi{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .tile{padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)}
    .tile .v{font-size:18px; font-weight:900; color:var(--text)}
    .tile .l{color:var(--muted); font-size:12px; margin-top:4px}

    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:13px; color:var(--muted)
    }
    .badge b{color:var(--text)}
    .tag{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--muted)
    }

    .rec{padding:14px; border-radius:18px; border:1px solid rgba(255,106,0,.35); background: rgba(255,106,0,.08)}
    .rec .big{font-size:16px; font-weight:900; color:var(--text)}
    .rec .price{font-weight:900; color:#ffe3d2}
    .total-hero{padding:18px; border-radius:18px; border:1px solid rgba(255,106,0,.35); background:rgba(255,106,0,.08)}
    .total-hero .day{font-size:40px; font-weight:900; line-height:1; color:#fff3e9}
    .total-hero .month{font-size:16px; font-weight:800; color:#ffd8c3}
    .toggle{display:inline-flex; gap:8px; padding:6px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.04)}
    .toggle .btn{padding:8px 12px; border-radius:999px}
    .client-simple ul{margin:8px 0 0; padding-left:18px; color:var(--muted)}
    .list{margin:10px 0 0; padding-left:18px; color:var(--muted)}
    .list li{margin:4px 0}

    .seller{padding:14px; border-radius:18px; border:1px solid rgba(45,212,191,.35); background: rgba(45,212,191,.08)}
    .seller .big{font-size:14px; font-weight:900; color:var(--text)}
    .ai{padding:12px; border-radius:14px; border:1px solid rgba(255,138,61,.35); background: rgba(255,138,61,.08)}
    .ai .big{font-size:13px; font-weight:900; color:var(--text)}
    .ai ul{margin:8px 0 0; padding-left:18px; color:var(--muted); font-size:12px}

    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px; color:var(--muted)
    }

    /* Print */
    @media print{
      body{background:white; color:#111}
      .wrap{max-width:none}
      .card{box-shadow:none}
      .btnbar, .top .pill, .side .tile, #shareRow{display:none !important}
      .grid{grid-template-columns:1fr}
      .rec, .seller{border-color:#ddd; background:#fff}
      .muted, .list, .mono{color:#444}
      table, th, td { color:#111; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Configurateur Offres â€” Boutique Orange</div>
          <div class="subtitle">Parcours simple pour recommander l'offre la plus adaptÃ©e.</div>
        </div>
      </div>

      <div class="pill" title="Sans donnÃ©es personnelles, utilisable sur tablette">
        <span>ðŸŸ </span> <span>Tablette â€¢ 5 Ã©tapes â€¢ sans donnÃ©e perso</span>
        <span style="opacity:.5">|</span>
        <div class="modebar" aria-label="Mode">
          <button class="modebtn" id="btnModeClientTop" type="button">Mode client</button>
          <button class="modebtn" id="btnModeVendeurTop" type="button">Mode vendeur</button>
        </div>
      </div>
    </div>

    <div class="hero">
      <div class="hero-card">
        <div class="hero-title">Un parcours clair en 2 minutes</div>
        <div class="hero-sub">Une question Ã  la fois, une recommandation claire Ã  la fin.</div>
        <div class="hero-kpis">
          <span>âš¡ Simple</span>
          <span>ðŸ§­ GuidÃ©</span>
          <span>ðŸ§© Efficace</span>
        </div>
      </div>
      <div class="hero-card">
        <div class="hero-title">Temps estimÃ©</div>
        <div class="hero-sub">â‰ˆ 2 minutes</div>
        <div class="hero-sub">Aucune donnÃ©e personnelle</div>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <div class="hd">
          <div class="stepper" id="stepper"></div>
          <div class="sp"></div>
          <div class="stepmeta">
            <span id="stepCount">Ã‰tape â€”</span>
            <span id="stepTip">RÃ©pondez simplement, sans rÃ©flÃ©chir longtemps</span>
          </div>
          <div class="progress"><div id="progressFill" style="width:0%"></div></div>
          <div class="h1" id="screenTitle">â€”</div>
          <div class="muted" id="screenHint" style="margin-top:6px">â€”</div>
          <div class="feedback" id="clientFeedback" aria-live="polite"></div>
        </div>
        <div class="bd" id="screen"></div>
      </div>

      <!-- Side -->
      <div class="side" id="sidePanel">
        <div class="card">
          <div class="bd">
            <div class="h2">PrÃ©visualisation (temps rÃ©el)</div>
            <div class="kpi">
              <div class="tile"><div class="v" id="kpiWifi">â€”</div><div class="l">DifficultÃ© Wi-Fi</div></div>
              <div class="tile"><div class="v" id="kpiRep">â€”</div><div class="l">RÃ©pÃ©teurs recommandÃ©s</div></div>
              <div class="tile"><div class="v" id="kpiIntensity">â€”</div><div class="l">IntensitÃ© Internet</div></div>
              <div class="tile"><div class="v" id="kpiMobile">â€”</div><div class="l">Profil Mobile</div></div>
            </div>
            <div class="sp"></div>
            <div class="row" id="tags"></div>
            <div class="sp"></div>
            <div class="ai" id="aiInsights">
              <div class="big">IA live</div>
              <div class="muted">En attente de rÃ©ponsesâ€¦</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="bd">
            <div class="h2">Actions</div>
            <div class="row" style="margin-bottom:10px">
              <button class="btn" id="btnModeClient" type="button">Mode client</button>
              <button class="btn" id="btnModeVendeur" type="button">Mode vendeur</button>
            </div>
            <div class="row" id="shareRow" style="margin-bottom:10px"></div>
            <div class="row">
              <button class="btn" id="btnReset" type="button">RÃ©initialiser</button>
              <button class="btn" id="btnPrint" type="button">Imprimer / PDF</button>
            </div>
            <div class="sp"></div>
            <div class="mono" id="stateDebug" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===========================
  // Configurateur Offres â€” Boutique
  // 1 fichier, sans dÃ©pendance
  // ===========================

  const OFFERS = {
    internet: [
      { id:'lite', name:'SÃ©rie SpÃ©ciale Livebox Lite Fibre', tier:1, commitmentMonths:12,
        price:{ intro:29.99, after:null, promoNote:null },
        includes:['Livebox 5 (Wi-Fi 5)','TV (200 chaÃ®nes) + DÃ©codeur UHD'],
        hint:'Simple, efficace â€” TV incluse.'
      },
      { id:'livebox', name:'Livebox Fibre', tier:2, commitmentMonths:12,
        price:{ intro:29.99, after:42.99, promoNote:'29,99â‚¬/mois pendant 12 mois puis 42,99â‚¬/mois' },
        includes:['Livebox S (Wi-Fi 7)','TV (200 chaÃ®nes) + DÃ©codeur TV 6'],
        hint:'Base solide Wi-Fi 7.'
      },
      { id:'up', name:'Livebox Up Fibre', tier:3, commitmentMonths:12,
        price:{ intro:39.99, after:51.99, promoNote:'39,99â‚¬/mois pendant 12 mois puis 51,99â‚¬/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 chaÃ®nes) + DÃ©codeur TV 6','1 rÃ©pÃ©teur Wi-Fi'],
        hint:'StabilitÃ© + usages intensifs.'
      },
      { id:'max', name:'Livebox Max Fibre', tier:4, commitmentMonths:12,
        price:{ intro:47.99, after:57.99, promoNote:'47,99â‚¬/mois pendant 12 mois puis 57,99â‚¬/mois' },
        includes:['Livebox 7 (Wi-Fi 7)','TV (200 chaÃ®nes) + 2 DÃ©codeurs TV 6','Jusqu\'Ã  3 rÃ©pÃ©teurs Wi-Fi'],
        hint:'Couverture + confort total.'
      },
    ],

    mobileProfiles: [
      { id:'essentiel', name:'Essentiel', desc:'Usage maÃ®trisÃ©, Wi-Fi frÃ©quent' },
      { id:'confort',  name:'Confort',  desc:'LibertÃ© + hotspot + vidÃ©o sans y penser' },
      { id:'serenite', name:'SÃ©rÃ©nitÃ©', desc:'Aucune contrainte, zÃ©ro stress data' },
    ],

    mobileOffers: [
      { id:'m2h', name:'Forfait 2h / 100 Mo', commitmentMonths:0, price:{ intro:8.99, after:null, promoNote:'Sans engagement (prix indicatif)' }, openDiscount:3,
        highlights:['Appels 2h','SMS/MMS illimitÃ©s','100 Mo']
      },
      { id:'m20', name:'SÃ©rie SpÃ©ciale 20Go', commitmentMonths:0, price:{ intro:17.99, after:null, promoNote:'Sans engagement' }, openDiscount:7,
        highlights:['Appels/SMS/MMS illimitÃ©s','20Go en France (dÃ©bit rÃ©duit au-delÃ )']
      },
      { id:'m120', name:'SÃ©rie SpÃ©ciale 120Go 5G', commitmentMonths:0, price:{ intro:24.99, after:null, promoNote:'Promo possible (codes / pÃ©riodes)' }, openDiscount:5,
        highlights:['Appels/SMS/MMS illimitÃ©s','120Go 5G (selon conditions)']
      },
      { id:'m200', name:'Forfait 200Go 5G', commitmentMonths:0, price:{ intro:47.99, after:null, promoNote:'Tarif de rÃ©fÃ©rence Orange.fr (hors remises Open/internet)' }, openDiscount:8,
        highlights:['Appels/SMS/MMS illimitÃ©s','200Go 5G (selon conditions)']
      },
      { id:'m300', name:'Forfait 300Go 5G', commitmentMonths:0, price:{ intro:67.99, after:null, promoNote:'Tarif de rÃ©fÃ©rence Orange.fr (hors remises Open/internet)' }, openDiscount:15,
        highlights:['Gros usages','Partage de connexion intensif','Famille']
      },
      { id:'m500', name:'Forfait 500Go 5G+', commitmentMonths:0, price:{ intro:84.99, after:null, promoNote:'Tarif de rÃ©fÃ©rence Orange.fr (hors remises Open/internet)' }, openDiscount:15,
        highlights:['Premium','Multi-appareils','TrÃ¨s gros usages']
      },
    ],

    handsets: [
      { id:'s25u', brand:'Samsung', name:'Galaxy S25 Ultra 5G+', upfront:279, oldPrice:479, monthly24:13.42 },
      { id:'iphone-air', brand:'Apple', name:'iPhone Air', upfront:89, oldPrice:189, monthly24:null },
      { id:'pixel10proxl', brand:'Google', name:'Pixel 10 Pro XL', upfront:39, oldPrice:169, monthly24:null },
      { id:'iphone17pro', brand:'Apple', name:'iPhone 17 Pro', upfront:429, oldPrice:null, monthly24:20.63 },
      { id:'honor-v5', brand:'HONOR', name:'Magic V5 5G+', upfront:559, oldPrice:709, monthly24:26.89 },
      { id:'xiaomi15ultra', brand:'Xiaomi', name:'15 Ultra', upfront:349, oldPrice:null, monthly24:14.54 },
      { id:'s25', brand:'Samsung', name:'Galaxy S25 5G+', upfront:5, oldPrice:null, monthly24:null },
      { id:'s25plus', brand:'Samsung', name:'Galaxy S25 Plus 5G+', upfront:29, oldPrice:179, monthly24:null },
      { id:'s25fe', brand:'Samsung', name:'Galaxy S25 FE 5G+', upfront:5, oldPrice:null, monthly24:null },
      { id:'zfold7', brand:'Samsung', name:'Galaxy Z Fold7 5G+', upfront:929, oldPrice:null, monthly24:44.68 },
      { id:'zflip7', brand:'Samsung', name:'Galaxy Z Flip7 5G+', upfront:249, oldPrice:null, monthly24:null },
      { id:'iphone16', brand:'Apple', name:'iPhone 16', upfront:5, oldPrice:19, monthly24:null },
      { id:'iphone16plus', brand:'Apple', name:'iPhone 16 Plus', upfront:79, oldPrice:129, monthly24:null },
      { id:'iphone17promax', brand:'Apple', name:'iPhone 17 Pro Max', upfront:569, oldPrice:null, monthly24:27.37 },
      { id:'iphone15pro', brand:'Apple', name:'iPhone 15 Pro', upfront:249, oldPrice:null, monthly24:null },
      { id:'pixel10pro', brand:'Google', name:'Pixel 10 Pro', upfront:5, oldPrice:39, monthly24:null },
      { id:'pixel10pfold', brand:'Google', name:'Pixel 10 Pro Fold 5G+', upfront:529, oldPrice:649, monthly24:25.44 },
      { id:'pixel9pfold', brand:'Google', name:'Pixel 9 Pro Fold', upfront:639, oldPrice:null, monthly24:30.73 },
      { id:'redmi-note15-pro5g', brand:'Xiaomi', name:'Redmi Note 15 Pro 5G', upfront:5, oldPrice:19, monthly24:null },
      { id:'redmi-note15-4g', brand:'Xiaomi', name:'Redmi Note 15 4G', upfront:5, oldPrice:null, monthly24:null },
      { id:'redmi-note15-5g', brand:'Xiaomi', name:'Redmi Note 15 5G', upfront:5, oldPrice:null, monthly24:null },
      { id:'redmi-note15proplus', brand:'Xiaomi', name:'Redmi Note 15 Pro Plus 5G', upfront:5, oldPrice:null, monthly24:null },
      { id:'honor-magic7pro', brand:'HONOR', name:'Magic7 Pro 5G+', upfront:199, oldPrice:null, monthly24:null },
      { id:'motorola-g56', brand:'Motorola', name:'Moto g56 5G', upfront:5, oldPrice:null, monthly24:null },
    ],

    options: [
      { id:'maison_protegee', name:'Maison ProtÃ©gÃ©e', when:'Maison / absences / RDC', script:'Absences + maison â†’ tranquillitÃ© d\'esprit (dissuasion + intervention).', priceMonthly:19.99 },
      { id:'cybersecure', name:'Cybersecure', when:'Enfants / tÃ©lÃ©travail / PC pro', script:'Ce n\'est pas technique : c\'est protÃ©ger la famille et les appareils.', priceMonthly:7.99 },
      { id:'multisim', name:'Multi-SIM', when:'Montre / tablette / voiture / hotspot', script:'MÃªme forfait, plusieurs appareils : montre, tablette, voiture.', priceMonthly:5.00 },
    ]
  };

  const DEFAULT_STATE = {
    step: 0,
    mode: 'client',
    hasBox: true,
    wantsNewMobile: null,
    selectedHandsetBrand: null,
    selectedHandsetId: null,
    includeOptionsInTotal: false,
    housing: { surface:null, type:null, floors:null, walls:null, boxPlacement:null },
    internetUsage: [],
    mobileContext: [],
    security: [],
    devices: [],
    subStep: { housing:0, internet:0, mobile:0, security:0, result:0 },
  };

  let state = null;
  let navButtons = null; // compatibilitÃ©: Ã©vite l'erreur "navButtons is not defined"

  const STEPS = [
    { key:'housing',  title:'Logement & Wi-Fi', hint:'Comprendre la couverture Ã  prÃ©voir.' },
    { key:'internet', title:'Usages Internet', hint:'Mesurer le niveau de besoin.' },
    { key:'mobile',   title:'Usage Mobile', hint:'Ã‰valuer le confort attendu.' },
    { key:'security', title:'SÃ©curitÃ©', hint:'Identifier les prioritÃ©s de protection.' },
    { key:'result',   title:'Recommandation', hint:'Une proposition claire et assumÃ©e.' },
  ];

  const SUBSTEP_TOTALS = { housing:5, internet:1, mobile:5, security:1, result:1 };

  const $ = (id) => document.getElementById(id);

  function safe(id){
    const el = $(id);
    if (!el) throw new Error(`Ã‰lÃ©ment introuvable: #${id}`);
    return el;
  }

  function deepClone(obj){
    try{ if (typeof structuredClone === 'function') return structuredClone(obj); } catch {}
    return JSON.parse(JSON.stringify(obj));
  }

  function clamp(n, min, max){
    return Math.max(min, Math.min(max, n));
  }

  // ---------------------------
  // Engine
  // ---------------------------
  function wifiDifficultyScore(h){
    if (h.surface == null) return 0;
    let score = 0;
    const s = Number(h.surface);
    if (s >= 50) score += 1;
    if (s > 90) score += 1;
    if (s > 130) score += 1;

    const f = Number(h.floors ?? 0);
    if (f >= 1) score += 1;
    if (f >= 2) score += 1;

    if (h.walls === 'beton') score += 1;
    if (h.boxPlacement === 'excentre') score += 1;
    if (h.boxPlacement === 'garage') score += 2;

    return Math.min(score, 8);
  }

  function recommendedRepeaters(h){
    let rep = 0;
    const s = Number(h.surface ?? 0);
    const f = Number(h.floors ?? 0);
    if (s > 90) rep += 1;
    if (f >= 1) rep += 1;
    if (h.walls === 'beton') rep += 1;
    if (h.boxPlacement === 'garage') rep += 1;
    return Math.max(0, Math.min(rep, 3));
  }

  function internetIntensity(usages){
    const u = new Set(usages);
    let points = 0;
    if (u.has('teletravail')) points += 2;
    if (u.has('gaming')) points += 2;
    if (u.has('streaming')) points += 2;
    if (u.has('famille')) points += 2;
    if (u.has('iot')) points += 1;
    if (points <= 2) return 'Faible';
    if (points <= 5) return 'Moyen';
    return 'Ã‰levÃ©';
  }

  function mobileProfile(ctx){
    const c = new Set(ctx);
    let p = 0;
    if (c.has('gps')) p += 1;
    if (c.has('video')) p += 2;
    if (c.has('hotspot')) p += 2;
    if (c.has('wifi_unstable')) p += 2;
    if (c.has('zero_stress')) p += 3;
    if (p <= 2) return 'essentiel';
    if (p <= 6) return 'confort';
    return 'serenite';
  }

  function recommendBox(){
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const u = new Set(state.internetUsage);

    let tier = 3;
    if (intensity === 'Ã‰levÃ©') tier = 4;

    const heavy = (u.has('teletravail') && u.has('gaming')) ||
                  (u.has('teletravail') && u.has('streaming') && u.has('famille'));
    if (heavy) tier = 4;

    if (rep >= 1) tier = Math.max(tier, 4);

    const s = Number(state.housing.surface ?? 0);
    if (intensity === 'Faible' && s > 0 && s < 50 && rep === 0) {
      return { primary:'up', alternative:'livebox' };
    }
    return { primary: tier === 4 ? 'max' : 'up', alternative: tier === 4 ? 'up' : 'livebox' };
  }

  function mobileOfferIdFromState(mobileProfileId, insights){
    const premiumIntent = state.wantsNewMobile === true;
    const premiumPotential = insights?.premiumPotential || 'medium';
    const heavyUse = mobileProfileId === 'serenite' || state.mobileContext.includes('hotspot') || state.mobileContext.includes('video');
    const multiDevice = state.devices.length >= 2;

    if (premiumIntent && (heavyUse || multiDevice || premiumPotential !== 'low')) return 'm500';
    if (premiumIntent) return 'm300';
    if (heavyUse || premiumPotential === 'high') return 'm300';
    if (mobileProfileId === 'confort') return 'm200';
    return 'm120';
  }

  function selectedHandset(){
    return OFFERS.handsets.find(h => h.id === state.selectedHandsetId) || null;
  }

  function handsetBrands(){
    return [...new Set(OFFERS.handsets.map(h => h.brand))].sort((a,b)=>a.localeCompare(b, 'fr'));
  }

  function recommendOptions(){
    const opts = [];
    const sec = new Set(state.security);
    const dev = new Set(state.devices);
    const u = new Set(state.internetUsage);

    if (sec.has('absences') || sec.has('rdc') || state.housing.type === 'maison') opts.push('maison_protegee');
    if (sec.has('enfants') || sec.has('pc_pro') || u.has('teletravail')) opts.push('cybersecure');
    if (dev.has('watch') || dev.has('tablet') || dev.has('car') || new Set(state.mobileContext).has('hotspot')) opts.push('multisim');
    return [...new Set(opts)];
  }

  function buildResult(){
    const wifiScore = wifiDifficultyScore(state.housing);
    const rep = recommendedRepeaters(state.housing);
    const intensity = internetIntensity(state.internetUsage);
    const mp = mobileProfile(state.mobileContext);
    const { primary, alternative } = recommendBox();
    const options = recommendOptions();

    const reasons = [];
    const s = Number(state.housing.surface ?? 0);
    const f = Number(state.housing.floors ?? 0);
    if (s > 90) reasons.push('Surface > 90 mÂ² â†’ couverture Wi-Fi Ã  renforcer');
    if (f >= 1) reasons.push('PrÃ©sence d\'Ã©tage â†’ Wi-Fi Ã  sÃ©curiser');
    if (state.housing.walls === 'beton') reasons.push('Murs bÃ©ton/pierre â†’ attÃ©nuation importante');
    if (state.housing.boxPlacement === 'garage') reasons.push('Box en local technique/garage â†’ propagation compliquÃ©e');

    const u = new Set(state.internetUsage);
    if (u.has('teletravail')) reasons.push('TÃ©lÃ©travail/visio â†’ stabilitÃ© et upload');
    if (u.has('gaming')) reasons.push('Gaming en ligne â†’ stabilitÃ© + latence');
    if (u.has('streaming')) reasons.push('Streaming vidÃ©o â†’ dÃ©bit constant');
    if (u.has('famille')) reasons.push('Plusieurs utilisateurs â†’ capacitÃ© et Wi-Fi');

    const sellerAlerts = [];
    if (rep >= 1 && (primary === 'livebox' || primary === 'lite')) sellerAlerts.push('âš ï¸ Risque Wi-Fi : prÃ©voir rÃ©pÃ©teur(s) ou monter en gamme (Up/Max).');
    if (u.has('teletravail')) sellerAlerts.push('ðŸ’¡ Script : Â« En visio, c\'est la stabilitÃ© qui fait la diffÃ©rence. Â»');
    if (mp !== 'essentiel') sellerAlerts.push('ðŸ’¡ Script : Â« Ce forfait n\'est pas pour consommer plus, c\'est pour ne jamais faire attention. Â»');

    return { wifiScore, rep, intensity, mobileProfile: mp, primaryBox: primary, altBox: alternative, options, reasons, sellerAlerts };
  }

  function buildLiveInsights(){
    const explicit = [];
    const implicit = [];
    const questionsToAsk = [];

    if (state.internetUsage.includes('teletravail')) explicit.push('Besoin de stabilitÃ© pro');
    if (state.internetUsage.includes('streaming') || state.internetUsage.includes('famille')) explicit.push('Besoin de capacitÃ© simultanÃ©e');
    if (state.mobileContext.includes('zero_stress')) explicit.push('Besoin de confort sans surveillance');
    if (state.wantsNewMobile === true) explicit.push('Projet d\'achat mobile Ã  optimiser');

    const rep = recommendedRepeaters(state.housing);
    if (rep >= 1 && !state.internetUsage.includes('famille')) {
      implicit.push({ need:'Couverture homogÃ¨ne dans tout le logement', confidence:'Ã©levÃ©e' });
      questionsToAsk.push('Qui utilise le Wiâ€‘Fi en mÃªme temps Ã  la maison ?');
    }
    if (state.mobileContext.includes('hotspot') || state.mobileContext.includes('wifi_unstable')) {
      implicit.push({ need:'ContinuitÃ© internet hors Wiâ€‘Fi (travail/loisirs)', confidence:'Ã©levÃ©e' });
      questionsToAsk.push('En dÃ©placement, quelle gÃªne revient le plus souvent ?');
    }
    if (state.security.length === 0 && (state.housing.type === 'maison' || state.housing.floors >= 1)) {
      implicit.push({ need:'RÃ©assurance sÃ©curitÃ© du foyer', confidence:'moyenne' });
      questionsToAsk.push('Souhaitez-vous protÃ©ger le foyer pendant vos absences ?');
    }

    const premiumPositiveSignals = [
      state.wantsNewMobile === true,
      state.mobileContext.includes('zero_stress'),
      state.mobileContext.includes('video'),
      state.mobileContext.includes('hotspot'),
      state.devices.length >= 2,
    ].filter(Boolean).length;

    const premiumPotential = premiumPositiveSignals >= 3 ? 'high' : (premiumPositiveSignals >= 2 ? 'medium' : 'low');

    if (premiumPotential === 'high') {
      implicit.push({ need:'Le client peut valoriser un forfait premium + avantages mobile', confidence:'Ã©levÃ©e' });
      questionsToAsk.push('Un prix forfait plus Ã©levÃ© vous gÃªne, ou si le mobile est mieux subventionnÃ© câ€™est intÃ©ressant ?');
    }

    return {
      explicit: [...new Set(explicit)],
      implicit,
      questionsToAsk: [...new Set(questionsToAsk)].slice(0, 3),
      premiumPotential,
    };
  }

  // ---------------------------
  // UI helpers
  // ---------------------------
  function scoreLabel(score){
    if (score <= 1) return 'Facile';
    if (score <= 3) return 'Moyen';
    if (score <= 5) return 'Difficile';
    return 'TrÃ¨s difficile';
  }

  function labelInternet(v){ return ({teletravail:'TÃ©lÃ©travail', gaming:'Gaming', streaming:'Streaming', famille:'Famille', iot:'Objets connectÃ©s'})[v] || v; }
  function labelMobile(v){ return ({gps:'GPS', video:'VidÃ©os', hotspot:'Hotspot', wifi_unstable:'Wi-Fi instable', zero_stress:'TranquillitÃ©'})[v] || v; }
  function labelSec(v){ return ({absences:'Absences', rdc:'RDC', enfants:'Enfants', pc_pro:'PC pro'})[v] || v; }

  function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
  }

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.padding='10px 12px';
    t.style.border='1px solid rgba(255,255,255,.14)';
    t.style.borderRadius='999px';
    t.style.background='rgba(17,24,38,.92)';
    t.style.color='var(--text)';
    t.style.boxShadow='var(--shadow)';
    t.style.zIndex='9999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; }, 1400);
    setTimeout(()=>t.remove(), 1800);
  }

  function euro(n){ return `${Number(n).toFixed(2).replace('.', ',')}â‚¬`; }

  function priceLine(o){
    if (!o?.price) return 'â€”';
    const displayed = (o.price.after == null) ? Number(o.price.intro) : Number(o.price.after);
    return `${euro(displayed)}/mois`;
  }

  // Pack: Up/Max + forfait => -5â‚¬ sur la box
  function packBoxDiscount(boxOfferId, hasMobile){
    if (!hasMobile) return 0;
    return (boxOfferId === 'up' || boxOfferId === 'max') ? 5 : 0;
  }

  function priceLineWithDiscount(o, discount){
    if (!o?.price) return 'â€”';
    const d = Number(discount || 0);
    const intro = Math.max(Number(o.price.intro) - d, 0);
    const after = (o.price.after == null) ? null : Math.max(Number(o.price.after) - d, 0);
    const displayed = (after == null) ? intro : after;
    return `${euro(displayed)}/mois`;
  }

  function priceLineBeforeAfterDiscountHTML(o, discount){
    if (!o?.price) return 'â€”';
    const d = Number(discount || 0);
    const base = (o.price.after == null) ? Number(o.price.intro) : Number(o.price.after);
    const discounted = Math.max(base - d, 0);
    if (d <= 0) return `${euro(base)}/mois`;
    return `<span style="text-decoration:line-through; opacity:.7">${euro(base)}/mois</span> <b style="color:#ffe3d2">${euro(discounted)}/mois</b> <span class="muted">(âˆ’${d}â‚¬)</span>`;
  }

  function mobilePriceWithOpen(offer){
    if (!offer?.price) return { std: NaN, open: NaN, discount: 0 };
    const std = Number(offer.price.intro);
    const d = Number(offer.openDiscount ?? 0);
    const open = Math.max(std - (state.hasBox ? d : 0), 0);
    return { std, open, discount: state.hasBox ? d : 0 };
  }

  function internetDisplayedMonthly(offer, packDisc){
    if (!offer?.price) return 0;
    const base = (offer.price.after == null) ? Number(offer.price.intro) : Number(offer.price.after);
    return Math.max(base - Number(packDisc || 0), 0);
  }

  function totalOfferMonthly(primaryOffer, mobileOffer, selectedOptions, packDisc, includeOptions){
    const internetMonthly = internetDisplayedMonthly(primaryOffer, packDisc);
    const mobilePricing = mobilePriceWithOpen(mobileOffer);
    const mobileMonthly = Number.isFinite(mobilePricing.open) ? mobilePricing.open : 0;
    const optionsMonthly = includeOptions ? selectedOptions.reduce((sum, o)=>sum + Number(o.priceMonthly || 0), 0) : 0;
    return {
      internetMonthly,
      mobileMonthly,
      optionsMonthly,
      totalMonthly: internetMonthly + mobileMonthly + optionsMonthly,
    };
  }

  function handsetDisplayedPrice(handset){
    if (!handset) return 'â€”';
    return `${euro(handset.upfront)} comptant`;
  }

  // ---------------------------
  // Local/URL state
  // ---------------------------
  function buildShareURL(){
    const compact = {
      s: state.step, m: state.mode, bx: state.hasBox, nm: state.wantsNewMobile, hb: state.selectedHandsetBrand, hm: state.selectedHandsetId, io: state.includeOptionsInTotal,
      h: state.housing, iu: state.internetUsage, mc: state.mobileContext, se: state.security, d: state.devices
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
    const u = new URL(window.location.href);
    u.searchParams.set('cfg', payload);
    return u.toString();
  }

  function loadFromURL(){
    try{
      const u = new URL(window.location.href);
      const cfg = u.searchParams.get('cfg');
      if (!cfg) return null;
      const json = decodeURIComponent(escape(atob(cfg)));
      const obj = JSON.parse(json);
      const st = deepClone(DEFAULT_STATE);
      st.step = Number(obj.s ?? 0);
      st.mode = (obj.m === 'vendeur') ? 'vendeur' : 'client';
      st.hasBox = (obj.bx === false) ? false : true;
      st.wantsNewMobile = (obj.nm === true) ? true : ((obj.nm === false) ? false : null);
      st.selectedHandsetBrand = obj.hb || null;
      st.selectedHandsetId = obj.hm || null;
      st.includeOptionsInTotal = obj.io === true;
      st.housing = obj.h || st.housing;
      st.internetUsage = obj.iu || [];
      st.mobileContext = obj.mc || [];
      st.security = obj.se || [];
      st.devices = obj.d || [];
      return normalizeState(st);
    } catch { return null; }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem('cfg_v1_state');
      return raw ? normalizeState(JSON.parse(raw)) : null;
    } catch { return null; }
  }

  function persist(){
    localStorage.setItem('cfg_v1_state', JSON.stringify(state));
    window.history.replaceState({}, '', buildShareURL());
  }

  // ---------------------------
  // Components
  // ---------------------------
  function badge(text){
    const div = document.createElement('span');
    div.className = 'tag';
    div.textContent = text;
    return div;
  }

  function setSeg(containerId, options, selectedValue, onChange){
    const container = safe(containerId);
    container.innerHTML = '';
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'opt' + (selectedValue === opt.value ? ' selected' : '');
      btn.setAttribute('aria-pressed', selectedValue === opt.value ? 'true' : 'false');
      btn.innerHTML = `<div class="t">${opt.label}</div><div class="s">${opt.hint||''}</div>`;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); onChange(opt.value); });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); e.stopPropagation(); onChange(opt.value); }, { passive:false });
      container.appendChild(btn);
    });
  }

  function setChecks(containerId, items, selectedSet, onToggle){
    const container = safe(containerId);
    container.innerHTML = '';
    items.forEach(it => {
      const selected = selectedSet.has(it.value);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chk' + (selected ? ' selected' : '');
      btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
      btn.innerHTML = `
        <div class="box">${selected ? 'âœ“' : ''}</div>
        <div>
          <div class="main">${it.label}</div>
          <div class="sub">${it.hint || ''}</div>
        </div>
      `;
      const fire = (e)=>{ e.preventDefault(); e.stopPropagation(); onToggle(it.value); };
      btn.addEventListener('click', fire);
      btn.addEventListener('touchend', fire, { passive:false });
      container.appendChild(btn);
    });
  }

  function renderStepper(){
    const el = safe('stepper');
    el.innerHTML = '';
    STEPS.forEach((s, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'dot' + (i === state.step ? ' active' : (i < state.step ? ' done' : ''));
      btn.textContent = (i+1);
      btn.title = s.title;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); state.step = i; state.subStep[s.key] = 0; persist(); render(); });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); state.step = i; state.subStep[s.key] = 0; persist(); render(); }, { passive:false });
      el.appendChild(btn);
      if (i < STEPS.length-1) {
        const line = document.createElement('div');
        line.className = 'line';
        el.appendChild(line);
      }
    });
  }

  function questionCount(key){
    return SUBSTEP_TOTALS[key] || 1;
  }

  function validationMessage(stepKey, idx){
    if (stepKey === 'housing' && idx === 0 && !state.housing.type) return 'Choisissez le type de logement pour continuer.';
    if (stepKey === 'housing' && idx === 1 && state.housing.surface == null) return 'SÃ©lectionnez une surface approximative.';
    if (stepKey === 'housing' && idx === 2 && state.housing.floors == null) return 'Indiquez le nombre d\'Ã©tages.';
    if (stepKey === 'housing' && idx === 3 && !state.housing.walls) return 'Choisissez le type de murs majoritaire.';
    if (stepKey === 'housing' && idx === 4 && !state.housing.boxPlacement) return 'PrÃ©cisez l\'emplacement probable de la box.';
    if (stepKey === 'internet' && state.internetUsage.length === 0) return 'SÃ©lectionnez au moins un usage internet.';
    if (stepKey === 'mobile' && idx === 0 && state.wantsNewMobile == null) return 'Indiquez si un achat de mobile est prÃ©vu.';
    if (stepKey === 'mobile' && idx === 2 && state.mobileContext.length === 0) return 'SÃ©lectionnez au moins une situation mobile.';
    if (stepKey === 'mobile' && idx === 4 && state.wantsNewMobile === true && !state.selectedHandsetBrand) return 'SÃ©lectionnez d\'abord la marque du mobile.';
    if (stepKey === 'mobile' && idx === 4 && state.wantsNewMobile === true && !state.selectedHandsetId) return 'SÃ©lectionnez un mobile souhaitÃ© pour finaliser le diagnostic.';
    if (stepKey === 'security' && state.security.length === 0) return 'SÃ©lectionnez au moins un besoin de protection.';
    return '';
  }

  function questionNav(stepKey, total, finalLabel='Suivant'){
    const nav = document.createElement('div');
    const idx = state.subStep[stepKey] || 0;
    const isLastQuestion = idx >= total - 1;
    const message = validationMessage(stepKey, idx);
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" data-nav="prev" type="button" ${(state.step===0 && idx===0)?'disabled':''}>Retour</button>
      <button class="btn primary" data-nav="next" type="button" ${message ? 'disabled' : ''}>${isLastQuestion ? finalLabel : 'Continuer'}</button>
    `;
    if (message) nav.insertAdjacentHTML('beforeend', `<div class="btnhint">${message}</div>`);

    const prevBtn = nav.querySelector('[data-nav="prev"]');
    const nextBtn = nav.querySelector('[data-nav="next"]');

    prevBtn.onclick = () => {
      const subStepIndex = state.subStep[stepKey] || 0;
      if (subStepIndex > 0) {
        state.subStep[stepKey] = subStepIndex - 1;
      } else {
        const prevStep = Math.max(0, state.step - 1);
        state.step = prevStep;
        const prevKey = STEPS[prevStep].key;
        state.subStep[prevKey] = questionCount(prevKey) - 1;
      }
      persist(); render();
    };

    nextBtn.onclick = () => {
      if (message) return;
      const subStepIndex = state.subStep[stepKey] || 0;
      if (subStepIndex < total - 1) {
        state.subStep[stepKey] = subStepIndex + 1;
      } else {
        state.step = Math.min(STEPS.length-1, state.step+1);
        const nextKey = STEPS[state.step].key;
        state.subStep[nextKey] = 0;
      }
      persist(); render();
    };

    return nav;
  }

  function normalizeState(raw){
    const normalized = deepClone(DEFAULT_STATE);
    if (!raw || typeof raw !== 'object') return normalized;

    normalized.step = clamp(Number(raw.step ?? 0) || 0, 0, STEPS.length - 1);
    normalized.mode = raw.mode === 'vendeur' ? 'vendeur' : 'client';
    normalized.hasBox = raw.hasBox !== false;
    normalized.wantsNewMobile = (raw.wantsNewMobile === true) ? true : ((raw.wantsNewMobile === false) ? false : null);
    normalized.selectedHandsetBrand = handsetBrands().includes(raw.selectedHandsetBrand) ? raw.selectedHandsetBrand : null;
    normalized.selectedHandsetId = OFFERS.handsets.some(h=>h.id === raw.selectedHandsetId) ? raw.selectedHandsetId : null;
    normalized.includeOptionsInTotal = raw.includeOptionsInTotal === true;
    if (normalized.selectedHandsetId) {
      const handset = OFFERS.handsets.find(h=>h.id===normalized.selectedHandsetId);
      normalized.selectedHandsetBrand = handset?.brand || normalized.selectedHandsetBrand;
    }

    normalized.housing.type = ['appart','maison'].includes(raw.housing?.type) ? raw.housing.type : null;
    normalized.housing.surface = [40,70,110,150].includes(Number(raw.housing?.surface)) ? Number(raw.housing.surface) : null;
    normalized.housing.floors = [0,1,2,3].includes(Number(raw.housing?.floors)) ? Number(raw.housing.floors) : null;
    normalized.housing.walls = ['placo','beton'].includes(raw.housing?.walls) ? raw.housing.walls : null;
    normalized.housing.boxPlacement = ['central','excentre','garage','inconnu'].includes(raw.housing?.boxPlacement) ? raw.housing.boxPlacement : null;

    normalized.internetUsage = (Array.isArray(raw.internetUsage) ? raw.internetUsage : []).filter(v => ['teletravail','gaming','streaming','famille','iot'].includes(v));
    normalized.mobileContext = (Array.isArray(raw.mobileContext) ? raw.mobileContext : []).filter(v => ['gps','video','hotspot','wifi_unstable','zero_stress'].includes(v));
    normalized.security = (Array.isArray(raw.security) ? raw.security : []).filter(v => ['absences','rdc','enfants','pc_pro'].includes(v));
    normalized.devices = (Array.isArray(raw.devices) ? raw.devices : []).filter(v => ['watch','tablet','car'].includes(v));

    const rawSubStep = raw.subStep || {};
    Object.keys(SUBSTEP_TOTALS).forEach((key) => {
      normalized.subStep[key] = clamp(Number(rawSubStep[key] ?? 0) || 0, 0, questionCount(key) - 1);
    });

    return normalized;
  }

  // ---------------------------
  // Screens
  // ---------------------------
  function renderHousing(root){
    root.innerHTML = '';
    const questions = [
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Type de logement</label><div class="seg2" id="segType"></div></div>`);
        setSeg('segType', [
          { value: 'appart', label: 'Appartement', hint: '' },
          { value: 'maison', label: 'Maison', hint: '' },
        ], state.housing.type, (v)=>{ state.housing.type=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Surface approximative</label><div class="seg" id="segSurface"></div></div>`);
        setSeg('segSurface', [
          { value: 40, label: '< 50 mÂ²', hint: 'Wi-Fi souvent simple' },
          { value: 70, label: '50â€“90 mÂ²', hint: 'Ã€ surveiller selon murs' },
          { value: 110, label: '90â€“130 mÂ²', hint: 'RÃ©pÃ©teur souvent utile' },
          { value: 150, label: '+ 130 mÂ²', hint: 'Couverture Ã  sÃ©curiser' },
        ], state.housing.surface, (v)=>{ state.housing.surface=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Ã‰tages</label><div class="seg" id="segFloors"></div></div>`);
        setSeg('segFloors', [
          { value: 0, label: '0', hint: 'Plain pied / mÃªme niveau' },
          { value: 1, label: '1', hint: 'Wi-Fi Ã  l\'Ã©tage' },
          { value: 2, label: '2+', hint: 'Couverture plus difficile' },
          { value: 3, label: '3+', hint: 'Cas exigeant' },
        ], state.housing.floors, (v)=>{ state.housing.floors=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Murs majoritaires</label><div class="seg2" id="segWalls"></div></div>`);
        setSeg('segWalls', [
          { value: 'placo', label: 'PlacoplÃ¢tre', hint: 'Diffusion OK' },
          { value: 'beton', label: 'BÃ©ton / pierre', hint: 'AttÃ©nuation forte' },
        ], state.housing.walls, (v)=>{ state.housing.walls=v; persist(); render(); });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Emplacement de la box</label><div class="seg" id="segPlace"></div></div>`);
        setSeg('segPlace', [
          { value: 'central', label: 'Central', hint: 'Meilleur scÃ©nario' },
          { value: 'excentre', label: 'ExcentrÃ©', hint: 'Couverture Ã  surveiller' },
          { value: 'garage', label: 'Garage / local', hint: 'Propagation difficile' },
          { value: 'inconnu', label: 'Je ne sais pas', hint: '' },
        ], state.housing.boxPlacement, (v)=>{ state.housing.boxPlacement=v; persist(); render(); });
      },
    ];

    const idx = state.subStep.housing || 0;
    questions[Math.min(idx, questions.length - 1)]();
    root.appendChild(questionNav('housing', questions.length));
  }

  function renderInternet(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Vos usages Internet (plusieurs choix)</label><div class="checklist" id="chkInternet"></div></div>`);
    const selected = new Set(state.internetUsage);
    setChecks('chkInternet', [
      { value: 'teletravail', label: 'TÃ©lÃ©travail / visio', hint: 'StabilitÃ© + upload' },
      { value: 'gaming', label: 'Gaming en ligne', hint: 'Latence + stabilitÃ©' },
      { value: 'streaming', label: 'Streaming vidÃ©o / TV 4K', hint: 'DÃ©bit constant' },
      { value: 'famille', label: 'Famille (3+ utilisateurs)', hint: 'CapacitÃ© + Wi-Fi' },
      { value: 'iot', label: 'Objets connectÃ©s / camÃ©ras', hint: 'RÃ©seau toujours dispo' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.internetUsage = [...selected];
      persist(); render();
    });
    root.appendChild(questionNav('internet', 1));
  }

  function renderMobile(root){
    root.innerHTML = '';
    const questions = [
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Projet mobile</label><div class="seg2" id="segMobileProject"></div></div>`);
        setSeg('segMobileProject', [
          { value: true, label: 'Oui, achat mobile prÃ©vu', hint: 'On privilÃ©gie un forfait avec gros avantage mobile' },
          { value: false, label: 'Non, pas de projet mobile', hint: 'On reste sur besoin data pur' },
        ], state.wantsNewMobile, (v)=>{ state.wantsNewMobile = v; if (v !== true) { state.selectedHandsetBrand = null; state.selectedHandsetId = null; } persist(); render(); });
      },
      () => {
        const openCard = document.createElement('div');
        openCard.className = 'card';
        openCard.innerHTML = `
          <div class="bd">
            <div class="h2">Open</div>
            <div class="muted">Le client a une box Orange ?</div>
            <div class="sp"></div>
            <button class="btn ${state.hasBox ? 'primary' : ''}" id="btnHasBox" type="button">
              ${state.hasBox ? 'âœ… Box Orange : OUI (Open actif)' : 'â¬œ Box Orange : NON (Open inactif)'}
            </button>
          </div>
        `;
        root.appendChild(openCard);
        setTimeout(()=>{ safe('btnHasBox').onclick = () => { state.hasBox = !state.hasBox; persist(); render(); }; });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Hors Wiâ€‘Fi, quelles situations arrivent ?</label><div class="checklist" id="chkMobile"></div></div>`);
        const selected = new Set(state.mobileContext);
        setChecks('chkMobile', [
          { value: 'gps', label: 'GPS / voiture', hint: 'Trafic temps rÃ©el + itinÃ©raires' },
          { value: 'video', label: 'VidÃ©os / rÃ©seaux sociaux', hint: 'VidÃ©o auto â†’ conso invisible' },
          { value: 'hotspot', label: 'Partage de connexion', hint: 'PC / tablette â†’ Ã§a monte vite' },
          { value: 'wifi_unstable', label: 'Wi-Fi parfois indisponible', hint: 'ImprÃ©vus / dÃ©placements' },
          { value: 'zero_stress', label: 'Je veux Ãªtre tranquille', hint: 'ZÃ©ro surveillance' },
        ], selected, (v)=>{
          if (selected.has(v)) selected.delete(v); else selected.add(v);
          state.mobileContext = [...selected];
          persist(); render();
        });
      },
      () => {
        root.insertAdjacentHTML('beforeend', `<div class="q"><label>Appareils concernÃ©s</label><div class="checklist" id="chkDevices"></div></div>`);
        const dev = new Set(state.devices);
        setChecks('chkDevices', [
          { value: 'watch', label: 'Montre connectÃ©e (eSIM)', hint: 'Multi-SIM pertinente' },
          { value: 'tablet', label: 'Tablette', hint: 'Multi-SIM / data dÃ©diÃ©e' },
          { value: 'car', label: 'Voiture / routeur', hint: 'Connexion embarquÃ©e' },
        ], dev, (v)=>{
          if (dev.has(v)) dev.delete(v); else dev.add(v);
          state.devices = [...dev];
          persist(); render();
        });
      },
      () => {
        if (state.wantsNewMobile !== true) {
          root.insertAdjacentHTML('beforeend', `<div class="q"><label>Mobile souhaitÃ©</label><div class="muted">Pas d'achat mobile prÃ©vu.</div></div>`);
          state.selectedHandsetBrand = null;
          state.selectedHandsetId = null;
          return;
        }

        root.insertAdjacentHTML('beforeend', `
          <div class="q"><label>Marque souhaitÃ©e</label><div class="seg2" id="segHandsetBrand"></div></div>
          <div class="q"><label>ModÃ¨le souhaitÃ© (Orange.fr)</label><div class="checklist" id="chkHandsets"></div></div>
        `);

        const brands = handsetBrands().map(b => ({ value:b, label:b, hint:'' }));
        setSeg('segHandsetBrand', brands, state.selectedHandsetBrand, (brand)=>{
          state.selectedHandsetBrand = brand;
          const selected = OFFERS.handsets.find(h=>h.id===state.selectedHandsetId);
          if (!selected || selected.brand !== brand) state.selectedHandsetId = null;
          persist(); render();
        });

        const visibleHandsets = state.selectedHandsetBrand
          ? OFFERS.handsets.filter(h=>h.brand===state.selectedHandsetBrand)
          : [];

        if (!state.selectedHandsetBrand) {
          safe('chkHandsets').innerHTML = '<div class="muted">SÃ©lectionnez une marque pour voir les modÃ¨les.</div>';
          return;
        }

        const selected = state.selectedHandsetId;
        const items = visibleHandsets.map(h => ({
          value: h.id,
          label: `${h.brand} ${h.name}`,
          hint: 'Prix affichÃ© au rÃ©capitulatif selon l\'offre proposÃ©e',
        }));
        const selectedSet = new Set(selected ? [selected] : []);
        setChecks('chkHandsets', items, selectedSet, (v)=>{
          state.selectedHandsetId = (state.selectedHandsetId === v) ? null : v;
          persist(); render();
        });
      },
    ];

    const idx = state.subStep.mobile || 0;
    questions[Math.min(idx, questions.length - 1)]();
    root.appendChild(questionNav('mobile', questions.length));
  }

  function renderSecurity(root){
    root.innerHTML = '';
    root.insertAdjacentHTML('beforeend', `<div class="q"><label>Ã€ protÃ©ger en prioritÃ© (plusieurs choix)</label><div class="checklist" id="chkSec"></div></div>`);
    const selected = new Set(state.security);
    setChecks('chkSec', [
      { value: 'absences', label: 'Absences frÃ©quentes', hint: 'Travail, vacances, dÃ©placements' },
      { value: 'rdc', label: 'RDC / accÃ¨s facile', hint: 'Risque perÃ§u plus Ã©levÃ©' },
      { value: 'enfants', label: 'Enfants / ados connectÃ©s', hint: 'Protection + contrÃ´le' },
      { value: 'pc_pro', label: 'Appareils sensibles (PC pro, tÃ©lÃ©travail)', hint: 'SÃ©curiser l\'usage' },
    ], selected, (v)=>{
      if (selected.has(v)) selected.delete(v); else selected.add(v);
      state.security = [...selected];
      persist(); render();
    });
    root.appendChild(questionNav('security', 1, 'Voir le rÃ©sultat'));
  }

  function renderResult(root){
    const res = buildResult();
    const insights = buildLiveInsights();
    const primary = OFFERS.internet.find(o => o.id === res.primaryBox);
    const alt = OFFERS.internet.find(o => o.id === res.altBox);
    const mp = OFFERS.mobileProfiles.find(p => p.id === res.mobileProfile);
    const handset = selectedHandset();

    // Mapping pilotÃ© par profil + intention d'achat mobile + signaux IA
    const mobileOfferId = mobileOfferIdFromState(res.mobileProfile, insights);
    const mOffer = OFFERS.mobileOffers.find(m => m.id === mobileOfferId);
    const hasMobile = !!mOffer;

    // Remise pack sur la box (Up/Max + forfait)
    const packDisc = packBoxDiscount(primary?.id, hasMobile);

    const opts = res.options.map(id => OFFERS.options.find(o => o.id === id)).filter(Boolean);
    const totals = totalOfferMonthly(primary, mOffer, opts, packDisc, state.includeOptionsInTotal);
    const totalDay = totals.totalMonthly / 31;

    root.innerHTML = '';

    const totalCard = document.createElement('div');
    totalCard.className = 'card';
    totalCard.innerHTML = `
      <div class="bd total-hero">
        <div class="h2">Budget total</div>
        <div class="day">${euro(totalDay)} / jour</div>
        <div class="month">${euro(totals.totalMonthly)} / mois</div>
        <div class="sp"></div>
        <div class="toggle" role="group" aria-label="Calcul du total">
          <button type="button" class="btn ${state.includeOptionsInTotal ? 'primary' : ''}" data-total-mode="with-options">Avec options</button>
          <button type="button" class="btn ${!state.includeOptionsInTotal ? 'primary' : ''}" data-total-mode="without-options">Sans options</button>
        </div>
      </div>
    `;
    root.appendChild(totalCard);

    totalCard.querySelector('[data-total-mode="with-options"]').onclick = () => {
      state.includeOptionsInTotal = true;
      persist(); render();
    };
    totalCard.querySelector('[data-total-mode="without-options"]').onclick = () => {
      state.includeOptionsInTotal = false;
      persist(); render();
    };

    if (state.mode === 'client') {
      let mobileLine = 'Forfait mobile Ã  valider en boutique';
      if (mOffer) {
        const p = mobilePriceWithOpen(mOffer);
        mobileLine = `${escapeHtml(mOffer.name)} â€¢ ${euro(state.hasBox && p.discount > 0 ? p.open : p.std)}/mois`;
      }

      const simple = document.createElement('div');
      simple.className = 'rec client-simple';
      simple.style.marginTop = '12px';
      simple.innerHTML = `
        <div class="big">Votre offre recommandÃ©e</div>
        <ul>
          <li><b>Internet :</b> ${escapeHtml(primary.name)} (${priceLineWithDiscount(primary, packDisc)})</li>
          <li><b>Mobile :</b> ${mobileLine}</li>
          ${handset ? `<li><b>TÃ©lÃ©phone choisi :</b> ${escapeHtml(handset.brand)} ${escapeHtml(handset.name)} (${handsetDisplayedPrice(handset)})</li>` : ''}
        </ul>
      `;
      root.appendChild(simple);

      const navClient = document.createElement('div');
      navClient.className = 'btnbar';
      navClient.innerHTML = `
        <button class="btn" id="btnPrev" type="button">Retour</button>
        <button class="btn primary" id="btnCopy" type="button">Copier le rÃ©cap</button>
      `;
      root.appendChild(navClient);

      setTimeout(()=>{
        safe('btnPrev').onclick = () => {
          state.step = Math.max(0, state.step-1);
          const prevKey = STEPS[state.step].key;
          state.subStep[prevKey] = questionCount(prevKey) - 1;
          persist(); render();
        };
        safe('btnCopy').onclick = () => {
          navigator.clipboard?.writeText(buildPlainTextRecap(res, primary, alt, mp, mOffer, opts, packDisc, state.includeOptionsInTotal));
          toast('RÃ©cap copiÃ© dans le presse-papiers.');
        };
      });

      return;
    }

    const rec = document.createElement('div');
    rec.className = 'rec';
    rec.style.marginTop = '12px';
    rec.innerHTML = `
      <div class="big">Offre internet recommandÃ©e</div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:8px; flex-wrap:wrap">
        <div>
          <div class="big" style="font-size:18px">${escapeHtml(primary.name)}</div>
          <div class="muted" style="margin-top:4px">Le meilleur choix pour ce besoin.</div>
        </div>
        <div class="price">
          ${priceLineBeforeAfterDiscountHTML(primary, packDisc)} â€¢ RÃ©pÃ©teurs: ${res.rep}
        </div>
      </div>

      <div style="margin-top:10px; padding:12px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,.03)">
        <div class="h2" style="margin:0 0 8px">Comparatif rapide</div>
        <div class="muted" style="margin-bottom:8px">Simple: option standard vs option recommandÃ©e.</div>
        <div style="overflow:auto">
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead>
              <tr>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)"></th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(alt.name)}</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border)">${escapeHtml(primary.name)}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Prix</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">${priceLine(alt)}</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">
                  ${priceLineBeforeAfterDiscountHTML(primary, packDisc)}
                </td>
              </tr>
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--border); color:var(--muted)">Wi-Fi</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">Correct</td>
                <td style="padding:10px; border-bottom:1px solid var(--border)">Optimal</td>
              </tr>
              <tr>
                <td style="padding:10px; color:var(--muted)">RÃ©pÃ©teurs</td>
                <td style="padding:10px">â€”</td>
                <td style="padding:10px">${res.rep}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ul class="list">${res.reasons.slice(0,6).map(r=>`<li>${escapeHtml(r)}</li>`).join('')}</ul>

      <div class="row" style="margin-top:10px">
        ${primary.includes.map(x=>`<span class="badge"><b>Inclus</b> ${escapeHtml(x)}</span>`).join('')}
      </div>

      <div class="sp"></div>
      <div class="muted">Alternative :</div>
      <div style="margin-top:6px"><span class="badge"><b>${escapeHtml(alt.name)}</b> â€” ${escapeHtml(alt.hint)} â€¢ ${priceLine(alt)}</span></div>
    `;
    root.appendChild(rec);

    // Mobile
    const mob = document.createElement('div');
    mob.className = 'card';
    mob.style.marginTop = '12px';

    let priceBadge = '<div class="badge"><b>Forfait conseillÃ©</b> â€¢ â€”</div>';
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> â€¢ <span style="text-decoration:line-through; opacity:.7">${euro(p.std)}/mois</span> <b style="color:#ffe3d2">${euro(p.open)}/mois</b> <span class="muted">(Open âˆ’${p.discount}â‚¬/mois)</span></div>`;
      } else {
        priceBadge = `<div class="badge"><b>${escapeHtml(mOffer.name)}</b> â€¢ ${euro(p.std)}/mois</div>`;
      }
    }

    mob.innerHTML = `
      <div class="bd">
        <div class="h2">Mobile recommandÃ©</div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="badge"><b>${escapeHtml(mp.name)}</b> â€” ${escapeHtml(mp.desc)}</div>
          ${priceBadge}
        </div>
        ${handset ? `<div class="badge" style="margin-top:8px"><b>Mobile choisi</b> ${escapeHtml(handset.brand)} ${escapeHtml(handset.name)} â€¢ Prix proposÃ© avec ce forfait : ${handsetDisplayedPrice(handset)}${handset.oldPrice ? ` <span class="muted">(au lieu de ${euro(handset.oldPrice)})</span>` : ''}</div>` : ''}
        ${state.wantsNewMobile ? `<div class="badge" style="margin-top:8px"><b>Avantage mobile</b> Les forfaits 200/300/500 Go ouvrent des rÃ©ductions Ã  l'achat du mobile.</div>` : ``}
        ${state.mode === 'vendeur' ? `<ul class="list"><li>Argument clÃ©: confort et sÃ©rÃ©nitÃ© au quotidien.</li></ul>` : ``}
        ${(state.mode === 'vendeur' && mOffer?.price?.promoNote) ? `<div class="muted" style="margin-top:8px">Note vendeur : ${escapeHtml(mOffer.price.promoNote)}</div>` : ''}
      </div>
    `;
    root.appendChild(mob);

    // Options
    const opt = document.createElement('div');
    opt.className = 'card';
    opt.style.marginTop = '12px';
    opt.innerHTML = `
      <div class="bd">
        <div class="h2">Options utiles</div>
        ${opts.length ? opts.map(o=>`<div class="badge" style="margin:6px 0"><b>${escapeHtml(o.name)}</b> â€” ${escapeHtml(o.when)}${o.priceMonthly ? ` â€¢ +${euro(o.priceMonthly)}/mois` : ''}</div>`).join('') : `<div class="muted">Aucune option prioritaire.</div>`}
        ${opts.length ? `<ul class="list">${opts.map(o=>`<li>${escapeHtml(o.script)}</li>`).join('')}</ul>` : ''}
      </div>
    `;
    root.appendChild(opt);

    // Mode vendeur (seul)
    if (state.mode === 'vendeur') {
      const seller = document.createElement('div');
      seller.className = 'seller';
      seller.style.marginTop = '12px';
      seller.innerHTML = `
        <div class="big">Aide conseiller</div>
        ${res.sellerAlerts.length ? `<ul class="list" style="color:#d7fff7">${res.sellerAlerts.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<div class="muted">Alerte : aucune.</div>`}
        <div class="sp"></div>
        <div class="muted">Phrase simple: "On prend l'offre qui couvre vraiment votre besoin."</div>
      `;
      root.appendChild(seller);
    }

    // Nav
    const nav = document.createElement('div');
    nav.className = 'btnbar';
    nav.innerHTML = `
      <button class="btn" id="btnPrev" type="button">Retour</button>
      <button class="btn primary" id="btnCopy" type="button">Copier le rÃ©cap</button>
    `;
    root.appendChild(nav);

    setTimeout(()=>{
      safe('btnPrev').onclick = () => {
        state.step = Math.max(0, state.step-1);
        const prevKey = STEPS[state.step].key;
        state.subStep[prevKey] = questionCount(prevKey) - 1;
        persist(); render();
      };
      safe('btnCopy').onclick = () => {
        navigator.clipboard?.writeText(buildPlainTextRecap(res, primary, alt, mp, mOffer, opts, packDisc, state.includeOptionsInTotal));
        toast('RÃ©cap copiÃ© dans le presse-papiers.');
      };
    });
  }

  function buildPlainTextRecap(res, primary, alt, mp, mOffer, opts, packDisc, includeOptionsInTotal){
    const lines = [];
    const handset = selectedHandset();
    const totals = totalOfferMonthly(primary, mOffer, opts, packDisc, includeOptionsInTotal);
    lines.push('RÃ‰CAP CONFIGURATEUR');
    lines.push('â€”');
    lines.push(`Mode: ${state.mode.toUpperCase()}`);
    lines.push(`Box Orange (Open): ${state.hasBox ? 'OUI' : 'NON'}`);
    lines.push(`Projet d'achat mobile: ${state.wantsNewMobile === true ? 'OUI' : (state.wantsNewMobile === false ? 'NON' : 'Non prÃ©cisÃ©')}`);
    lines.push(`Internet conseillÃ©: ${primary.name} (RÃ©pÃ©teurs: ${res.rep})`);
    if (packDisc > 0) {
      const base = (primary?.price?.after == null) ? Number(primary?.price?.intro || 0) : Number(primary?.price?.after || 0);
      const discounted = Math.max(base - packDisc, 0);
      lines.push(`Prix: ${euro(base)}/mois â†’ ${euro(discounted)}/mois (Pack âˆ’${packDisc}â‚¬/mois)`);
    } else {
      lines.push(`Prix: ${priceLineWithDiscount(primary, packDisc)}`);
    }
    lines.push(`Alternative: ${alt.name} â€” ${priceLine(alt)}`);
    lines.push(`IntensitÃ© internet: ${res.intensity}`);
    lines.push(`Profil mobile: ${mp.name} â€” ${mp.desc}`);
    lines.push(`Budget total estimÃ©: ${euro(totals.totalMonthly)}/mois (soit ${euro(totals.totalMonthly/31)}/jour)${includeOptionsInTotal ? ' avec options' : ' sans options'}`);
    if (handset) lines.push(`Mobile choisi: ${handset.brand} ${handset.name} â€” ${handsetDisplayedPrice(handset)}${handset.oldPrice ? ` (au lieu de ${euro(handset.oldPrice)})` : ''}`);
    if (mOffer) {
      const p = mobilePriceWithOpen(mOffer);
      if (state.hasBox && p.discount > 0) {
        lines.push(`Mobile conseillÃ©: ${mOffer.name} â€” ${euro(p.open)}/mois (Open âˆ’${p.discount}â‚¬) [standard ${euro(p.std)}/mois]`);
      } else {
        lines.push(`Mobile conseillÃ©: ${mOffer.name} â€” ${euro(p.std)}/mois`);
      }
    }
    lines.push('â€”');
    lines.push('Justifications:');
    res.reasons.forEach(r => lines.push(`- ${r}`));
    lines.push('â€”');
    lines.push(`Options suggÃ©rÃ©es: ${opts.length ? opts.map(o=>o.name).join(', ') : 'Aucune'}`);
    if (opts.length) opts.forEach(o => lines.push(`- ${o.name}: ${o.script}`));
    if (state.mode === 'vendeur') {
      lines.push('â€”');
      lines.push('Mode vendeur:');
      res.sellerAlerts.forEach(a => lines.push(`- ${a}`));
    }
    lines.push('');
    return lines.join('\n');
  }

  // ---------------------------
  // Sidebar actions
  // ---------------------------
  function renderShare(){
    const row = safe('shareRow');
    row.innerHTML = '';

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'CrÃ©er un lien de partage';
    btn.onclick = () => {
      const url = buildShareURL();
      navigator.clipboard?.writeText(url);
      toast('Lien copiÃ©. Colle-le sur mobile/tablette.');
    };

    const btn2 = document.createElement('button');
    btn2.className = 'btn ghost';
    btn2.textContent = 'Ouvrir le lien';
    btn2.onclick = () => window.open(buildShareURL(), '_blank');

    row.appendChild(btn);
    row.appendChild(btn2);
  }

  // ---------------------------
  // Mode (fix principal)
  // ---------------------------
  function updateModeUI(){
    safe('btnModeClientTop').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeurTop').classList.toggle('primary', state.mode === 'vendeur');
    safe('btnModeClient').classList.toggle('primary', state.mode === 'client');
    safe('btnModeVendeur').classList.toggle('primary', state.mode === 'vendeur');
  }

  function setMode(mode){
    state.mode = (mode === 'vendeur') ? 'vendeur' : 'client';
    persist();
    render();
  }

  // ---------------------------
  // Render
  // ---------------------------
  function render(){
    renderStepper();

    const step = STEPS[state.step];
    safe('screenTitle').textContent = step.title;
    safe('screenHint').textContent = (state.mode === 'vendeur') ? step.hint : '';
    const questionTotal = questionCount(step.key);
    const questionIndex = state.subStep?.[step.key] ?? 0;
    safe('stepCount').textContent = `Ã‰tape ${state.step + 1} sur ${STEPS.length} â€¢ Question ${Math.min(questionIndex + 1, questionTotal)} / ${questionTotal}`;
    safe('stepTip').textContent = (state.mode === 'vendeur')
      ? 'RÃ©pondez simplement, sans rÃ©flÃ©chir longtemps'
      : 'RÃ©pondez simplement';
    const totalQuestions = Object.values(SUBSTEP_TOTALS).reduce((sum, n)=>sum+n, 0);
    const doneBefore = STEPS.slice(0, state.step).reduce((sum, s)=>sum + questionCount(s.key), 0);
    const doneCurrent = (step.key === 'result') ? 1 : Math.min(questionIndex, questionTotal);
    const progress = ((doneBefore + doneCurrent) / totalQuestions) * 100;
    safe('progressFill').style.width = `${Math.min(100, Math.max(0, progress))}%`;

    const root = safe('screen');
    if (step.key === 'housing') renderHousing(root);
    if (step.key === 'internet') renderInternet(root);
    if (step.key === 'mobile') renderMobile(root);
    if (step.key === 'security') renderSecurity(root);
    if (step.key === 'result') renderResult(root);

    const res = buildResult();
    safe('kpiWifi').textContent = scoreLabel(res.wifiScore);
    safe('kpiRep').textContent = String(res.rep);
    safe('kpiIntensity').textContent = res.intensity;
    const mp = OFFERS.mobileProfiles.find(p=>p.id===res.mobileProfile);
    safe('kpiMobile').textContent = mp ? mp.name : 'â€”';

    const tags = safe('tags');
    tags.innerHTML = '';
    tags.appendChild(badge(state.hasBox ? 'Open: OUI' : 'Open: NON'));
    if (state.wantsNewMobile != null) tags.appendChild(badge(state.wantsNewMobile ? 'Projet mobile: OUI' : 'Projet mobile: NON'));
    if (state.selectedHandsetId) {
      const h = selectedHandset();
      if (h) tags.appendChild(badge(`Mobile: ${h.brand} ${h.name}`));
    }
    if (state.housing.surface) tags.appendChild(badge(`${state.housing.surface} mÂ²`));
    if (state.housing.type) tags.appendChild(badge(state.housing.type === 'maison' ? 'Maison' : 'Appartement'));
    if (state.housing.floors != null) tags.appendChild(badge(`${state.housing.floors} Ã©tage(s)`));
    if (state.housing.walls) tags.appendChild(badge(state.housing.walls === 'beton' ? 'Murs bÃ©ton/pierre' : 'Murs placo'));
    state.internetUsage.forEach(u=>tags.appendChild(badge(`Internet: ${labelInternet(u)}`)));
    state.mobileContext.forEach(c=>tags.appendChild(badge(`Mobile: ${labelMobile(c)}`)));
    state.security.forEach(s=>tags.appendChild(badge(`SÃ©curitÃ©: ${labelSec(s)}`)));

    const feedback = safe('clientFeedback');
    const ai = buildLiveInsights();
    feedback.innerHTML = (state.mode === 'vendeur')
      ? `
        <span>ðŸ“¶ Wiâ€‘Fi : <b>${scoreLabel(res.wifiScore)}</b></span>
        <span>ðŸ“¡ RÃ©pÃ©teurs : <b>${res.rep}</b></span>
        <span>âš¡ï¸ Internet : <b>${res.intensity}</b></span>
        <span>ðŸ“± Mobile : <b>${mp ? mp.name : 'â€”'}</b></span>
        ${ai.implicit[0] ? `<span>ðŸ§  Besoin dÃ©tectÃ© : <b>${escapeHtml(ai.implicit[0].need)}</b></span>` : ''}
      `
      : `
        <span>âœ… Parcours simple : une question Ã  la fois</span>
        <span>ðŸŽ¯ Recommandation finale adaptÃ©e Ã  votre besoin</span>
      `;

    const aiBox = safe('aiInsights');
    aiBox.innerHTML = `
      <div class="big">IA live</div>
      <div class="muted">Besoins exprimÃ©s</div>
      ${ai.explicit.length ? `<ul>${ai.explicit.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>` : `<div class="muted">Pas assez de donnÃ©es.</div>`}
      <div class="sp"></div>
      <div class="muted">Besoins non exprimÃ©s (probables)</div>
      ${ai.implicit.length ? `<ul>${ai.implicit.map(x=>`<li>${escapeHtml(x.need)} <b>(${escapeHtml(x.confidence)})</b></li>`).join('')}</ul>` : `<div class="muted">Aucun signal fort pour l'instant.</div>`}
      <div class="sp"></div>
      <div class="muted">Potentiel premium mobile: <b>${ai.premiumPotential === 'high' ? 'Ã©levÃ©' : (ai.premiumPotential === 'medium' ? 'moyen' : 'faible')}</b></div>
      ${ai.questionsToAsk.length ? `<div class="sp"></div><div class="muted">Questions Ã  poser</div><ul>${ai.questionsToAsk.map(q=>`<li>${escapeHtml(q)}</li>`).join('')}</ul>` : ''}
    `;

    // Sidebar cachÃ©e en mode client
    const side = safe('sidePanel');
    side.style.display = (state.mode === 'vendeur') ? 'grid' : 'none';
    const grid = document.querySelector('.grid');
    if (grid) grid.classList.toggle('client-mode', state.mode === 'client');

    // Debug uniquement vendeur
    const dbg = safe('stateDebug');
    if (state.mode === 'vendeur') {
      dbg.style.display = 'block';
      dbg.textContent = `state: ${JSON.stringify(state)}`;
    } else {
      dbg.style.display = 'none';
      dbg.textContent = '';
    }

    // Share utile surtout en vendeur, mais pas grave si cachÃ© avec sidebar
    renderShare();

    // Update mode buttons (top + sidebar)
    updateModeUI();
  }

  // ---------------------------
  // Init
  // ---------------------------
  function init(){
    state = loadFromURL() || loadLocal() || deepClone(DEFAULT_STATE);
    state = normalizeState(state);

    // Buttons sidebar
    safe('btnReset').onclick = () => { state = deepClone(DEFAULT_STATE); persist(); render(); };
    safe('btnPrint').onclick = () => window.print();
    safe('btnModeClient').onclick = () => setMode('client');
    safe('btnModeVendeur').onclick = () => setMode('vendeur');

    // Buttons TOP (fix qui te dÃ©bloque)
    safe('btnModeClientTop').onclick = () => setMode('client');
    safe('btnModeVendeurTop').onclick = () => setMode('vendeur');

    render();
  }

  window.addEventListener('DOMContentLoaded', () => {
    try { init(); }
    catch (e) {
      console.error(e);
      alert('Erreur JS : ' + (e?.message || e));
    }
  });
</script>
</body>
</html>
